<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oferta Especial - RatixPay</title>
    <link rel="icon" type="image/png" href="/assets/images/icons/favicon-32x32.png">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #F64C00;
            --secondary-color: #E67E22;
            --success-color: #28a745;
            --text-color: #333;
            --text-light: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Container principal - minimalista e vertical */
        .upsell-page {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            padding: 40px 30px;
        }

        /* 1Ô∏è‚É£ Headline */
        .headline {
            text-align: center;
            margin-bottom: 20px;
        }

        .headline h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1.2;
            margin-bottom: 15px;
        }

        /* 2Ô∏è‚É£ Subheadline */
        .subheadline {
            text-align: center;
            margin-bottom: 40px;
        }

        .subheadline p {
            font-size: 1.3rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* 3Ô∏è‚É£ M√≥dulo de M√≠dia */
        .media-module {
            margin: 40px 0;
            text-align: center;
        }

        .media-module img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .media-module .video-container-protected {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .media-module .video-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .media-module .video-container-protected iframe,
        .media-module .video-container-protected video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            pointer-events: none; /* Prevenir intera√ß√£o direta */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .media-module .video-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: auto;
            cursor: default;
            background: transparent;
        }

        /* Overlay de prote√ß√£o adicional */
        .video-protection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            background: transparent;
            cursor: default;
        }

        /* Ocultar controles nativos do v√≠deo */
        .media-module video::-webkit-media-controls {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-enclosure {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-panel {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-play-button {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-timeline {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-current-time-display {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-time-remaining-display {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-mute-button {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-volume-slider {
            display: none !important;
        }

        .media-module video::-webkit-media-controls-fullscreen-button {
            display: none !important;
        }

        /* 4Ô∏è‚É£ Se√ß√£o de Benef√≠cios */
        .benefits-section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .benefits-section h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .benefits-list {
            list-style: none;
            padding: 0;
        }

        .benefits-list li {
            padding: 15px 0;
            font-size: 1.1rem;
            color: var(--text-color);
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .benefits-list li:last-child {
            border-bottom: none;
        }

        .benefits-list li i {
            color: var(--success-color);
            font-size: 1.3rem;
            margin-top: 2px;
            flex-shrink: 0;
        }

        /* 5Ô∏è‚É£ Pre√ßo e desconto */
        .pricing-section {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(246, 76, 0, 0.05) 0%, rgba(230, 126, 34, 0.05) 100%);
            border-radius: 12px;
            border: 2px solid var(--primary-color);
        }

        .pricing-text {
            font-size: 1.2rem;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .price-container {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .price-original {
            font-size: 1.8rem;
            color: #999;
            text-decoration: line-through;
            font-weight: 400;
        }

        .price-offer {
            font-size: 3rem;
            font-weight: 900;
            color: var(--success-color);
        }

        .price-discount {
            background: var(--success-color);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .pricing-note {
            font-size: 1rem;
            color: var(--text-light);
            margin-top: 15px;
            font-style: italic;
        }

        /* 6Ô∏è‚É£ Urg√™ncia */
        .urgency-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 8px;
        }
        
        /* 6.5Ô∏è‚É£ Order Bumps (Produtos Complementares) - Melhorado */
        .order-bumps-section {
            margin: 40px 0;
            padding: 35px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 16px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .order-bumps-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, #ff8c42 100%);
        }
        
        .order-bumps-container {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        
        .order-bump-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 14px;
            padding: 22px;
            display: flex;
            align-items: flex-start;
            gap: 18px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .order-bump-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(246, 76, 0, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .order-bump-item:hover::before {
            left: 100%;
        }
        
        .order-bump-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 6px 20px rgba(246, 76, 0, 0.2);
            transform: translateY(-3px);
        }
        
        .order-bump-item.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(246, 76, 0, 0.08) 0%, rgba(230, 126, 34, 0.08) 100%);
            box-shadow: 0 6px 25px rgba(246, 76, 0, 0.25);
            transform: translateY(-2px);
        }
        
        .order-bump-item.selected::after {
            content: '‚úì Selecionado';
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #ff8c42 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(246, 76, 0, 0.3);
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .order-bump-checkbox {
            width: 26px;
            height: 26px;
            min-width: 26px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary-color);
            transform: scale(1);
            transition: transform 0.2s ease;
        }
        
        .order-bump-item:hover .order-bump-checkbox {
            transform: scale(1.1);
        }
        
        .order-bump-content {
            flex: 1;
            display: flex;
            gap: 18px;
            align-items: flex-start;
        }
        
        .order-bump-image {
            width: 90px;
            height: 90px;
            min-width: 90px;
            border-radius: 10px;
            object-fit: cover;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .order-bump-item:hover .order-bump-image {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .order-bump-item.selected .order-bump-image {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(246, 76, 0, 0.2);
        }
        
        .order-bump-details {
            flex: 1;
        }
        
        .order-bump-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
            line-height: 1.3;
            transition: color 0.2s ease;
        }
        
        .order-bump-item:hover .order-bump-title {
            color: var(--primary-color);
        }
        
        .order-bump-description {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .order-bump-price {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .order-bump-price-original {
            font-size: 0.95rem;
            color: #999;
            text-decoration: line-through;
            font-weight: 500;
        }
        
        .order-bump-price-final {
            font-size: 1.35rem;
            font-weight: 800;
            color: var(--success-color);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .order-bump-discount {
            background: linear-gradient(135deg, var(--success-color) 0%, #22c55e 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .order-bumps-total {
            margin-top: 25px;
            padding: 18px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 2px 10px rgba(246, 76, 0, 0.1);
            animation: fadeInUp 0.4s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .order-bumps-section {
                padding: 25px 20px;
            }
            
            .order-bump-item {
                flex-direction: column;
                padding: 18px;
            }
            
            .order-bump-item.selected::after {
                position: static;
                margin-top: 10px;
                display: inline-block;
            }
            
            .order-bump-content {
                flex-direction: column;
                width: 100%;
            }
            
            .order-bump-image {
                width: 100%;
                height: 200px;
                min-width: 100%;
            }
            
            .order-bump-checkbox {
                position: absolute;
                top: 18px;
                right: 18px;
                z-index: 2;
            }
        }

        .urgency-section p {
            font-size: 1.2rem;
            color: #856404;
            font-weight: 600;
            margin: 0;
        }

        .timer {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-top: 10px;
        }

        /* 7Ô∏è‚É£ Bot√£o Principal (ACEITAR) */
        .cta-primary {
            margin: 40px 0 20px 0;
            text-align: center;
        }

        .btn-accept {
            width: 100%;
            max-width: 500px;
            padding: 25px 50px;
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(246, 76, 0, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 0 auto;
        }

        .btn-accept:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(246, 76, 0, 0.5);
        }

        .btn-accept:active:not(:disabled) {
            transform: translateY(-1px) scale(1);
        }

        .btn-accept:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-accept.loading {
            pointer-events: none;
        }

        /* 8Ô∏è‚É£ Bot√£o Secund√°rio (RECUSAR) */
        .cta-secondary {
            text-align: center;
            margin: 20px 0 40px 0;
        }

        .btn-reject {
            background: transparent;
            border: none;
            color: var(--text-light);
            font-size: 0.95rem;
            cursor: pointer;
            text-decoration: underline;
            padding: 10px;
            transition: color 0.3s ease;
        }

        .btn-reject:hover {
            color: var(--primary-color);
        }

        /* 9Ô∏è‚É£ Prova Social */
        .social-proof {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .social-proof h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .testimonials {
            list-style: none;
            padding: 0;
        }

        .testimonial {
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .testimonial-text {
            font-style: italic;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .testimonial-author {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        /* üîü Refor√ßo Final */
        .reinforcement {
            text-align: center;
            margin: 40px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(246, 76, 0, 0.08) 0%, rgba(230, 126, 34, 0.08) 100%);
            border-radius: 12px;
        }

        .reinforcement p {
            font-size: 1.1rem;
            color: var(--text-color);
            font-weight: 500;
            line-height: 1.8;
        }

        /* Estados de loading e erro */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            text-align: center;
            padding: 60px 20px;
            color: #dc3545;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .upsell-page {
                padding: 20px 15px;
            }

            .headline h1 {
                font-size: 2rem;
            }

            .subheadline p {
                font-size: 1.1rem;
            }

            .price-offer {
                font-size: 2.5rem;
            }

            .btn-accept {
                font-size: 1.3rem;
                padding: 20px 40px;
            }
        }
    </style>
</head>
<body>
    <div class="upsell-page">
        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>Carregando oferta especial...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h3>Erro ao carregar oferta</h3>
            <p>Voc√™ ser√° redirecionado em instantes...</p>
        </div>

        <!-- Content State -->
        <div id="contentState" style="display: none;">
            <!-- 1Ô∏è‚É£ Headline -->
            <div class="headline">
                <h1 id="headlineText">Espere! Oferta especial antes de voc√™ finalizar.</h1>
            </div>

            <!-- 2Ô∏è‚É£ Subheadline -->
            <div class="subheadline">
                <p id="subheadlineText">Voc√™ pode adicionar este produto ao seu pedido com condi√ß√µes especiais.</p>
            </div>

            <!-- 3Ô∏è‚É£ M√≥dulo de M√≠dia -->
            <div class="media-module" id="mediaModule" style="display: none;">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>

            <!-- 4Ô∏è‚É£ Se√ß√£o de Benef√≠cios -->
            <div class="benefits-section" id="benefitsSection" style="display: none;">
                <h2>O que voc√™ vai receber:</h2>
                <ul class="benefits-list" id="benefitsList">
                        <!-- Ser√° preenchido dinamicamente -->
                </ul>
                    </div>

            <!-- 5Ô∏è‚É£ Pre√ßo e desconto -->
            <div class="pricing-section" id="pricingSection" style="display: none;">
                <div class="pricing-text" id="pricingText">De <span id="priceOriginalText"></span> por apenas</div>
                <div class="price-container">
                    <span class="price-offer" id="priceOfferText"></span>
                    <span class="price-discount" id="priceDiscountText" style="display: none;"></span>
                </div>
                <div class="pricing-note" id="pricingNote">(oferta exclusiva para agora)</div>
                </div>

            <!-- 6Ô∏è‚É£ Urg√™ncia -->
            <div class="urgency-section" id="urgencySection" style="display: none;">
                <p id="urgencyText">Oferta dispon√≠vel somente nesta p√°gina.</p>
                <div class="timer" id="timer" style="display: none;"></div>
                </div>

            <!-- 6.5Ô∏è‚É£ Order Bumps (Produtos Complementares) -->
            <div class="order-bumps-section" id="orderBumpsSection" style="display: none;">
                <h3 style="text-align: center; color: var(--primary-color); font-size: 1.6rem; margin-bottom: 12px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-gift" style="font-size: 1.8rem; background: linear-gradient(135deg, var(--primary-color) 0%, #ff8c42 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i> 
                    <span>Aproveite e leve junto</span>
                </h3>
                <p style="text-align: center; color: var(--text-light); margin-bottom: 30px; font-size: 1rem; line-height: 1.6;">
                    <i class="fas fa-check-circle" style="color: var(--success-color); margin-right: 6px;"></i>
                    Produtos selecionados ser√£o adicionados ao seu pedido com desconto especial
                </p>
                <div id="orderBumpsContainer" class="order-bumps-container">
                    <!-- Produtos complementares ser√£o inseridos aqui -->
                </div>
                <div id="orderBumpsTotal" class="order-bumps-total" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 10px;">
                        <span style="font-weight: 700; color: var(--text-color); font-size: 1.05rem; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-shopping-cart" style="color: var(--primary-color);"></i>
                            Total dos complementares:
                        </span>
                        <span id="orderBumpsTotalValue" style="font-size: 1.5rem; font-weight: 800; color: var(--primary-color); text-shadow: 0 1px 2px rgba(246, 76, 0, 0.1);">MZN 0,00</span>
                    </div>
                </div>
            </div>

            <!-- 7Ô∏è‚É£ Bot√£o Principal (ACEITAR) -->
            <div class="cta-primary">
                <button class="btn-accept" id="btnAccept">
                    <i class="fas fa-check-circle"></i>
                    <span id="btnAcceptText">Aceitar Oferta</span>
                    </button>
                <div id="clienteInfo" style="display: none; margin-top: 15px; text-align: center; font-size: 0.9rem; color: #666;">
                    <p><i class="fas fa-user"></i> <span id="clienteNome"></span></p>
                    <p><i class="fas fa-phone"></i> <span id="clienteTelefone"></span></p>
                    <p><strong><i class="fas fa-tag"></i> Valor: <span id="produtoValor"></span></strong></p>
                </div>
            </div>

            <!-- 8Ô∏è‚É£ Bot√£o Secund√°rio (RECUSAR) -->
            <div class="cta-secondary">
                <button class="btn-reject" id="btnReject">
                    N√£o, obrigado. Quero continuar sem esta oferta.
                    </button>
                </div>

            <!-- 9Ô∏è‚É£ Prova Social -->
            <div class="social-proof" id="socialProof" style="display: none;">
                <h3>O que nossos clientes dizem:</h3>
                <ul class="testimonials" id="testimonialsList">
                    <!-- Ser√° preenchido dinamicamente -->
                </ul>
            </div>

            <!-- üîü Refor√ßo Final -->
            <div class="reinforcement" id="reinforcement" style="display: none;">
                <p id="reinforcementText">Esta √© sua √∫nica chance de garantir esse upgrade com condi√ß√µes especiais.</p>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o
        const API_BASE = window.location.origin + '/api';
        
        // Obter par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const pageId = urlParams.get('id');
        const pedido = urlParams.get('pedido') || urlParams.get('idpedido');
        const productId = urlParams.get('productId') || urlParams.get('produto');
        const clientName = urlParams.get('clientName') || 'Cliente';
        const amount = urlParams.get('amount') || urlParams.get('valor') || '0';

        let upsellPage = null;
        let selectedProduct = null;
        let paymentToken = null; // Token do m√©todo de pagamento do checkout anterior
        let orderBumpProducts = []; // Produtos complementares dispon√≠veis
        let selectedOrderBumpProducts = []; // Produtos complementares selecionados
        window.selectedOrderBumpProducts = selectedOrderBumpProducts; // Disponibilizar globalmente

        // Fun√ß√£o para redirecionar para payment-success
        function redirectToSuccess() {
            const params = `pedido=${pedido}&productId=${productId}&clientName=${encodeURIComponent(clientName)}&amount=${amount}`;
            window.location.href = `/payment-success.html?${params}`;
        }

        // Fun√ß√£o para carregar p√°gina de upsell
        async function loadUpsellPage() {
            try {
                // Se tiver pageId, usar diretamente
                if (pageId) {
                    const response = await fetch(`${API_BASE}/upsell/pages/public/${pageId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.page) {
                            upsellPage = data.page;
                            // Carregar produtos do vendedor
                            await loadVendedorProdutos(upsellPage.vendedor_id);
                            showContent(upsellPage);
                            
                            // Carregar produtos complementares (Order Bumps)
                            await loadOrderBumpProducts();
                return;
            }
                    }
                }

                // Se n√£o tiver pageId, buscar pelo productId
                if (!productId) {
                    console.log('‚ö†Ô∏è ProductId n√£o encontrado, redirecionando...');
                    setTimeout(redirectToSuccess, 1000);
                    return;
                }

                const response = await fetch(`${API_BASE}/upsell/produto/${productId}`);

                if (!response.ok) {
                    throw new Error('Erro ao buscar p√°gina de upsell');
                }

                const data = await response.json();

                if (!data.success || !data.hasUpsell || !data.page) {
                    console.log('‚ÑπÔ∏è Nenhuma p√°gina de upsell encontrada para este produto');
                    setTimeout(redirectToSuccess, 1000);
                    return;
                }

                upsellPage = data.page;
                console.log('üì¶ P√°gina de upsell carregada:', upsellPage);
                console.log('üì¶ Produtos relacionados:', upsellPage.produtos_relacionados);
                console.log('üì¶ Quantidade de produtos:', upsellPage.produtos_relacionados?.length || 0);
                
                // Carregar produtos do vendedor
                await loadVendedorProdutos(upsellPage.vendedor_id);
                showContent(upsellPage);
                
                // Carregar produtos complementares (Order Bumps)
                await loadOrderBumpProducts();

            } catch (error) {
                console.error('‚ùå Erro ao carregar upsell:', error);
                setTimeout(redirectToSuccess, 1000);
            }
        }

        // Fun√ß√£o para carregar produtos do vendedor
        async function loadVendedorProdutos(vendedorId) {
            try {
                // Buscar produtos relacionados da p√°gina de upsell primeiro
                if (upsellPage && upsellPage.produtos_relacionados && upsellPage.produtos_relacionados.length > 0) {
                    // Se j√° tem produtos relacionados, usar eles
                    return;
                }

                // Se n√£o tem produtos relacionados, buscar todos os produtos do vendedor
                // Nota: Esta rota requer autentica√ß√£o, ent√£o vamos usar os produtos j√° relacionados
                // ou buscar via API p√∫blica se dispon√≠vel
                console.log('‚ÑπÔ∏è Produtos relacionados j√° carregados da p√°gina de upsell');
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos do vendedor:', error);
            }
        }
        
        // Fun√ß√£o para carregar produtos complementares (Order Bumps)
        async function loadOrderBumpProducts() {
            try {
                if (!productId) {
                    console.warn('‚ö†Ô∏è ProductId n√£o encontrado para buscar order bumps');
                    return;
                }
                
                // Buscar produtos complementares da API
                const response = await fetch(`${API_BASE}/pagamento/order-bump/${productId}`);
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Falha ao buscar Order Bumps:', response.status);
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success || !data.produtos_complementares || data.produtos_complementares.length === 0) {
                    console.log('‚ÑπÔ∏è Nenhum produto complementar encontrado');
                    return;
                }
                
                // Limitar a 3 produtos
                orderBumpProducts = data.produtos_complementares.slice(0, 3);
                
                // Renderizar produtos complementares
                renderOrderBumpProducts();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos complementares:', error);
            }
        }
        
        // Fun√ß√£o para renderizar produtos complementares
        function renderOrderBumpProducts() {
            if (orderBumpProducts.length === 0) {
                return;
            }
            
            const container = document.getElementById('orderBumpsContainer');
            const section = document.getElementById('orderBumpsSection');
            
            if (!container || !section) {
                return;
            }
            
            container.innerHTML = '';
            
            orderBumpProducts.forEach((produto, index) => {
                const precoFinal = produto.preco_com_desconto || produto.preco || 0;
                const precoOriginal = produto.preco || 0;
                const desconto = produto.desconto || 0;
                const temDesconto = desconto > 0 && precoFinal < precoOriginal;
                
                // Construir URL da imagem
                let imageUrl = produto.imagem_url || produto.imagem || '';
                if (imageUrl && !imageUrl.startsWith('http')) {
                    imageUrl = `${API_BASE}/produtos/imagem/${produto.id}`;
                }
                
                const item = document.createElement('div');
                item.className = 'order-bump-item';
                item.dataset.productId = produto.id;
                
                item.innerHTML = `
                    <input type="checkbox" 
                           class="order-bump-checkbox" 
                           id="orderBump_${produto.id}"
                           data-product-id="${produto.id}"
                           data-price="${precoFinal}">
                    <div class="order-bump-content">
                        ${imageUrl ? `
                            <img src="${imageUrl}" 
                                 alt="${produto.nome || 'Produto'}" 
                                 class="order-bump-image"
                                 onerror="this.style.display='none'">
                        ` : `
                            <div class="order-bump-image" style="display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                                <i class="fas fa-image" style="font-size: 2rem;"></i>
                            </div>
                        `}
                        <div class="order-bump-details">
                            <div class="order-bump-title">${produto.nome || 'Produto Complementar'}</div>
                            ${produto.descricao ? `
                                <div class="order-bump-description">${produto.descricao.substring(0, 120)}${produto.descricao.length > 120 ? '...' : ''}</div>
                            ` : ''}
                            <div class="order-bump-price">
                                ${temDesconto ? `
                                    <span class="order-bump-price-original">MZN ${parseFloat(precoOriginal).toFixed(2)}</span>
                                ` : ''}
                                <span class="order-bump-price-final">MZN ${parseFloat(precoFinal).toFixed(2)}</span>
                                ${temDesconto ? `
                                    <span class="order-bump-discount">-${desconto}% OFF</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Adicionar evento de clique no item inteiro
                item.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('.order-bump-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            toggleOrderBump(produto, checkbox.checked);
                        }
                    }
                });
                
                // Adicionar evento de mudan√ßa no checkbox
                const checkbox = item.querySelector('.order-bump-checkbox');
                if (checkbox) {
                    checkbox.addEventListener('change', (e) => {
                        toggleOrderBump(produto, e.target.checked);
                    });
                }
                
                container.appendChild(item);
            });
            
            // Mostrar se√ß√£o
            section.style.display = 'block';
        }
        
        // Fun√ß√£o para alternar sele√ß√£o de produto complementar
        function toggleOrderBump(produto, isSelected) {
            const item = document.querySelector(`[data-product-id="${produto.id}"]`).closest('.order-bump-item');
            
            if (isSelected) {
                // Verificar se j√° atingiu o limite de 3
                if (selectedOrderBumpProducts.length >= 3) {
                    alert('Voc√™ pode selecionar no m√°ximo 3 produtos complementares.');
                    item.querySelector('.order-bump-checkbox').checked = false;
                    item.classList.remove('selected');
                    return;
                }
                
                // Adicionar √† lista de selecionados
                if (!selectedOrderBumpProducts.find(p => p.id === produto.id)) {
                    selectedOrderBumpProducts.push({
                        id: produto.id,
                        public_id: produto.public_id,
                        custom_id: produto.custom_id,
                        nome: produto.nome,
                        preco: produto.preco,
                        preco_com_desconto: produto.preco_com_desconto || produto.preco,
                        desconto: produto.desconto || 0,
                        imagem_url: produto.imagem_url || produto.imagem,
                        link_conteudo: produto.link_conteudo || produto.linkConteudo,
                        descricao: produto.descricao,
                        tipo: produto.tipo || 'digital',
                        vendedor_id: produto.vendedor_id
                    });
                    item.classList.add('selected');
                }
            } else {
                // Remover da lista de selecionados
                selectedOrderBumpProducts = selectedOrderBumpProducts.filter(p => p.id !== produto.id);
                item.classList.remove('selected');
            }
            
            // Atualizar lista global
            window.selectedOrderBumpProducts = selectedOrderBumpProducts;
            
            // Atualizar total
            updateOrderBumpsTotal();
        }
        
        // Fun√ß√£o para atualizar total dos produtos complementares
        function updateOrderBumpsTotal() {
            const totalEl = document.getElementById('orderBumpsTotal');
            const totalValueEl = document.getElementById('orderBumpsTotalValue');
            
            if (!totalEl || !totalValueEl) {
                return;
            }
            
            if (selectedOrderBumpProducts.length === 0) {
                totalEl.style.display = 'none';
                updateButtonTotal();
                return;
            }
            
            const total = selectedOrderBumpProducts.reduce((sum, produto) => {
                const preco = parseFloat(produto.preco_com_desconto || produto.preco || 0);
                return sum + preco;
            }, 0);
            
            totalValueEl.textContent = `MZN ${total.toFixed(2)}`;
            totalEl.style.display = 'block';
            
            // Atualizar bot√£o com valor total incluindo complementares
            updateButtonTotal();
        }
        
        // Fun√ß√£o para atualizar texto do bot√£o com valor total
        function updateButtonTotal() {
            const btnAcceptText = document.getElementById('btnAcceptText');
            if (!btnAcceptText) {
                return;
            }
            
            // Verificar se h√° texto customizado do template
            const page = upsellPage;
            if (page && page.texto_botao_aceitar) {
                return; // N√£o atualizar se houver texto customizado
            }
            
            // Calcular valor total
            let valorTotal = 0;
            
            // Valor do produto upsell
            if (selectedProduct && selectedProduct.preco) {
                valorTotal = parseFloat(selectedProduct.preco);
            } else if (page && page.preco) {
                valorTotal = parseFloat(page.preco);
            }
            
            // Adicionar valor dos produtos complementares
            if (selectedOrderBumpProducts && selectedOrderBumpProducts.length > 0) {
                const valorComplementares = selectedOrderBumpProducts.reduce((sum, produto) => {
                    return sum + parseFloat(produto.preco_com_desconto || produto.preco || 0);
                }, 0);
                valorTotal += valorComplementares;
            }
            
            if (valorTotal > 0) {
                const valorFormatado = valorTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'});
                btnAcceptText.innerHTML = `Pagar ${valorFormatado} Agora`;
            }
        }

        // Fun√ß√£o para mostrar conte√∫do
        async function showContent(page) {
            // Verificar se h√° template personalizado
            if (page.template_id && page.template_id !== 'default') {
                try {
                    await renderizarTemplate(page);
                    return;
                } catch (error) {
                    console.error('Erro ao renderizar template:', error);
                    // Continuar com renderiza√ß√£o padr√£o se falhar
                }
            }
            
            // Renderiza√ß√£o padr√£o (comportamento original)
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';

            // Declarar produtos uma √∫nica vez no in√≠cio
            // Garantir que produtos_relacionados seja sempre um array
            let produtos = page.produtos_relacionados || [];
            
            // Se for um objeto √∫nico, converter para array
            if (produtos && !Array.isArray(produtos)) {
                console.warn('‚ö†Ô∏è produtos_relacionados √© um objeto, convertendo para array');
                produtos = [produtos];
            }
            
            console.log('üîç Produtos na fun√ß√£o showContent:', produtos);
            console.log('üîç Tipo:', Array.isArray(produtos) ? 'array' : typeof produtos);
            console.log('üîç Quantidade de produtos:', produtos.length);
            
            if (produtos.length === 0) {
                console.error('‚ùå Nenhum produto relacionado encontrado na p√°gina de upsell');
                console.error('‚ùå Estrutura da p√°gina:', page);
            }

            // 1Ô∏è‚É£ Headline - usar t√≠tulo da p√°gina (configur√°vel) ou padr√£o
            const headlineText = page.titulo || 'Espere! Oferta especial antes de voc√™ finalizar.';
            document.getElementById('headlineText').textContent = headlineText;

            // 2Ô∏è‚É£ Subheadline - usar nome do produto selecionado diretamente
            let nomeProdutoUpsell = '';
            
            if (produtos.length > 0) {
                nomeProdutoUpsell = produtos[0].nome;
            }
            
            const subheadlineText = page.subheadline || 
                (nomeProdutoUpsell
                    ? `Voc√™ pode adicionar "${nomeProdutoUpsell}" ao seu pedido com condi√ß√µes especiais.`
                    : 'Voc√™ pode adicionar este produto ao seu pedido com condi√ß√µes especiais.');
            document.getElementById('subheadlineText').textContent = subheadlineText;

            // 3Ô∏è‚É£ M√≥dulo de M√≠dia (v√≠deo, imagem ou nenhum) - SEM AUTOPLAY
            const mediaModule = document.getElementById('mediaModule');
            if (page.video_embed) {
                // V√≠deo embed - SEM autoplay, usu√°rio clica para iniciar
                let embedCode = page.video_embed;
                // SEM autoplay
                embedCode = embedCode.replace(/youtube\.com\/embed\/([^"?&]+)([^"]*)?/, 'youtube.com/embed/$1?controls=0&disablekb=1&enablejsapi=1&rel=0&playsinline=1&origin=' + encodeURIComponent(window.location.origin));
                embedCode = embedCode.replace(/vimeo\.com\/video\/(\d+)([^"]*)?/, 'vimeo.com/video/$1?controls=0&playsinline=1');
                embedCode = embedCode.replace(/<iframe/gi, '<iframe allow="autoplay; encrypted-media; fullscreen" style="pointer-events: none;"');
                
                mediaModule.innerHTML = `
                    <div class="video-container-protected" style="user-select: none;">
                        <div class="video-wrapper" style="pointer-events: none;">
                            ${embedCode}
                        </div>
                    </div>
                `;
                mediaModule.style.display = 'block';
                
                // Proteger v√≠deo embed
                setTimeout(() => {
                    protectEmbedVideo();
                }, 500);
            } else if (page.video_url) {
                // V√≠deo direto - SEM autoplay, bot√£o ser√° adicionado
                mediaModule.innerHTML = `
                    <div class="video-container-protected" style="user-select: none;">
                        <video id="upsellVideo" playsinline preload="auto" style="width: 100%; height: 100%; pointer-events: none;">
                        <source src="${page.video_url}" type="video/mp4">
                        Seu navegador n√£o suporta v√≠deo.
                    </video>
                    </div>
                `;
                mediaModule.style.display = 'block';
                
                // Configurar prote√ß√£o e bot√£o de play
                setTimeout(() => {
                    protectVideo();
                }, 500);
            } else if (page.imagem_url) {
                // Imagem configurada diretamente na p√°gina
                const altText = produtos.length > 0 ? produtos[0].nome : (page.nome_produto || 'Produto');
                mediaModule.innerHTML = `<img src="${page.imagem_url}" alt="${altText}">`;
                mediaModule.style.display = 'block';
            } else {
                // Verificar se h√° imagem nos produtos relacionados
                if (produtos.length > 0 && produtos[0].imagem_url) {
                    mediaModule.innerHTML = `<img src="${produtos[0].imagem_url}" alt="${produtos[0].nome}">`;
                    mediaModule.style.display = 'block';
                }
                // Se n√£o houver m√≠dia, n√£o exibir o m√≥dulo
            }

            // 4Ô∏è‚É£ Se√ß√£o de Benef√≠cios - usar benef√≠cios configur√°veis ou padr√£o
            // Usar produtos relacionados (produtos do vendedor selecionados para upsell)
            if (produtos.length > 0) {
                // Selecionar primeiro produto automaticamente
                selectedProduct = produtos[0];
                console.log('‚úÖ Produto selecionado automaticamente:', selectedProduct);
                console.log('‚úÖ Estrutura completa do produto:', JSON.stringify(selectedProduct, null, 2));
                console.log('‚úÖ ID do produto (id):', selectedProduct.id);
                console.log('‚úÖ ID do produto (produto_id):', selectedProduct.produto_id);
                console.log('‚úÖ Nome do produto:', selectedProduct.nome);
                console.log('‚úÖ Pre√ßo do produto:', selectedProduct.preco);
                
                // Habilitar bot√£o se tiver pedido e produto
                const btnAccept = document.getElementById('btnAccept');
                if (btnAccept && pedido && selectedProduct) {
                    btnAccept.disabled = false;
                    console.log('‚úÖ Bot√£o de aceitar habilitado - Pedido:', pedido, 'Produto ID:', selectedProduct.id || selectedProduct.produto_id);
            } else {
                    console.warn('‚ö†Ô∏è Bot√£o n√£o habilitado - Pedido:', pedido, 'Produto:', selectedProduct);
                    if (!pedido) console.error('‚ùå Pedido n√£o encontrado');
                    if (!selectedProduct) console.error('‚ùå Produto n√£o selecionado');
                }
                
                // Atualizar debug info
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    document.getElementById('debugPedido').textContent = pedido || 'N√ÉO ENCONTRADO';
                    document.getElementById('debugProduto').textContent = (selectedProduct.id || selectedProduct.produto_id || 'N√ÉO ENCONTRADO') + ' - ' + (selectedProduct.nome || 'Sem nome');
                    document.getElementById('debugProdutosCount').textContent = produtos.length;
                }
                
                const benefitsList = document.getElementById('benefitsList');
                let benefits = [];
                
                // Usar benef√≠cios configur√°veis se dispon√≠veis
                if (page.beneficios && Array.isArray(page.beneficios)) {
                    benefits = page.beneficios;
                } else if (page.beneficios && typeof page.beneficios === 'string') {
                    // Se for string JSON, fazer parse
                    try {
                        benefits = JSON.parse(page.beneficios);
                    } catch (e) {
                        benefits = [];
                    }
                }
                
                // Se n√£o houver benef√≠cios configurados, usar padr√£o
                if (benefits.length === 0) {
                    benefits = [
                        `Acesso imediato a ${produtos[0].nome}`,
                        'Garantia de 7 dias ou seu dinheiro de volta',
                        'Suporte especializado 24/7',
                        'Material atualizado constantemente'
                    ];
                }

                benefitsList.innerHTML = benefits.map(benefit => `
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>${typeof benefit === 'string' ? benefit : (benefit.texto || benefit)}</span>
                    </li>
                `).join('');

                document.getElementById('benefitsSection').style.display = 'block';

                // 5Ô∏è‚É£ Pre√ßo e desconto
                if (produtos[0].preco) {
                    const preco = parseFloat(produtos[0].preco);
                    const precoFormatado = preco.toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'});
                    
                    // Usar pre√ßo original configurado ou calcular
                    const precoOriginal = page.preco_original 
                        ? parseFloat(page.preco_original).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'})
                        : (preco * 1.5).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'});
                    
                    // Calcular desconto se houver pre√ßo original
                    let desconto = null;
                    if (page.preco_original && parseFloat(page.preco_original) > preco) {
                        const percentualDesconto = Math.round(((parseFloat(page.preco_original) - preco) / parseFloat(page.preco_original)) * 100);
                        desconto = `${percentualDesconto}% OFF`;
                    }

                    document.getElementById('priceOriginalText').textContent = precoOriginal;
                    document.getElementById('priceOfferText').textContent = precoFormatado;
                    
                    if (desconto) {
                        document.getElementById('priceDiscountText').textContent = desconto;
                        document.getElementById('priceDiscountText').style.display = 'inline-block';
                    }
                    
                    document.getElementById('pricingSection').style.display = 'block';
                }
            }

            // 6Ô∏è‚É£ Urg√™ncia - usar texto configur√°vel ou padr√£o
            const urgencyText = page.texto_urgencia || 'Oferta dispon√≠vel somente nesta p√°gina. Esta √© sua √∫nica chance de garantir esse upgrade.';
            document.getElementById('urgencyText').textContent = urgencyText;
            document.getElementById('urgencySection').style.display = 'block';

            // 7Ô∏è‚É£ Texto dos bot√µes - usar textos configur√°veis
            const btnAcceptText = page.texto_botao_aceitar || 'Aceitar Oferta';
            document.getElementById('btnAcceptText').textContent = btnAcceptText;
            
            const btnRejectText = page.texto_botao_recusar || 'N√£o, obrigado. Quero continuar sem esta oferta.';
            document.getElementById('btnReject').textContent = btnRejectText;

            // 9Ô∏è‚É£ Prova Social (opcional - configur√°vel)
            if (page.prova_social) {
                let testimonials = [];
                
                if (Array.isArray(page.prova_social)) {
                    testimonials = page.prova_social;
                } else if (typeof page.prova_social === 'string') {
                    try {
                        testimonials = JSON.parse(page.prova_social);
                    } catch (e) {
                        testimonials = [];
                    }
                }
                
                if (testimonials.length > 0) {
                    const testimonialsList = document.getElementById('testimonialsList');
                    testimonialsList.innerHTML = testimonials.map(testimonial => {
                        const texto = typeof testimonial === 'string' ? testimonial : (testimonial.texto || testimonial.text || '');
                        const autor = typeof testimonial === 'object' ? (testimonial.autor || testimonial.author || 'Cliente') : 'Cliente';
                        
                        return `
                            <li class="testimonial">
                                <div class="testimonial-text">"${texto}"</div>
                                <div class="testimonial-author">‚Äî ${autor}</div>
                            </li>
                        `;
                    }).join('');
                    
                    document.getElementById('socialProof').style.display = 'block';
                }
            }

            // üîü Refor√ßo Final - usar texto configur√°vel ou padr√£o
            const reinforcementText = page.reforco_final || 'Esta √© sua √∫nica chance de garantir esse upgrade com condi√ß√µes especiais. N√£o perca esta oportunidade!';
            document.getElementById('reinforcementText').textContent = reinforcementText;
            document.getElementById('reinforcement').style.display = 'block';

            // Bot√£o sempre habilitado - o cliente pode pagar a qualquer momento
            const btnAccept = document.getElementById('btnAccept');
            if (btnAccept) {
                        btnAccept.disabled = false;
                console.log('‚úÖ Bot√£o de aceitar sempre habilitado');
                
                // Atualizar texto do bot√£o com valor do produto (incluindo complementares se houver)
                updateButtonTotal();
            }
            
            // Exibir informa√ß√µes do cliente e produto
            if (selectedProduct && window.clienteInfo) {
                exibirInfoClienteProduto({ cliente: window.clienteInfo }, selectedProduct);
            }
            
            // Configurar prote√ß√£o de v√≠deo se houver
            const temVideo = page.video_url || page.video_embed;
            if (temVideo) {
                setTimeout(() => {
                    const video = document.getElementById('upsellVideo');
                    const iframe = document.querySelector('.video-wrapper iframe');
                    
                    if (video) {
                        protectVideo();
                        console.log('üé• V√≠deo protegido com autoplay e sem controles');
                    } else if (iframe) {
                        protectEmbedVideo();
                        console.log('üé• V√≠deo embed protegido');
                    }
                }, 500);
            }
        }
        
        // Fun√ß√£o para configurar listeners de v√≠deo embed (YouTube/Vimeo)
        function configurarVideoEmbedListeners(iframe) {
            if (!iframe) return;
            
            console.log('üé• Configurando listener para v√≠deo embed');
            
            // Para YouTube
            if (iframe.src.includes('youtube.com') || iframe.src.includes('youtu.be')) {
                // Usar postMessage API do YouTube
                const youtubeMessageHandler = (event) => {
                    if (event.origin !== 'https://www.youtube.com' && event.origin !== 'https://www.youtube-nocookie.com') return;
                    
                    try {
                        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                        
                        // YouTube Player API v3
                        if (data && data.event === 'onStateChange') {
                            // 0 = terminado, 1 = reproduzindo, 2 = pausado
                            if (data.info === 0) {
                                console.log('‚úÖ V√≠deo YouTube terminou - habilitando bot√£o e fazendo scroll');
                                window.removeEventListener('message', youtubeMessageHandler);
                                scrollParaBotao();
                            }
                        }
                        
                        // YouTube IFrame API
                        if (data && data.event === 'video-progress') {
                            // Verificar se chegou ao final (99% ou mais)
                            if (data.info && data.info.percent >= 99) {
                                console.log('‚úÖ V√≠deo YouTube pr√≥ximo do fim - habilitando bot√£o e fazendo scroll');
                                window.removeEventListener('message', youtubeMessageHandler);
                                scrollParaBotao();
                            }
                        }
                    } catch (e) {
                        // Ignorar erros de parsing
                    }
                };
                
                window.addEventListener('message', youtubeMessageHandler);
                
                // Fallback: verificar periodicamente se o iframe mudou (indicando v√≠deo terminado)
                let lastSrc = iframe.src;
                const checkInterval = setInterval(() => {
                    if (iframe.src !== lastSrc) {
                        console.log('‚úÖ V√≠deo YouTube mudou (possivelmente terminou) - habilitando bot√£o');
                        clearInterval(checkInterval);
                        window.removeEventListener('message', youtubeMessageHandler);
                        scrollParaBotao();
                    }
                }, 2000);
                
                // Limpar ap√≥s 10 minutos (v√≠deo muito longo)
                setTimeout(() => {
                    clearInterval(checkInterval);
                    window.removeEventListener('message', youtubeMessageHandler);
                }, 600000);
            }
            
            // Para Vimeo
            if (iframe.src.includes('vimeo.com')) {
                // Tentar usar Vimeo Player API se dispon√≠vel
                if (typeof Vimeo !== 'undefined' && Vimeo.Player) {
                    try {
                        const player = new Vimeo.Player(iframe);
                        player.on('ended', () => {
                            console.log('‚úÖ V√≠deo Vimeo terminou - habilitando bot√£o e fazendo scroll');
                            scrollParaBotao();
                        });
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao inicializar Vimeo Player:', e);
                        // Fallback: habilitar ap√≥s tempo estimado
                        setTimeout(() => {
                            scrollParaBotao();
                        }, 300000); // 5 minutos como fallback
                    }
                } else {
                    // Fallback: habilitar ap√≥s tempo estimado
                    console.log('‚ö†Ô∏è Vimeo Player API n√£o dispon√≠vel, usando fallback de tempo');
                    setTimeout(() => {
                        scrollParaBotao();
                    }, 300000); // 5 minutos como fallback
                }
            }
        }
        
        // Fun√ß√£o para fazer scroll para o bot√£o quando o v√≠deo terminar
        function scrollParaBotao() {
            const pricingSection = document.getElementById('pricingSection');
            const ctaPrimary = document.querySelector('.cta-primary');
            
            // Fazer scroll suave para a se√ß√£o de pre√ßo e bot√£o
            setTimeout(() => {
                const targetElement = ctaPrimary || pricingSection;
                if (targetElement) {
                    const elementTop = targetElement.getBoundingClientRect().top + window.pageYOffset;
                    const offset = 100;
                    
                    window.scrollTo({
                        top: elementTop - offset,
                        behavior: 'smooth'
                    });
                    console.log('üìú Scroll autom√°tico para se√ß√£o de CTA');
                }
            }, 500);
        }

        // Fun√ß√£o para processar one-click upsell
        async function processOneClickUpsell() {
            console.log('üîç Validando dados para processar pagamento...');
            console.log('üîç Pedido:', pedido);
            console.log('üîç Selected Product:', selectedProduct);
            console.log('üîç Upsell Page:', upsellPage);
            
            if (!pedido) {
                console.error('‚ùå Pedido n√£o encontrado na URL');
                mostrarToast('Erro: Pedido n√£o encontrado. Redirecionando...', 'error');
                setTimeout(redirectToSuccess, 2000);
                return;
            }
            
            if (!selectedProduct) {
                console.error('‚ùå Produto n√£o selecionado');
                mostrarToast('Erro: Nenhum produto foi selecionado. Por favor, selecione um produto.', 'error');
                return;
            }

            const btnAccept = document.getElementById('btnAccept');
            const btnAcceptText = document.getElementById('btnAcceptText');
            
            // Desabilitar bot√£o e mostrar loading
            btnAccept.disabled = true;
            btnAccept.classList.add('loading');
            btnAcceptText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Digite o PIN e receba o produto';

            try {
                // Buscar informa√ß√µes do pedido original
                const pedidoResponse = await fetch(`${API_BASE}/upsell/pedido/${pedido}`);
                
                if (!pedidoResponse.ok) {
                    throw new Error('Erro ao buscar informa√ß√µes do pedido');
                }

                const pedidoData = await pedidoResponse.json();
                
                if (!pedidoData.success || !pedidoData.pedido) {
                    throw new Error('Pedido n√£o encontrado');
                }

                const pedidoInfo = pedidoData.pedido;
                console.log('üì¶ Dados do pedido recebidos:', pedidoInfo);
                console.log('üì¶ M√©todo de pagamento:', pedidoInfo.pagamento?.metodo || pedidoInfo.metodo_pagamento || pedidoInfo.pagamento_metodo);
                
                // Validar dados do cliente
                if (!pedidoInfo.cliente || !pedidoInfo.cliente.telefone) {
                    console.error('‚ùå Telefone do cliente n√£o encontrado:', pedidoInfo);
                    throw new Error('Telefone do cliente n√£o encontrado no pedido original');
                }

                const metodoPagamento = pedidoInfo.pagamento?.metodo || pedidoInfo.metodo_pagamento || pedidoInfo.pagamento_metodo;
                if (!metodoPagamento) {
                    console.error('‚ùå M√©todo de pagamento n√£o encontrado:', pedidoInfo);
                    throw new Error('M√©todo de pagamento n√£o encontrado no pedido original');
                }
                
                console.log('‚úÖ M√©todo de pagamento encontrado:', metodoPagamento);

                // Validar produto selecionado
                const produtoId = selectedProduct.id || selectedProduct.produto_id;
                console.log('üîç Produto selecionado:', selectedProduct);
                console.log('üîç ID do produto extra√≠do:', produtoId);
                
                if (!produtoId) {
                    console.error('‚ùå Produto selecionado n√£o tem ID:', selectedProduct);
                    throw new Error('ID do produto n√£o encontrado');
                }

                const valorProduto = parseFloat(selectedProduct.preco || 0);
                if (!valorProduto || valorProduto <= 0) {
                    throw new Error('Valor do produto inv√°lido');
                }

                btnAcceptText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Digite o PIN e receba o produto';
                
                // Processar pagamento do upsell via PayMoz
                const upsellResponse = await fetch(`${API_BASE}/upsell/processar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pedido_id: pedido,
                        produto_id: produtoId,
                        valor: valorProduto
                    })
                });

                const upsellResult = await upsellResponse.json();

                if (upsellResult.success) {
                    if (upsellResult.status === 'approved') {
                        // Pagamento aprovado imediatamente
                        mostrarToast('Pagamento processado com sucesso!', 'success');
                        setTimeout(() => {
                            redirectToSuccess();
                        }, 1500);
                    } else {
                        // Pagamento pendente - aguardar confirma√ß√£o
                        mostrarToast('Pagamento enviado! Digite o PIN no seu celular para confirmar.', 'info');
                        btnAcceptText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Digite o PIN e receba o produto';
                        
                        // Verificar status do pagamento periodicamente
                        verificarStatusPagamento(upsellResult.transaction_id, 0);
                    }
                } else {
                    throw new Error(upsellResult.message || 'Erro ao processar pagamento');
                }

            } catch (error) {
                console.error('‚ùå Erro ao processar one-click upsell:', error);
                
                // Mostrar mensagem de oportunidade perdida
                mostrarToast('Voc√™ est√° perdendo a maior oportunidade e melhor desconto!', 'warning');
                
                // Reabilitar bot√£o com mensagem de "Pagar Novamente"
                btnAccept.disabled = false;
                btnAccept.classList.remove('loading');
                btnAcceptText.innerHTML = '<i class="fas fa-redo"></i> Pagar Novamente';
                
                // Adicionar evento de clique para tentar novamente
                btnAccept.onclick = processOneClickUpsell;
            }
        }

        // Fun√ß√£o para verificar status do pagamento
        async function verificarStatusPagamento(transactionId, tentativas) {
            const maxTentativas = 30; // 30 tentativas = ~2 minutos (4s por tentativa)
            
            if (tentativas >= maxTentativas) {
                mostrarToast('Tempo de espera esgotado. Verifique o status do pagamento na p√°gina de sucesso.', 'warning');
                setTimeout(() => {
                    redirectToSuccess();
                }, 2000);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/pagamento/status/${transactionId}`);
                const data = await response.json();

                if (!data.success) {
                    // Se n√£o encontrou, pode ser que ainda n√£o foi criado - continuar verificando
                    setTimeout(() => {
                        verificarStatusPagamento(transactionId, tentativas + 1);
                    }, 4000);
                    return;
                }

                // Verificar status da venda
                const statusVenda = data.data?.venda?.status || data.data?.status || 'Pendente';
                const statusPagamento = data.data?.pagamento?.status || statusVenda;

                // Mapear status para valores conhecidos
                const statusAprovado = ['Pago', 'Aprovado', 'approved', 'success', 'completed'];
                const statusFalhou = ['Cancelado', 'Cancelada', 'Falha', 'failed', 'rejected', 'declined', 'cancelled'];

                if (statusAprovado.includes(statusPagamento) || statusAprovado.includes(statusVenda)) {
                    mostrarToast('Pagamento confirmado com sucesso!', 'success');
                    setTimeout(() => {
                        redirectToSuccess();
                    }, 1500);
                } else if (statusFalhou.includes(statusPagamento) || statusFalhou.includes(statusVenda)) {
                    mostrarToast('Voc√™ est√° perdendo a maior oportunidade e melhor desconto!', 'warning');
                    const btnAccept = document.getElementById('btnAccept');
                    const btnAcceptText = document.getElementById('btnAcceptText');
                    btnAccept.disabled = false;
                    btnAccept.classList.remove('loading');
                    btnAcceptText.innerHTML = '<i class="fas fa-redo"></i> Pagar Novamente';
                    // Adicionar evento de clique para tentar novamente
                    btnAccept.onclick = processOneClickUpsell;
                } else {
                    // Ainda pendente - verificar novamente em 4 segundos
                    setTimeout(() => {
                        verificarStatusPagamento(transactionId, tentativas + 1);
                    }, 4000);
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar status:', error);
                // Continuar verificando mesmo com erro
                setTimeout(() => {
                    verificarStatusPagamento(transactionId, tentativas + 1);
                }, 4000);
            }
        }

        // Fun√ß√£o para mostrar toast
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${tipo === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = mensagem;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Fun√ß√£o para proteger v√≠deo com canvas overlay - VERS√ÉO MELHORADA
        function protectVideo() {
            const video = document.getElementById('upsellVideo');
            const canvas = document.getElementById('videoCanvas');
            const container = video?.closest('.video-container-protected');
            
            if (!video || !canvas) return;

            // Configurar canvas
            canvas.width = video.offsetWidth;
            canvas.height = video.offsetHeight;
            const ctx = canvas.getContext('2d');

            // Adicionar overlay de prote√ß√£o extra
            if (container && !container.querySelector('.video-protection-overlay')) {
                const overlay = document.createElement('div');
                overlay.className = 'video-protection-overlay';
                container.appendChild(overlay);
                
                // Prevenir todas as intera√ß√µes no overlay
                overlay.addEventListener('contextmenu', e => e.preventDefault());
                overlay.addEventListener('mousedown', e => e.preventDefault());
                overlay.addEventListener('dblclick', e => e.preventDefault());
                overlay.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
            }

            // Desabilitar controles de contexto (bot√£o direito) em todos os elementos
            [canvas, video, container].forEach(el => {
                if (el) {
                    el.addEventListener('contextmenu', e => {
                e.preventDefault();
                        e.stopPropagation();
                return false;
                    });
                }
            });

            // Prevenir download e intera√ß√£o direta
            canvas.addEventListener('mousedown', e => {
                e.preventDefault();
                return false;
            });

            // Desabilitar teclas de controle em toda a p√°gina
            document.addEventListener('keydown', (e) => {
                const videoContainer = document.querySelector('.video-container-protected');
                if (videoContainer) {
                    // Bloquear teclas de controle de m√≠dia
                    if (['Space', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'KeyK', 'KeyJ', 'KeyL', 'KeyM', 'KeyF'].includes(e.code)) {
                    e.preventDefault();
                        e.stopPropagation();
                    return false;
                }
                }
            });

            // Configura√ß√µes do v√≠deo para prote√ß√£o m√°xima - SEM AUTOPLAY
            video.autoplay = false;
            video.pause();
            video.currentTime = 0;
            video.muted = false; // Som ativado
            video.volume = 1.0;
            video.playsInline = true;
            video.loop = false;
            video.controls = false;

            try {
                video.controlsList = 'nodownload nofullscreen noremoteplayback';
                video.disablePictureInPicture = true;
                video.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback');
                video.setAttribute('disablePictureInPicture', 'true');
            } catch(e) {}

            // Vari√°vel para armazenar o tempo m√°ximo assistido
            let maxTimeWatched = 0;

            // Atualizar tempo m√°ximo assistido
            video.addEventListener('timeupdate', () => {
                if (video.currentTime > maxTimeWatched) {
                    maxTimeWatched = video.currentTime;
                }
            });

            // Prevenir retrocesso e avan√ßo - PROTE√á√ÉO RIGOROSA
            video.addEventListener('seeking', () => {
                // S√≥ permitir ir para frente at√© o m√°ximo assistido + 2 segundos
                if (video.currentTime > maxTimeWatched + 2) {
                    video.currentTime = maxTimeWatched;
                    console.log('‚ö†Ô∏è Avan√ßo bloqueado - voltando para:', maxTimeWatched);
                }
                // Bloquear retrocesso al√©m de 2 segundos
                if (video.currentTime < maxTimeWatched - 2 && maxTimeWatched > 2) {
                    video.currentTime = maxTimeWatched - 2;
                    console.log('‚ö†Ô∏è Retrocesso bloqueado - mantendo em:', video.currentTime);
                }
            });

            // Prevenir pausa
            video.addEventListener('pause', () => {
                if (!video.ended) {
                    setTimeout(() => {
                        video.play().catch(() => {});
                    }, 100);
                }
            });

            // Prevenir clique para pausar
            video.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (video.paused && !video.ended) {
                    video.play();
                }
            });

            // Desenhar overlay transparente no canvas
            function drawOverlay() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.01)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Redesenhar quando o v√≠deo redimensionar
            const resizeObserver = new ResizeObserver(() => {
                canvas.width = video.offsetWidth;
                canvas.height = video.offsetHeight;
                drawOverlay();
            });

            resizeObserver.observe(video);
            drawOverlay();

            // Listener para quando o v√≠deo terminar
            video.addEventListener('ended', () => {
                console.log('‚úÖ V√≠deo terminou');
            });
            
            // Pausar e resetar v√≠deo
            video.pause();
            video.currentTime = 0;
            
            // Criar overlay clic√°vel para iniciar
            criarOverlayVideo(video);
            
            console.log('üé• V√≠deo configurado - aguardando clique do usu√°rio para iniciar');
        }

        // Fun√ß√£o para mostrar bot√£o de ativar som
        // Fun√ß√£o para criar overlay clic√°vel sobre o v√≠deo
        function criarOverlayVideo(video) {
            const container = video.closest('.video-container-protected');
            if (!container) return;
            
            // N√£o criar se j√° existe
            if (container.querySelector('.video-start-overlay')) return;
            
            // Adicionar CSS
            if (!document.getElementById('video-overlay-style')) {
                const style = document.createElement('style');
                style.id = 'video-overlay-style';
                style.textContent = `
                    @keyframes pulse-icon { 
                        0%, 100% { transform: translate(-50%, -50%) scale(1); } 
                        50% { transform: translate(-50%, -50%) scale(1.1); } 
                    }
                    .video-start-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        z-index: 100;
                        transition: background 0.3s;
                    }
                    .video-start-overlay:hover {
                        background: rgba(0, 0, 0, 0.3);
                    }
                    .video-start-overlay .play-icon {
                        width: 100px;
                        height: 100px;
                        background: linear-gradient(135deg, #f97316, #ea580c);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 10px 40px rgba(249, 115, 22, 0.6);
                        animation: pulse-icon 2s infinite;
                    }
                    .video-start-overlay .play-icon::after {
                        content: '';
                        width: 0;
                        height: 0;
                        border-left: 30px solid white;
                        border-top: 18px solid transparent;
                        border-bottom: 18px solid transparent;
                        margin-left: 8px;
                    }
                    .video-start-overlay .play-text {
                        position: absolute;
                        bottom: 30%;
                        left: 50%;
                        transform: translateX(-50%);
                        color: white;
                        font-size: 18px;
                        font-weight: 700;
                        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
                    }
                    .video-protection-layer {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 50;
                        background: transparent;
                        cursor: default;
                    }
                `;
                document.head.appendChild(style);
            }

            // Criar overlay clic√°vel
            const overlay = document.createElement('div');
            overlay.className = 'video-start-overlay';
            overlay.innerHTML = `
                <div class="play-icon"></div>
                <span class="play-text">CLIQUE PARA ASSISTIR</span>
            `;
            
            // Bloquear menu de contexto
            overlay.oncontextmenu = (e) => { e.preventDefault(); return false; };

            // Fun√ß√£o para iniciar v√≠deo
            const iniciarVideo = () => {
                console.log('üé• Usu√°rio clicou para iniciar v√≠deo');
                
                // Tentar com som primeiro
                video.muted = false;
                video.volume = 1.0;
                
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('‚úÖ V√≠deo iniciado COM SOM');
                        // Remover overlay de in√≠cio e adicionar camada de prote√ß√£o
                        overlay.remove();
                        adicionarCamadaProtecao(container, video);
                    }).catch((err) => {
                        console.log('‚ö†Ô∏è Play com som bloqueado, tentando mudo:', err.message);
                        
                        // Fallback: iniciar mudo
                    video.muted = true;
                        video.play().then(() => {
                            console.log('‚úÖ V√≠deo iniciado MUDO');
                            // Mudar overlay para bot√£o de ativar som
                            overlay.innerHTML = `
                                <div class="play-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                                    <span style="font-size: 40px; color: white; margin-left: 0;">üîä</span>
                                </div>
                                <span class="play-text">CLIQUE PARA ATIVAR O SOM</span>
                            `;
                            overlay.style.background = 'rgba(0, 0, 0, 0.2)';
                            
                            overlay.onclick = () => {
                                video.muted = false;
                                video.volume = 1.0;
                                overlay.remove();
                                adicionarCamadaProtecao(container, video);
                                console.log('‚úÖ Som ativado');
                            };
                        }).catch((e) => {
                            console.log('‚ùå Falha total ao iniciar v√≠deo:', e.message);
                        });
                    });
                }
            };

            overlay.onclick = iniciarVideo;
            container.appendChild(overlay);
        }
        
        // Adicionar camada de prote√ß√£o ap√≥s v√≠deo iniciar
        function adicionarCamadaProtecao(container, video) {
            if (container.querySelector('.video-protection-layer')) return;
            
            const protection = document.createElement('div');
            protection.className = 'video-protection-layer';
            protection.oncontextmenu = (e) => { e.preventDefault(); return false; };
            
            // Bloquear qualquer intera√ß√£o
            protection.onclick = (e) => e.stopPropagation();
            protection.onmousedown = (e) => e.preventDefault();
            
            container.appendChild(protection);
        }

        // Fun√ß√£o para proteger v√≠deo embed (iframe) - VERS√ÉO MELHORADA
        function protectEmbedVideo() {
            const canvas = document.getElementById('videoCanvas');
            const videoWrapper = document.querySelector('.video-wrapper');
            const container = document.querySelector('.video-container-protected');
            
            if (!canvas || !videoWrapper) return;

            const iframe = videoWrapper.querySelector('iframe');
            if (!iframe) return;
            
            // Adicionar overlay de prote√ß√£o extra
            if (container && !container.querySelector('.video-protection-overlay')) {
                const overlay = document.createElement('div');
                overlay.className = 'video-protection-overlay';
                container.appendChild(overlay);
                
                // Prevenir todas as intera√ß√µes no overlay
                overlay.addEventListener('contextmenu', e => e.preventDefault());
                overlay.addEventListener('mousedown', e => e.preventDefault());
                overlay.addEventListener('dblclick', e => e.preventDefault());
                overlay.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
            }

            // Configurar canvas
            canvas.width = iframe.offsetWidth;
            canvas.height = iframe.offsetHeight;
            const ctx = canvas.getContext('2d');

            // Desabilitar controles de contexto em todos os elementos
            [canvas, iframe, container, videoWrapper].forEach(el => {
                if (el) {
                    el.addEventListener('contextmenu', e => {
                e.preventDefault();
                        e.stopPropagation();
                return false;
                    });
                }
            });

            // Prevenir download e intera√ß√µes
            canvas.addEventListener('mousedown', e => {
                e.preventDefault();
                return false;
            });

            // Desenhar overlay transparente
            function drawOverlay() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.01)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Redesenhar quando redimensionar
            const resizeObserver = new ResizeObserver(() => {
                canvas.width = iframe.offsetWidth;
                canvas.height = iframe.offsetHeight;
                drawOverlay();
            });

            resizeObserver.observe(iframe);
            drawOverlay();

            // Tornar iframe n√£o clic√°vel diretamente
            iframe.style.pointerEvents = 'none';
            iframe.setAttribute('allow', 'autoplay; encrypted-media');
            iframe.setAttribute('allowfullscreen', 'false');

            // Bloquear teclas de controle
            document.addEventListener('keydown', (e) => {
                if (['Space', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'KeyK', 'KeyJ', 'KeyL', 'KeyM', 'KeyF'].includes(e.code)) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });

            console.log('‚úÖ V√≠deo embed protegido com overlay e canvas');
        }

        // Fun√ß√£o para sanitizar template HTML - remove scripts conflitantes
        function sanitizarTemplateParaUpsell(html) {
            // Remover scripts inline usando regex (mais seguro que DOM parsing)
            // Mant√©m CDN externos mas remove scripts que declaram vari√°veis conflitantes
            
            // Remover scripts inline que cont√™m vari√°veis conflitantes
            html = html.replace(/<script(?![^>]*src=)[^>]*>[\s\S]*?<\/script>/gi, function(match) {
                // Verificar se cont√©m vari√°veis conflitantes
                if (match.includes('const API_BASE') || 
                    match.includes('let API_BASE') || 
                    match.includes('var API_BASE') ||
                    match.includes('const pedido') ||
                    match.includes('function triggerPurchase') ||
                    match.includes('function processOneClickUpsell')) {
                    console.log('üßπ Removendo script conflitante do template');
                    return ''; // Remover script conflitante
                }
                return match; // Manter outros scripts inline
            });
            
            return html;
        }
        
        // Fun√ß√£o para renderizar template personalizado - VERS√ÉO COMPLETA
        async function renderizarTemplate(page) {
            try {
                let templateHtml;
                
                // Se houver template_html salvo, usar ele (template modificado pelo usu√°rio)
                if (page.template_html) {
                    templateHtml = page.template_html;
                } else {
                    // Caso contr√°rio, carregar template original
                    const templateResponse = await fetch(`/templates/upsell/${page.template_id}.html`);
                    if (!templateResponse.ok) {
                        throw new Error(`Template ${page.template_id} n√£o encontrado`);
                    }
                    templateHtml = await templateResponse.text();
                }
                
                // Sanitizar template para remover scripts conflitantes
                templateHtml = sanitizarTemplateParaUpsell(templateHtml);
                
                // Preparar dados para substitui√ß√£o
                const produtos = page.produtos_relacionados || [];
                const primeiroProduto = produtos.length > 0 ? produtos[0] : null;
                
                // Armazenar produto e p√°gina globalmente ANTES de renderizar
                window.selectedProduct = primeiroProduto;
                window.upsellPage = page;
                window.pedidoId = pedido;
                window.API_BASE_URL = API_BASE;
                
                // Calcular pre√ßos
                const precoProduto = primeiroProduto?.preco ? parseFloat(primeiroProduto.preco) : 0;
                const precoFormatado = precoProduto.toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'});
                const precoOriginal = page.preco_original 
                    ? parseFloat(page.preco_original).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'})
                    : (precoProduto * 1.5).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'});
                
                // Gerar conte√∫do de m√≠dia (v√≠deo ou imagem)
                let videoContent = '';
                let imagemProduto = '';
                
                if (page.video_embed) {
                    let embedCode = page.video_embed;
                    embedCode = embedCode.replace(/youtube\.com\/embed\/([^"?&]+)([^"]*)?/, 'youtube.com/embed/$1?controls=0&disablekb=1&enablejsapi=1&rel=0&modestbranding=1&playsinline=1&origin=' + encodeURIComponent(window.location.origin));
                    embedCode = embedCode.replace(/vimeo\.com\/video\/(\d+)([^"]*)?/, 'vimeo.com/video/$1?controls=0&playsinline=1');
                    embedCode = embedCode.replace(/<iframe/gi, '<iframe allow="autoplay; encrypted-media; fullscreen" style="pointer-events: none;"');
                    
                    videoContent = `
                        <div class="video-container-protected" style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; overflow: hidden; border-radius: 12px; background: #000; user-select: none;">
                            <div class="video-wrapper" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                ${embedCode}
                            </div>
                        </div>
                    `;
                } else if (page.video_url) {
                    videoContent = `
                        <div class="video-container-protected" style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; overflow: hidden; border-radius: 12px; background: #000; user-select: none;">
                            <video id="upsellVideo" playsinline preload="auto" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; pointer-events: none;">
                                <source src="${page.video_url}" type="video/mp4">
                            </video>
                        </div>
                    `;
                }
                
                // Gerar imagem do produto (para templates que usam imagem)
                // Verificar se √© template master-pack
                const isMasterPackTemplate = page.template_id === 'master-pack' || templateHtml.includes('Upgrade Premium Master');
                
                if (primeiroProduto?.imagem_url) {
                    imagemProduto = `<img src="${primeiroProduto.imagem_url}" alt="${primeiroProduto.nome}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">`;
                } else if (page.imagem_url) {
                    imagemProduto = `<img src="${page.imagem_url}" alt="${page.titulo || 'Produto'}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">`;
                } else if (isMasterPackTemplate) {
                    // Imagem padr√£o do Master Pack (com √≠cone de estrela e anima√ß√£o)
                    imagemProduto = `
                        <div class="absolute inset-0 bg-emerald-500/10 blur-3xl rounded-full group-hover:bg-emerald-500/20 transition-all duration-700"></div>
                        <div class="relative z-10 text-center transform group-hover:scale-105 transition-transform duration-500">
                            <i class="ph-fill ph-star text-6xl md:text-8xl text-emerald-400 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(52,211,153,0.5)]"></i>
                            <span class="block text-xl font-bold tracking-widest text-slate-200 mt-2">MASTER PACK</span>
                        </div>
                    `;
                } else {
                    // Imagem padr√£o para outros templates
                    imagemProduto = `
                        <div style="position: relative; width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f97316, #ea580c); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(249, 115, 22, 0.4);">
                                <i class="fas fa-play" style="color: white; font-size: 28px; margin-left: 4px;"></i>
                                </div>
                            </div>
                    `;
                }
                
                // Gerar lista de benef√≠cios (com textos padr√£o prontos)
                const beneficiosPadrao = [
                    'Acesso vital√≠cio ao conte√∫do premium',
                    'Suporte priorit√°rio 24/7 via WhatsApp',
                    'Pack de b√≥nus exclusivos (Valor R$ 297)',
                    'Certificado de conclus√£o avan√ßado'
                ];
                
                let beneficios = '';
                
                if (primeiroProduto?.descricao && primeiroProduto.descricao.includes('\n')) {
                    // Se a descri√ß√£o tem quebras de linha, usar como benef√≠cios
                    const linhas = primeiroProduto.descricao.split('\n').filter(b => b.trim());
                    if (linhas.length > 0) {
                        beneficios = linhas.map(b => `
                            <li class="flex items-start gap-3 text-slate-300 text-sm" style="color: #cbd5e1 !important;">
                                <div class="mt-0.5 bg-emerald-500/20 p-1 rounded-full text-emerald-400 flex-shrink-0" style="background-color: rgba(16, 185, 129, 0.2) !important;">
                                    <i class="ph-bold ph-check" style="color: #34d399 !important;"></i>
                                </div>
                                <span style="color: #cbd5e1 !important;">${b.trim()}</span>
                            </li>
                        `).join('');
                    } else {
                        // Usar benef√≠cios padr√£o
                        beneficios = beneficiosPadrao.map(b => `
                            <li class="flex items-start gap-3 text-slate-300 text-sm">
                                <div class="mt-0.5 bg-emerald-500/20 p-1 rounded-full text-emerald-400 flex-shrink-0">
                                    <i class="ph-bold ph-check"></i>
                        </div>
                                <span>${b}</span>
                            </li>
                        `).join('');
                    }
                } else {
                    // Usar benef√≠cios padr√£o (textos prontos)
                    beneficios = beneficiosPadrao.map(b => `
                        <li class="flex items-start gap-3 text-slate-300 text-sm" style="color: #cbd5e1 !important;">
                            <div class="mt-0.5 bg-emerald-500/20 p-1 rounded-full text-emerald-400 flex-shrink-0" style="background-color: rgba(16, 185, 129, 0.2) !important;">
                                <i class="ph-bold ph-check" style="color: #34d399 !important;"></i>
                            </div>
                            <span style="color: #cbd5e1 !important;">${b}</span>
                        </li>
                    `).join('');
                }
                
                // Detectar qual template est√° sendo usado
                const isMasterPack = page.template_id === 'master-pack' || templateHtml.includes('master-pack') || templateHtml.includes('Upgrade Premium Master');
                const isMentoriaElite = page.template_id === 'mentoria-elite' || templateHtml.includes('mentoria-elite') || templateHtml.includes('Mentoria Elite');
                const isEmagrecimento = page.template_id === 'emagrecimento-definitivo' || templateHtml.includes('emagrecimento-definitivo') || templateHtml.includes('Emagrecimento Definitivo');
                const isPacoteMaestria = page.template_id === 'pacote-maestria' || templateHtml.includes('pacote-maestria') || templateHtml.includes('Pacote Maestria');
                const isPlataformaSaaS = page.template_id === 'plataforma-saas' || templateHtml.includes('plataforma-saas') || templateHtml.includes('Plataforma [NOME]') || templateHtml.includes('Sistemas Imbat√≠veis');
                const isBlackFridayIngles = page.template_id === 'black-friday-ingles' || templateHtml.includes('black-friday-ingles') || templateHtml.includes('Black Friday - Ingl√™s') || templateHtml.includes('Fale Ingl√™s com');
                const isGui√£oReceitas = page.template_id === 'gui√£o-receitas' || templateHtml.includes('gui√£o-receitas') || templateHtml.includes('O Gui√£o das Receitas') || templateHtml.includes('Cozinhe como um Chef');
                const isBioPureDetox = page.template_id === 'biopure-detox' || templateHtml.includes('biopure-detox') || templateHtml.includes('BioPure Detox') || templateHtml.includes('Mau H√°lito') || templateHtml.includes('BioPure');
                const isMetodoLiberdadeDigital = page.template_id === 'metodo-liberdade-digital' || templateHtml.includes('metodo-liberdade-digital') || templateHtml.includes('M√©todo Liberdade Digital') || templateHtml.includes('M√©todo Lucro Digital') || templateHtml.includes('M√°quina de Renda Di√°ria');
                const isFormulaMulherIrresistivel = page.template_id === 'formula-mulher-irresistivel' || templateHtml.includes('formula-mulher-irresistivel') || templateHtml.includes('A F√≥rmula da Mulher Irresist√≠vel') || templateHtml.includes('Mulher Irresist√≠vel') || templateHtml.includes('Torne-se Inesquec√≠vel');
                
                // Gerar benef√≠cios para template Mentoria Elite (formato grid de 3 colunas)
                let beneficiosMentoriaElite = '';
                if (isMentoriaElite) {
                    const beneficiosMentoria = [
                        { icon: 'ph-chart-line-up', title: 'Estrat√©gias Validadas', desc: 'S√≥ o que funciona em 2025.' },
                        { icon: 'ph-users-three', title: 'Suporte de Elite', desc: 'Acesso direto ao time de mentores.' },
                        { icon: 'ph-calendar-check', title: 'Resultados R√°pidos', desc: 'Plano de 7 dias para as primeiras vendas.' }
                    ];
                    
                    beneficiosMentoriaElite = beneficiosMentoria.map(b => `
                        <div class="p-4 rounded-xl bg-brand-subtle/50 border border-brand-subtle">
                            <i class="ph-fill ${b.icon} text-4xl text-brand-accent mb-2"></i>
                            <p class="font-bold text-lg">${b.title}</p>
                            <p class="text-sm text-gray-400">${b.desc}</p>
                        </div>
                    `).join('');
                }
                
                // Cards de resultados agora est√£o diretamente no template (n√£o precisam ser gerados dinamicamente)
                
                // Cards de depoimentos agora est√£o diretamente no template (n√£o precisam ser gerados dinamicamente)
                
                // Gerar lista de valores para template Pacote Maestria
                let listaValores = '';
                
                if (isPacoteMaestria) {
                    // Gerar lista de valores em MZN
                    listaValores = `
                        <div class="value-item">
                            <span class="value-label">
                                <i class="ph-fill ph-book-open-text"></i>
                                Valor Individual dos 10 eBooks
                            </span>
                            <span class="value-price">MZN 3.597,00</span>
                        </div>
                        <div class="value-item">
                            <span class="value-label">
                                <i class="ph-fill ph-infinity"></i>
                                Acesso Vital√≠cio e Atualiza√ß√µes
                            </span>
                            <span class="value-price">MZN 15.197,00</span>
                        </div>
                        <div class="value-item">
                            <span class="value-label value-label-final">
                                <i class="ph-fill ph-wallet"></i>
                                Pre√ßo do Pacote Completo HOJE:
                            </span>
                            <span class="value-price value-price-final">MZN 999,00</span>
                        </div>
                    `;
                }
                
                // Preparar mapeamento de vari√°veis (suporta todos os templates)
                const variaveis = {
                    // Vari√°veis comuns
                    '{{TITULO_PAGINA}}': page.titulo || (isMasterPack ? 'Oferta Especial - N√£o feche esta p√°gina' : (isMentoriaElite ? 'Mentoria Elite: Acelerador de Lucros Online' : 'Oferta Exclusiva - One Time Offer')),
                    '{{VIDEO_CONTENT}}': videoContent,
                    '{{IMAGEM_PRODUTO}}': imagemProduto,
                    '{{PRECO_ORIGINAL}}': precoOriginal,
                    '{{PRECO_OFERTA}}': precoFormatado,
                    
                    // Vari√°veis espec√≠ficas do Master Pack (com textos prontos)
                    '{{TEXTO_ALERTA}}': page.texto_alerta || (isMentoriaElite ? 'APENAS 27 VAGAS RESTANTES NA TURMA DE MENTORIA 2.0' : 'PEDIDO CONFIRMADO! N√ÉO FECHE ESTA P√ÅGINA AINDA.'),
                    '{{TITULO_PRODUTO}}': primeiroProduto?.nome || page.titulo_produto || 'Upgrade Premium Master',
                    '{{DESCRICAO_PRODUTO}}': primeiroProduto?.descricao?.split('\n')[0] || page.descricao_produto || 'Acelere os seus resultados em 3x com o nosso pacote avan√ßado de ferramentas e mentorias gravadas. Acesso imediato.',
                    '{{LISTA_BENEFICIOS}}': beneficios,
                    '{{DESCONTO_BADGE}}': page.desconto_badge || (isMentoriaElite ? '60% OFF EXCLUSIVO' : '-70% OFF'),
                    '{{TEXTO_AVALIACAO}}': page.texto_avaliacao || '(4.9/5 de 1.204 alunos)',
                    '{{TEXTO_PAGAMENTO}}': page.texto_pagamento || '/ pagamento √∫nico',
                    '{{TEXTO_BOTAO_ACEITAR}}': page.texto_botao_aceitar || (isMasterPack ? 'Sim! Adicionar ao meu pedido' : (isMentoriaElite ? 'QUERO LUCRAR ONLINE (GARANTIR MINHA VAGA)' : 'Sim, Adicionar ao Meu Pedido')),
                    '{{TEXTO_BOTAO_RECUSAR}}': page.texto_botao_recusar || (isMasterPack ? 'N√£o, obrigado. Eu prefiro recusar esta oferta √∫nica e pagar o pre√ßo normal depois.' : (isMentoriaElite ? 'N√£o, obrigado. Prefiro continuar tentando sozinho.' : 'N√£o, obrigado. Eu n√£o quero acelerar meus resultados.')),
                    
                    // Vari√°veis espec√≠ficas do template Mentoria Elite
                    '{{TEXTO_PRECO_LABEL}}': page.texto_preco_label || 'Valor de Mercado da Mentoria (12 meses):',
                    '{{TEXTO_GARANTIA}}': page.texto_garantia || 'Garanta Sua Vaga Agora e Receba 1 Ano de Acesso Ilimitado.',
                    '{{TEXTO_URGENCIA}}': page.texto_urgencia || '√öltima Chamada: A Mentoria Come√ßa na Pr√≥xima Segunda.',
                    '{{TEXTO_RECUSAR_SUBTITULO}}': page.texto_recusar_subtitulo || (isMentoriaElite ? 'Compreendo que perderei esta oportunidade de ser mentorado por especialistas.' : 'Compreendo que perderei este desconto para sempre.'),
                    '{{BENEFICIOS}}': beneficiosMentoriaElite || '',
                    
                    // Vari√°veis espec√≠ficas do template Emagrecimento Definitivo
                    '{{BADGE_TEXTO}}': page.badge_texto || (isEmagrecimento ? 'M√âTODO CIENTIFICAMENTE COMPROVADO' : (isMentoriaElite ? 'Mentoria Elite (Alto N√≠vel)' : 'Etapa 2 de 2: Oferta Especial')),
                    '{{TITULO_PRINCIPAL}}': page.titulo || (isEmagrecimento ? 'O Segredo que Desbloqueia <span class="title-highlight">20Kg de Perda</span> em Apenas 60 Dias' : (isMasterPack ? 'Espere! O seu pedido est√° <span class="text-emerald-400">90% completo...</span>' : (isMentoriaElite ? 'Como Faturar seus Primeiros <span class="text-brand-accent">R$ 10.000 Online</span>' : 'ESPERE! O seu pedido ainda n√£o est√° completo.'))),
                    '{{SUBTITULO}}': page.subheadline || (isEmagrecimento ? 'Assista a carta de vendas e descubra o sistema de **reprograma√ß√£o metab√≥lica** que a ind√∫stria n√£o quer que voc√™ conhe√ßa.' : (isMasterPack ? 'Adicione este complemento exclusivo ao seu pedido agora e poupe 70%. Esta oferta n√£o ser√° mostrada novamente.' : (isMentoriaElite ? 'Descubra a Estrat√©gia Secreta de Tr√°fego e Vendas que Gere R$ 10K/M√™s com Apenas 2 Horas de Trabalho por Dia.' : (primeiroProduto ? `Veja como duplicar os seus resultados por apenas alguns centavos extra.` : 'Veja como duplicar os seus resultados por apenas alguns centavos extra.')))),
                    '{{TEXTO_PRECO_INICIAL}}': page.texto_preco_inicial || (isEmagrecimento ? `Oferta Limitada: De <span class="price-strike">R$ 997,00</span> por apenas <span class="price-highlight">12x R$ 29,90</span>` : ''),
                    '{{TEXTO_BOTAO_INICIAL}}': page.texto_botao_inicial || (isEmagrecimento ? 'QUERO TRANSFORMAR MEU CORPO AGORA!' : ''),
                    '{{TITULO_RESULTADOS}}': page.titulo_resultados || (isEmagrecimento ? 'PROVAS REAIS: DEZENAS DE PESSOAS J√Å CONSEGUIRAM' : ''),
                    '{{TITULO_DEPOIMENTOS}}': page.titulo_depoimentos || (isEmagrecimento ? 'O Que Dizem Nossos Alunos...' : ''),
                    '{{TITULO_DEPOIMENTOS_SOCIAIS}}': page.titulo_depoimentos_sociais || (isEmagrecimento ? 'Transforma√ß√µes Reais de Pessoas Reais' : ''),
                    '{{TEXTO_ESCASSEZ}}': page.texto_escassez || (isEmagrecimento ? 'ESTA PROMO√á√ÉO TERMINA EM:' : ''),
                    '{{TEXTO_PRECO_FINAL}}': page.texto_preco_final || (isEmagrecimento ? `De <span class="price-strike">R$ 997,00</span> por <span class="scarcity-price-highlight">12x R$ 29,90</span>` : ''),
                    '{{TEXTO_BOTAO_FINAL}}': page.texto_botao_final || (isEmagrecimento ? 'SIM! EU QUERO MEU NOVO CORPO J√Å' : ''),
                    '{{TEXTO_FOOTER}}': page.texto_footer || (isEmagrecimento ? '¬© 2025 Emagrecimento Definitivo. Produto desenvolvido para resultados reais.' : (isPacoteMaestria ? '¬© 2025 Maestria Pessoal. Todos os direitos reservados. Material digital para download imediato.' : '')),
                    '{{LINKS_FOOTER}}': page.links_footer || (isEmagrecimento ? '<a href="#" style="color: #1F2937; font-weight: 600; text-decoration: none; transition: color 0.3s ease;">Garantia de 30 Dias</a> | <a href="#" style="color: #1F2937; font-weight: 600; text-decoration: none; transition: color 0.3s ease;">Pol√≠tica de Privacidade</a>' : (isPacoteMaestria ? '<a href="#" style="color: #1F2937; font-weight: 600; text-decoration: none; transition: color 0.3s ease;">Garantia de 7 Dias</a> | <a href="#" style="color: #1F2937; font-weight: 600; text-decoration: none; transition: color 0.3s ease;">Termos de Servi√ßo</a>' : '')),
                    
                    // Vari√°veis espec√≠ficas do template Pacote Maestria
                    '{{BADGE_TEXTO}}': page.badge_texto || (isPacoteMaestria ? 'A CHAVE PARA SUA M√ÅXIMA PERFORMANCE' : (isEmagrecimento ? 'M√âTODO CIENTIFICAMENTE COMPROVADO' : (isMentoriaElite ? 'Mentoria Elite (Alto N√≠vel)' : 'Etapa 2 de 2: Oferta Especial'))),
                    '{{TITULO_PRINCIPAL}}': page.titulo || (isPacoteMaestria ? 'O <span class="title-highlight">PACOTE MAESTRIA</span> que Transforma Seus H√°bitos' : (isEmagrecimento ? 'O Segredo que Desbloqueia <span class="title-highlight">20Kg de Perda</span> em Apenas 60 Dias' : (isMasterPack ? 'Espere! O seu pedido est√° <span class="text-emerald-400">90% completo...</span>' : (isMentoriaElite ? 'Como Faturar seus Primeiros <span class="text-brand-accent">R$ 10.000 Online</span>' : 'ESPERE! O seu pedido ainda n√£o est√° completo.')))),
                    '{{SUBTITULO}}': page.subheadline || (isPacoteMaestria ? 'Adquira a Cole√ß√£o Completa de 10 eBooks que destravam seu potencial, de produtividade a intelig√™ncia emocional.' : (isEmagrecimento ? 'Assista a carta de vendas e descubra o sistema de **reprograma√ß√£o metab√≥lica** que a ind√∫stria n√£o quer que voc√™ conhe√ßa.' : (isMasterPack ? 'Adicione este complemento exclusivo ao seu pedido agora e poupe 70%. Esta oferta n√£o ser√° mostrada novamente.' : (isMentoriaElite ? 'Descubra a Estrat√©gia Secreta de Tr√°fego e Vendas que Gere R$ 10K/M√™s com Apenas 2 Horas de Trabalho por Dia.' : (primeiroProduto ? `Veja como duplicar os seus resultados por apenas alguns centavos extra.` : 'Veja como duplicar os seus resultados por apenas alguns centavos extra.'))))),
                    '{{TITULO_VALOR}}': page.titulo_valor || (isPacoteMaestria ? 'O Valor Desta Cole√ß√£o' : ''),
                    '{{LISTA_VALORES}}': listaValores || '',
                    '{{TEXTO_ECONOMIA}}': page.texto_economia || (isPacoteMaestria ? 'Economia Imediata de mais de MZN 17.795,00.' : ''),
                    '{{TEXTO_BOTAO_PRINCIPAL}}': page.texto_botao_principal || (isPacoteMaestria ? 'BAIXAR O PACOTE COMPLETO POR MZN 999,00' : ''),
                    '{{TEXTO_BOTAO_STICKY}}': page.texto_botao_sticky || (isPacoteMaestria ? 'GARANTIR ACESSO IMEDIATO' : ''),
                    
                    // Vari√°veis do template VSL Laranja (mantidas para compatibilidade)
                    '{{TEXTO_OFERTA_UNICA}}': 'OFERTA √öNICA',
                    '{{TEXTO_PERGUNTA_PRODUTO}}': primeiroProduto ? `Adicionar "${primeiroProduto.nome}" ao pedido?` : 'Adicionar produto ao pedido?',
                    '{{TEXTO_SUBTITULO_BOTAO}}': 'N√£o √© necess√°rio inserir dados novamente',
                    '{{TEXTO_CONFIRMACAO_RECUSAR}}': `Tem a certeza? Esta oferta de ${precoFormatado} nunca mais aparecer√°.`
                };
                
                // Substituir vari√°veis se existirem
                if (templateHtml.includes('{{')) {
                    Object.keys(variaveis).forEach(variavel => {
                        templateHtml = templateHtml.replace(new RegExp(variavel.replace(/[{}]/g, '\\$&'), 'g'), variaveis[variavel]);
                    });
                }
                
                // Renderizar template no body
                    document.body.innerHTML = templateHtml;
                
                // Aplicar estilos for√ßados para Master Pack (garantir visibilidade)
                if (isMasterPack) {
                    // Aplicar imediatamente
                    aplicarEstilosMasterPack();
                
                    // Aplicar novamente ap√≥s um delay para garantir
                    setTimeout(() => {
                        aplicarEstilosMasterPack();
                    }, 100);
                
                    // Aplicar uma √∫ltima vez ap√≥s renderiza√ß√£o completa
                    setTimeout(() => {
                        aplicarEstilosMasterPack();
                    }, 500);
                }
                
                // Aplicar estilos e ajustar v√≠deo para Mentoria Elite
                if (isMentoriaElite) {
                setTimeout(() => {
                        aplicarEstilosMentoriaElite();
                        
                        // Ocultar placeholder se houver v√≠deo
                        if (videoContent) {
                            const placeholder = document.getElementById('video-placeholder');
                            if (placeholder) {
                                placeholder.style.display = 'none';
                            }
                            
                            // Garantir que o v√≠deo ocupe todo o espa√ßo do container
                            const videoWrapper = document.querySelector('.video-wrapper');
                            if (videoWrapper) {
                                const iframe = videoWrapper.querySelector('iframe');
                                const video = videoWrapper.querySelector('video');
                                if (iframe) {
                                    iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: none;';
                                }
                    if (video) {
                                    video.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; pointer-events: none; border: none;';
                                }
                            }
                        }
                    }, 100);
                    
                    // Aplicar novamente ap√≥s renderiza√ß√£o completa
                    setTimeout(() => {
                        aplicarEstilosMentoriaElite();
                }, 500);
                }
                
                // Aplicar valores dos atributos para template Emagrecimento (j√° que n√£o usa vari√°veis)
                if (isEmagrecimento && page.atributos) {
                    setTimeout(() => {
                        aplicarAtributosEmagrecimento(page);
                    }, 100);
                }
                
                // Aplicar imagens dos ebooks para template Pacote Maestria
                if (isPacoteMaestria && page.atributos) {
                    setTimeout(() => {
                        aplicarImagensEbooks(page);
                    }, 100);
                }
                
                // Aplicar atributos para template Plataforma SaaS
                if (isPlataformaSaaS && page.atributos) {
                    setTimeout(() => {
                        aplicarAtributosPlataformaSaaS(page);
                    }, 100);
                }
                
                // Aplicar atributos para template Black Friday Ingl√™s
                if (isBlackFridayIngles && page.atributos) {
                    setTimeout(() => {
                        aplicarAtributosBlackFridayIngles(page);
                    }, 100);
                }
                
                // Aplicar atributos para template Gui√£o das Receitas
                if (isGui√£oReceitas && page.atributos) {
                    setTimeout(() => {
                        aplicarAtributosGui√£oReceitas(page);
                    }, 100);
                }
                
                // Aplicar atributos para template BioPure Detox
                if (isBioPureDetox && page.atributos) {
                    setTimeout(() => {
                        aplicarAtributosBioPureDetox(page);
                    }, 100);
                }
                
                // Aplicar atributos para template M√©todo Liberdade Digital
                if (isMetodoLiberdadeDigital && page.atributos) {
                    setTimeout(() => {
                        aplicarAtributosMetodoLiberdadeDigital(page);
                    }, 100);
                }
                
                // Aplicar atributos para template A F√≥rmula da Mulher Irresist√≠vel
                if (isFormulaMulherIrresistivel && page.atributos) {
                    setTimeout(() => {
                        aplicarAtributosFormulaMulherIrresistivel(page);
                    }, 100);
                }
                
                // Injetar CSS de prote√ß√£o de v√≠deo
                injetarCSSProtecaoVideo();
                
                // Injetar script de pagamento e prote√ß√£o de v√≠deo
                injetarScriptPagamentoUniversal(page, primeiroProduto, precoProduto);
                
                // Ocultar elementos de loading se existirem
                document.getElementById('loadingState')?.remove();
                document.getElementById('errorState')?.remove();
                document.getElementById('contentState')?.remove();
                
                console.log('‚úÖ Template renderizado com sucesso:', page.template_id);
                console.log('‚úÖ Produto relacionado:', primeiroProduto?.nome || 'Nenhum');
                console.log('‚úÖ Valor:', precoFormatado);
                
            } catch (error) {
                console.error('‚ùå Erro ao renderizar template:', error);
                throw error;
            }
        }
        
        // Fun√ß√£o para aplicar estilos for√ßados no template Master Pack
        function aplicarEstilosMasterPack() {
            try {
                // Aplicar estilos no cabe√ßalho - Barra de alerta
                const alertBar = document.querySelector('[data-field="texto_alerta"]') || document.querySelector('.bg-emerald-600');
                if (alertBar) {
                    alertBar.style.setProperty('background-color', '#10b981', 'important');
                    alertBar.style.setProperty('color', '#ffffff', 'important');
                    alertBar.style.setProperty('font-weight', '600', 'important');
                    alertBar.style.setProperty('padding', '10px 16px', 'important');
                    
                    // Aplicar em todos os elementos filhos tamb√©m
                    const alertChildren = alertBar.querySelectorAll('*');
                    alertChildren.forEach(child => {
                        if (child.tagName !== 'I' && child.tagName !== 'SPAN') {
                            child.style.setProperty('color', '#ffffff', 'important');
                        }
                    });
                }
                
                // Aplicar estilos no badge do cabe√ßalho
                const badgeTexto = document.querySelector('[data-field="badge_texto"]');
                if (badgeTexto) {
                    badgeTexto.style.setProperty('color', '#34d399', 'important');
                    badgeTexto.style.setProperty('background-color', 'rgba(52, 211, 153, 0.15)', 'important');
                    badgeTexto.style.setProperty('border-color', 'rgba(52, 211, 153, 0.3)', 'important');
                    badgeTexto.style.setProperty('padding', '8px 16px', 'important');
                    badgeTexto.style.setProperty('font-weight', '600', 'important');
                    badgeTexto.style.setProperty('box-shadow', '0 0 10px rgba(52, 211, 153, 0.2)', 'important');
                    
                    const badgeIcon = badgeTexto.querySelector('i');
                    if (badgeIcon) {
                        badgeIcon.style.setProperty('color', '#34d399', 'important');
                        badgeIcon.style.setProperty('font-size', '18px', 'important');
                    }
                    const badgeSpan = badgeTexto.querySelector('span');
                    if (badgeSpan) {
                        badgeSpan.style.setProperty('color', '#34d399', 'important');
                        badgeSpan.style.setProperty('font-weight', '600', 'important');
                    }
                }
                
                // Aplicar estilos no t√≠tulo principal
                const tituloPrincipal = document.querySelector('[data-field="titulo_principal"]') || document.querySelector('h1');
                if (tituloPrincipal) {
                    tituloPrincipal.style.setProperty('color', '#ffffff', 'important');
                    tituloPrincipal.style.setProperty('font-weight', '800', 'important');
                    tituloPrincipal.style.setProperty('text-shadow', '0 2px 10px rgba(0, 0, 0, 0.3)', 'important');
                    tituloPrincipal.style.setProperty('line-height', '1.2', 'important');
                }
                
                // Aplicar estilos no subt√≠tulo
                const subtitulo = document.querySelector('[data-field="subtitulo"]');
                if (subtitulo) {
                    subtitulo.style.setProperty('color', '#cbd5e1', 'important');
                    subtitulo.style.setProperty('font-weight', '400', 'important');
                    subtitulo.style.setProperty('line-height', '1.6', 'important');
                }
                
                // Aplicar estilos no bot√£o CTA - M√∫ltiplas sele√ß√µes para garantir
                const ctaButton = document.getElementById('ctaButton') || 
                                 document.querySelector('[data-field="texto_botao_aceitar"]') ||
                                 document.querySelector('button[onclick*="triggerPurchase"]') ||
                                 document.querySelector('button[onclick*="processOneClickUpsell"]');
                
                if (ctaButton) {
                    ctaButton.style.setProperty('background', 'linear-gradient(135deg, #10b981 0%, #059669 100%)', 'important');
                    ctaButton.style.setProperty('color', '#ffffff', 'important');
                    ctaButton.style.setProperty('font-weight', '700', 'important');
                    ctaButton.style.setProperty('font-size', '18px', 'important');
                    ctaButton.style.setProperty('padding', '16px 24px', 'important');
                    ctaButton.style.setProperty('border', 'none', 'important');
                    ctaButton.style.setProperty('border-radius', '12px', 'important');
                    ctaButton.style.setProperty('box-shadow', '0 10px 30px rgba(16, 185, 129, 0.5), 0 0 20px rgba(16, 185, 129, 0.3)', 'important');
                    ctaButton.style.setProperty('text-transform', 'uppercase', 'important');
                    ctaButton.style.setProperty('letter-spacing', '0.5px', 'important');
                    ctaButton.style.setProperty('position', 'relative', 'important');
                    ctaButton.style.setProperty('overflow', 'hidden', 'important');
                    
                    // Aplicar estilos no texto do bot√£o
                    const ctaSpans = ctaButton.querySelectorAll('span');
                    ctaSpans.forEach(span => {
                        span.style.setProperty('color', '#ffffff', 'important');
                        span.style.setProperty('font-weight', '700', 'important');
                        span.style.setProperty('z-index', '1', 'important');
                        span.style.setProperty('position', 'relative', 'important');
                    });
                    
                    // Aplicar estilos no √≠cone do bot√£o
                    const ctaIcons = ctaButton.querySelectorAll('i');
                    ctaIcons.forEach(icon => {
                        icon.style.setProperty('color', '#ffffff', 'important');
                        icon.style.setProperty('font-size', '20px', 'important');
                        icon.style.setProperty('z-index', '1', 'important');
                        icon.style.setProperty('position', 'relative', 'important');
                    });
                    
                    // Garantir que o texto do bot√£o seja vis√≠vel
                    if (ctaButton.textContent) {
                        ctaButton.style.setProperty('color', '#ffffff', 'important');
                    }
                }
                
                // Aplicar estilos em todos os elementos de texto branco
                const whiteTextElements = document.querySelectorAll('.text-white, h1, h2, h3');
                whiteTextElements.forEach(el => {
                    if (el.tagName === 'H1' || el.tagName === 'H2' || el.tagName === 'H3') {
                        el.style.setProperty('color', '#ffffff', 'important');
                    }
                });
                
                console.log('‚úÖ Estilos Master Pack aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar estilos Master Pack:', error);
            }
        }
        
        // Fun√ß√£o para aplicar estilos for√ßados no template Mentoria Elite
        function aplicarEstilosMentoriaElite() {
            try {
                // Aplicar estilos na barra de alerta
                const alertBar = document.querySelector('[data-field="texto_alerta"]') || document.querySelector('.alert-bar');
                if (alertBar) {
                    alertBar.style.setProperty('background', 'linear-gradient(135deg, #9333ea 0%, #7c3aed 100%)', 'important');
                    alertBar.style.setProperty('color', '#ffffff', 'important');
                    alertBar.style.setProperty('font-weight', '600', 'important');
                }
                
                // Aplicar estilos no badge do cabe√ßalho
                const badgeTexto = document.querySelector('[data-field="badge_texto"]');
                if (badgeTexto) {
                    badgeTexto.style.setProperty('color', '#FCD34D', 'important');
                    badgeTexto.style.setProperty('background-color', 'rgba(147, 51, 234, 0.15)', 'important');
                    badgeTexto.style.setProperty('border-color', 'rgba(147, 51, 234, 0.3)', 'important');
                }
                
                // Aplicar estilos no t√≠tulo principal
                const tituloPrincipal = document.querySelector('[data-field="titulo_principal"]') || document.querySelector('.title-main');
                if (tituloPrincipal) {
                    tituloPrincipal.style.setProperty('color', '#ffffff', 'important');
                    tituloPrincipal.style.setProperty('font-weight', '800', 'important');
                }
                
                // Aplicar estilos no subt√≠tulo
                const subtitulo = document.querySelector('[data-field="subtitulo"]') || document.querySelector('.subtitle-main');
                if (subtitulo) {
                    subtitulo.style.setProperty('color', '#d1d5db', 'important');
                }
                
                // Aplicar estilos no pre√ßo da oferta
                const precoOferta = document.querySelector('[data-field="preco_oferta"]') || document.querySelector('.price-offer');
                if (precoOferta) {
                    precoOferta.style.setProperty('color', '#FCD34D', 'important');
                    precoOferta.style.setProperty('font-weight', '900', 'important');
                }
                
                // Aplicar estilos no bot√£o CTA
                const ctaButton = document.getElementById('ctaButton') || 
                                 document.querySelector('[data-field="texto_botao_aceitar"]') ||
                                 document.querySelector('.cta-button');
                
                if (ctaButton) {
                    ctaButton.style.setProperty('background', 'linear-gradient(135deg, #9333ea 0%, #7c3aed 100%)', 'important');
                    ctaButton.style.setProperty('color', '#ffffff', 'important');
                    ctaButton.style.setProperty('font-weight', '700', 'important');
                    ctaButton.style.setProperty('box-shadow', '0 10px 40px rgba(147, 51, 234, 0.5)', 'important');
                    
                    const ctaSpans = ctaButton.querySelectorAll('span');
                    ctaSpans.forEach(span => {
                        span.style.setProperty('color', '#ffffff', 'important');
                        span.style.setProperty('font-weight', '700', 'important');
                    });
                    
                    const ctaIcons = ctaButton.querySelectorAll('i');
                    ctaIcons.forEach(icon => {
                        icon.style.setProperty('color', '#FCD34D', 'important');
                    });
                }
                
                // Garantir que textos de garantia sejam vis√≠veis
                const garantia = document.querySelector('[data-field="texto_garantia"]') || document.querySelector('.guarantee-text');
                if (garantia) {
                    garantia.style.setProperty('color', '#ffffff', 'important');
                    garantia.style.setProperty('font-weight', '600', 'important');
                }
                
                console.log('‚úÖ Estilos Mentoria Elite aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar estilos Mentoria Elite:', error);
            }
        }
        
        // Fun√ß√£o auxiliar para normalizar valores de atributos (extrai string de objetos quando necess√°rio)
        function normalizarValorAtributo(valor) {
            if (!valor) return null;
            if (typeof valor === 'string') return valor;
            if (typeof valor === 'object') {
                // Se for um objeto com propriedade 'value', usar ela
                if (valor.value && typeof valor.value === 'string') return valor.value;
                // Se for um objeto com propriedade 'src', usar ela
                if (valor.src && typeof valor.src === 'string') return valor.src;
                // Se for um objeto com propriedade 'url', usar ela
                if (valor.url && typeof valor.url === 'string') return valor.url;
            }
            // Tentar converter para string como √∫ltimo recurso
            return String(valor);
        }
        
        // Fun√ß√£o para aplicar valores dos atributos no template Emagrecimento
        function aplicarAtributosEmagrecimento(page) {
            try {
                const atributos = page.atributos || {};
                
                // Mapear campos para atributos
                const campos = {
                    'badge_texto': atributos.badge_texto,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'texto_preco_inicial': atributos.texto_preco_inicial,
                    'texto_botao_inicial': atributos.texto_botao_inicial,
                    'titulo_resultados': atributos.titulo_resultados,
                    'titulo_depoimentos': atributos.titulo_depoimentos,
                    'texto_escassez': atributos.texto_escassez,
                    'texto_preco_final': atributos.texto_preco_final,
                    'texto_botao_final': atributos.texto_botao_final,
                    'texto_footer': atributos.texto_footer,
                    'links_footer': atributos.links_footer
                };
                
                // Aplicar valores nos elementos
                Object.keys(campos).forEach(field => {
                    if (campos[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            if (elemento.tagName === 'BUTTON' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = campos[field];
                                } else {
                                    elemento.textContent = campos[field];
                                }
                            } else {
                                elemento.innerHTML = campos[field];
                            }
                        }
                    }
                });
                
                // Aplicar imagens dos cards de resultados (resultado_1, resultado_2, resultado_3)
                for (let i = 1; i <= 3; i++) {
                    const field = `resultado_${i}`;
                    const imagemUrl = normalizarValorAtributo(atributos[field]);
                    
                    if (imagemUrl) {
                        // Encontrar o card do resultado
                        const card = document.querySelector(`[data-field="${field}"]`);
                        if (card) {
                            // Encontrar o elemento .result-image dentro do card
                            const resultImage = card.querySelector('.result-image');
                            if (resultImage) {
                                resultImage.src = imagemUrl;
                                console.log(`‚úÖ Imagem aplicada para ${field}: ${imagemUrl}`);
                            }
                        }
                    }
                    
                    // Aplicar nome e depoimento se existirem
                    const nomeField = `resultado_${i}_nome`;
                    const depoimentoField = `resultado_${i}_depoimento`;
                    
                    if (atributos[nomeField]) {
                        const nomeElement = document.querySelector(`[data-field="${nomeField}"]`);
                        if (nomeElement) {
                            nomeElement.textContent = atributos[nomeField];
                        }
                    }
                    
                    if (atributos[depoimentoField]) {
                        const depoimentoElement = document.querySelector(`[data-field="${depoimentoField}"]`);
                        if (depoimentoElement) {
                            depoimentoElement.textContent = atributos[depoimentoField];
                        }
                    }
                }
                
                // Aplicar avatares de depoimentos sociais (depoimento_social_1_avatar, etc.)
                for (let i = 1; i <= 3; i++) {
                    const avatarField = `depoimento_social_${i}_avatar`;
                    const avatarUrl = normalizarValorAtributo(atributos[avatarField]);
                    
                    if (avatarUrl) {
                        const avatarElement = document.querySelector(`[data-field="${avatarField}"]`);
                        if (avatarElement && avatarElement.tagName === 'IMG') {
                            avatarElement.src = avatarUrl;
                            console.log(`‚úÖ Avatar aplicado para ${avatarField}: ${avatarUrl}`);
                        }
                    }
                    
                    // Aplicar outros campos do depoimento social
                    const nomeField = `depoimento_social_${i}_nome`;
                    const localField = `depoimento_social_${i}_local`;
                    const textoField = `depoimento_social_${i}_texto`;
                    const resultadoField = `depoimento_social_${i}_resultado`;
                    
                    if (atributos[nomeField]) {
                        const nomeElement = document.querySelector(`[data-field="${nomeField}"]`);
                        if (nomeElement) nomeElement.textContent = atributos[nomeField];
                    }
                    
                    if (atributos[localField]) {
                        const localElement = document.querySelector(`[data-field="${localField}"]`);
                        if (localElement) localElement.textContent = atributos[localField];
                    }
                    
                    if (atributos[textoField]) {
                        const textoElement = document.querySelector(`[data-field="${textoField}"]`);
                        if (textoElement) textoElement.textContent = atributos[textoField];
                    }
                    
                    if (atributos[resultadoField]) {
                        const resultadoElement = document.querySelector(`[data-field="${resultadoField}"]`);
                        if (resultadoElement) resultadoElement.textContent = atributos[resultadoField];
                    }
                }
                
                // Aplicar textos dos depoimentos do carrossel
                for (let i = 1; i <= 4; i++) {
                    const textoField = `depoimento_carrosel_${i}_texto`;
                    const autorField = `depoimento_carrosel_${i}_autor`;
                    
                    if (atributos[textoField]) {
                        const textoElement = document.querySelector(`[data-field="${textoField}"]`);
                        if (textoElement) textoElement.textContent = atributos[textoField];
                    }
                    
                    if (atributos[autorField]) {
                        const autorElement = document.querySelector(`[data-field="${autorField}"]`);
                        if (autorElement) autorElement.textContent = atributos[autorField];
                    }
                }
                
                console.log('‚úÖ Atributos Emagrecimento aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar atributos Emagrecimento:', error);
            }
        }
        
        // Fun√ß√£o para aplicar imagens dos ebooks no template Pacote Maestria
        function aplicarImagensEbooks(page) {
            try {
                const atributos = page.atributos || {};
                
                // Aplicar imagens para cada ebook (ebook_1, ebook_2, ebook_3)
                for (let i = 1; i <= 3; i++) {
                    const field = `ebook_${i}`;
                    const imagemUrl = normalizarValorAtributo(atributos[field]);
                    
                    if (imagemUrl) {
                        // Encontrar o card do ebook
                        const card = document.querySelector(`[data-field="${field}"]`);
                        if (card) {
                            // Encontrar o elemento .ebook-cover dentro do card
                            const cover = card.querySelector('.ebook-cover');
                            if (cover) {
                                cover.style.backgroundImage = `url('${imagemUrl}')`;
                                console.log(`‚úÖ Imagem aplicada para ${field}: ${imagemUrl}`);
                            }
                        }
                    }
                }
                
                // Aplicar outros atributos de texto se existirem
                const camposTexto = {
                    'badge_texto': atributos.badge_texto,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'titulo_valor': atributos.titulo_valor,
                    'texto_economia': atributos.texto_economia,
                    'texto_botao_principal': atributos.texto_botao_principal,
                    'texto_botao_sticky': atributos.texto_botao_sticky,
                    'texto_footer': atributos.texto_footer,
                    'links_footer': atributos.links_footer
                };
                
                Object.keys(camposTexto).forEach(field => {
                    if (camposTexto[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            if (elemento.tagName === 'BUTTON' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = camposTexto[field];
                                } else {
                                    elemento.textContent = camposTexto[field];
                                }
                            } else {
                                elemento.innerHTML = camposTexto[field];
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Imagens e atributos dos ebooks aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar imagens dos ebooks:', error);
            }
        }
        
        // Fun√ß√£o para aplicar atributos do template Plataforma SaaS
        function aplicarAtributosPlataformaSaaS(page) {
            try {
                const atributos = page.atributos || {};
                
                // Mapear todos os campos edit√°veis
                const campos = {
                    'badge_texto': atributos.badge_texto,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'texto_botao_principal': atributos.texto_botao_principal,
                    'texto_prova_social': atributos.texto_prova_social,
                    'titulo_prova_social': atributos.titulo_prova_social,
                    'badge_funcionalidades': atributos.badge_funcionalidades,
                    'titulo_funcionalidades': atributos.titulo_funcionalidades,
                    'badge_planos': atributos.badge_planos,
                    'titulo_planos': atributos.titulo_planos,
                    'badge_plano_destaque': atributos.badge_plano_destaque,
                    'sticky_label': atributos.sticky_label,
                    'sticky_preco': atributos.sticky_preco,
                    'sticky_botao': atributos.sticky_botao,
                    'texto_footer': atributos.texto_footer,
                    'links_footer': atributos.links_footer,
                    // Funcionalidades
                    'funcionalidade_1_titulo': atributos.funcionalidade_1_titulo,
                    'funcionalidade_1_descricao': atributos.funcionalidade_1_descricao,
                    'funcionalidade_2_titulo': atributos.funcionalidade_2_titulo,
                    'funcionalidade_2_descricao': atributos.funcionalidade_2_descricao,
                    'funcionalidade_3_titulo': atributos.funcionalidade_3_titulo,
                    'funcionalidade_3_descricao': atributos.funcionalidade_3_descricao,
                    'funcionalidade_4_titulo': atributos.funcionalidade_4_titulo,
                    'funcionalidade_4_descricao': atributos.funcionalidade_4_descricao,
                    'funcionalidade_5_titulo': atributos.funcionalidade_5_titulo,
                    'funcionalidade_5_descricao': atributos.funcionalidade_5_descricao,
                    'funcionalidade_6_titulo': atributos.funcionalidade_6_titulo,
                    'funcionalidade_6_descricao': atributos.funcionalidade_6_descricao,
                    // Planos
                    'plano_1_nome': atributos.plano_1_nome,
                    'plano_1_descricao': atributos.plano_1_descricao,
                    'plano_1_preco': atributos.plano_1_preco,
                    'plano_1_botao': atributos.plano_1_botao,
                    'plano_2_nome': atributos.plano_2_nome,
                    'plano_2_descricao': atributos.plano_2_descricao,
                    'plano_2_preco': atributos.plano_2_preco,
                    'plano_2_botao': atributos.plano_2_botao,
                    'plano_3_nome': atributos.plano_3_nome,
                    'plano_3_descricao': atributos.plano_3_descricao,
                    'plano_3_preco': atributos.plano_3_preco,
                    'plano_3_botao': atributos.plano_3_botao
                };
                
                // Aplicar valores nos elementos
                Object.keys(campos).forEach(field => {
                    if (campos[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            if (elemento.tagName === 'BUTTON' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = campos[field];
                                } else {
                                    elemento.textContent = campos[field];
                                }
                            } else {
                                elemento.innerHTML = campos[field];
                            }
                        }
                    }
                });
                
                // Aplicar imagem de demonstra√ß√£o se existir
                if (atributos.imagem_demo) {
                    const demoImage = document.querySelector('[data-field="imagem_demo"]');
                    if (demoImage && demoImage.tagName === 'IMG') {
                        demoImage.src = atributos.imagem_demo;
                    }
                }
                
                console.log('‚úÖ Atributos Plataforma SaaS aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar atributos Plataforma SaaS:', error);
            }
        }
        
        // Fun√ß√£o para aplicar atributos do template Black Friday Ingl√™s
        function aplicarAtributosBlackFridayIngles(page) {
            try {
                const atributos = page.atributos || {};
                
                // Mapear todos os campos edit√°veis
                const campos = {
                    'top_bar_texto': atributos.top_bar_texto,
                    'badge_hero': atributos.badge_hero,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'countdown_label': atributos.countdown_label,
                    'texto_botao_hero': atributos.texto_botao_hero,
                    'texto_garantia': atributos.texto_garantia,
                    'problema_titulo': atributos.problema_titulo,
                    'solucao_titulo': atributos.solucao_titulo,
                    'oferta_titulo': atributos.oferta_titulo,
                    'oferta_subtitulo': atributos.oferta_subtitulo,
                    'ribbon_texto': atributos.ribbon_texto,
                    'plano_nome': atributos.plano_nome,
                    'plano_descricao': atributos.plano_descricao,
                    'preco_antigo': atributos.preco_antigo,
                    'desconto_texto': atributos.desconto_texto,
                    'preco_atual': atributos.preco_atual,
                    'parcelas': atributos.parcelas,
                    'texto_botao_oferta': atributos.texto_botao_oferta,
                    'faq_titulo': atributos.faq_titulo,
                    'faq_1_pergunta': atributos.faq_1_pergunta,
                    'faq_1_resposta': atributos.faq_1_resposta,
                    'faq_2_pergunta': atributos.faq_2_pergunta,
                    'faq_2_resposta': atributos.faq_2_resposta,
                    'faq_3_pergunta': atributos.faq_3_pergunta,
                    'faq_3_resposta': atributos.faq_3_resposta,
                    'footer_brand': atributos.footer_brand,
                    'footer_texto': atributos.footer_texto,
                    'footer_links': atributos.footer_links
                };
                
                // Aplicar valores nos elementos
                Object.keys(campos).forEach(field => {
                    if (campos[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            // Se o elemento √© um span dentro de um bot√£o/link, aplicar no span
                            if (elemento.tagName === 'SPAN' && (elemento.parentElement.tagName === 'BUTTON' || elemento.parentElement.tagName === 'A')) {
                                elemento.textContent = campos[field];
                            } else if (elemento.tagName === 'BUTTON' || elemento.tagName === 'A' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = campos[field];
                                } else {
                                    elemento.textContent = campos[field];
                                }
                            } else {
                                elemento.innerHTML = campos[field];
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Atributos Black Friday Ingl√™s aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar atributos Black Friday Ingl√™s:', error);
            }
        }
        
        // Fun√ß√£o para aplicar atributos do template Gui√£o das Receitas
        function aplicarAtributosGui√£oReceitas(page) {
            try {
                const atributos = page.atributos || {};
                
                // Mapear todos os campos edit√°veis
                const campos = {
                    'navbar_brand': atributos.navbar_brand,
                    'navbar_cta': atributos.navbar_cta,
                    'hero_badge': atributos.hero_badge,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'botao_ver_receitas': atributos.botao_ver_receitas,
                    'botao_quero_gui√£o': atributos.botao_quero_gui√£o,
                    'beneficios_titulo': atributos.beneficios_titulo,
                    'beneficios_subtitulo': atributos.beneficios_subtitulo,
                    'beneficio_1_titulo': atributos.beneficio_1_titulo,
                    'beneficio_1_descricao': atributos.beneficio_1_descricao,
                    'beneficio_2_titulo': atributos.beneficio_2_titulo,
                    'beneficio_2_descricao': atributos.beneficio_2_descricao,
                    'beneficio_3_titulo': atributos.beneficio_3_titulo,
                    'beneficio_3_descricao': atributos.beneficio_3_descricao,
                    'inside_badge_1': atributos.inside_badge_1,
                    'inside_titulo_1': atributos.inside_titulo_1,
                    'inside_descricao_1': atributos.inside_descricao_1,
                    'inside_badge_2': atributos.inside_badge_2,
                    'inside_titulo_2': atributos.inside_titulo_2,
                    'inside_descricao_2': atributos.inside_descricao_2,
                    'inside_link': atributos.inside_link,
                    'galeria_titulo': atributos.galeria_titulo,
                    'galeria_1_texto': atributos.galeria_1_texto,
                    'preco_titulo': atributos.preco_titulo,
                    'preco_subtitulo': atributos.preco_subtitulo,
                    'preco_badge': atributos.preco_badge,
                    'preco_antigo': atributos.preco_antigo,
                    'preco_atual': atributos.preco_atual,
                    'preco_botao': atributos.preco_botao,
                    'preco_garantia': atributos.preco_garantia,
                    'footer_brand': atributos.footer_brand,
                    'footer_texto': atributos.footer_texto
                };
                
                // Aplicar valores nos elementos
                Object.keys(campos).forEach(field => {
                    if (campos[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            if (elemento.tagName === 'BUTTON' || elemento.tagName === 'A' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = campos[field];
                                } else {
                                    elemento.textContent = campos[field];
                                }
                            } else {
                                elemento.innerHTML = campos[field];
                            }
                        }
                    }
                });
                
                // Aplicar imagens dos benef√≠cios
                for (let i = 1; i <= 3; i++) {
                    const field = `beneficio_${i}`;
                    const imagemUrl = normalizarValorAtributo(atributos[field]);
                    
                    if (imagemUrl) {
                        const card = document.querySelector(`[data-field="${field}"]`);
                        if (card) {
                            const img = card.querySelector('.benefit-image');
                            if (img) {
                                img.src = imagemUrl;
                                console.log(`‚úÖ Imagem aplicada para ${field}: ${imagemUrl}`);
                            }
                        }
                    }
                }
                
                // Aplicar imagens da se√ß√£o Inside
                for (let i = 1; i <= 2; i++) {
                    const field = `inside_imagem_${i}`;
                    const imagemUrl = normalizarValorAtributo(atributos[field]);
                    
                    if (imagemUrl) {
                        const wrapper = document.querySelector(`[data-field="${field}"]`);
                        if (wrapper) {
                            const img = wrapper.querySelector('.inside-image');
                            if (img) {
                                img.src = imagemUrl;
                                console.log(`‚úÖ Imagem aplicada para ${field}: ${imagemUrl}`);
                            }
                        }
                    }
                }
                
                // Aplicar imagens da galeria
                for (let i = 1; i <= 6; i++) {
                    const field = `galeria_${i}`;
                    const imagemUrl = normalizarValorAtributo(atributos[field]);
                    
                    if (imagemUrl) {
                        const item = document.querySelector(`[data-field="${field}"]`);
                        if (item) {
                            const img = item.querySelector('.gallery-image');
                            if (img) {
                                img.src = imagemUrl;
                                console.log(`‚úÖ Imagem aplicada para ${field}: ${imagemUrl}`);
                            }
                        }
                    }
                }
                
                // Aplicar imagem de fundo do hero
                if (atributos.hero_background) {
                    const hero = document.querySelector('[data-field="hero_background"]');
                    if (hero) {
                        const bgUrl = normalizarValorAtributo(atributos.hero_background);
                        if (bgUrl) {
                            hero.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('${bgUrl}')`;
                        }
                    }
                }
                
                console.log('‚úÖ Atributos Gui√£o das Receitas aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar atributos Gui√£o das Receitas:', error);
            }
        }
        
        // Fun√ß√£o para aplicar atributos do template BioPure Detox
        function aplicarAtributosBioPureDetox(page) {
            try {
                const atributos = page.atributos || {};
                
                // Mapear todos os campos edit√°veis
                const campos = {
                    'alert_bar': atributos.alert_bar,
                    'navbar_brand': atributos.navbar_brand,
                    'navbar_cta': atributos.navbar_cta,
                    'hero_badge': atributos.hero_badge,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'video_caption': atributos.video_caption,
                    'copy_titulo': atributos.copy_titulo,
                    'copy_texto': atributos.copy_texto,
                    'hero_cta': atributos.hero_cta,
                    'agitation_titulo': atributos.agitation_titulo,
                    'agitation_card_1_titulo': atributos.agitation_card_1_titulo,
                    'agitation_card_1_texto': atributos.agitation_card_1_texto,
                    'agitation_card_2_titulo': atributos.agitation_card_2_titulo,
                    'agitation_card_2_texto': atributos.agitation_card_2_texto,
                    'agitation_card_3_titulo': atributos.agitation_card_3_titulo,
                    'agitation_card_3_texto': atributos.agitation_card_3_texto,
                    'how_it_works_titulo': atributos.how_it_works_titulo,
                    'how_it_works_descricao': atributos.how_it_works_descricao,
                    'step_1_titulo': atributos.step_1_titulo,
                    'step_1_texto': atributos.step_1_texto,
                    'step_2_titulo': atributos.step_2_titulo,
                    'step_2_texto': atributos.step_2_texto,
                    'step_3_titulo': atributos.step_3_titulo,
                    'step_3_texto': atributos.step_3_texto,
                    'preco_titulo': atributos.preco_titulo,
                    'preco_subtitulo': atributos.preco_subtitulo,
                    'preco_card_1_titulo': atributos.preco_card_1_titulo,
                    'preco_card_1_subtitulo': atributos.preco_card_1_subtitulo,
                    'preco_card_1_antigo': atributos.preco_card_1_antigo,
                    'preco_card_1_atual': atributos.preco_card_1_atual,
                    'preco_card_1_bonus': atributos.preco_card_1_bonus,
                    'preco_card_1_botao': atributos.preco_card_1_botao,
                    'preco_card_2_badge': atributos.preco_card_2_badge,
                    'preco_card_2_titulo': atributos.preco_card_2_titulo,
                    'preco_card_2_subtitulo': atributos.preco_card_2_subtitulo,
                    'preco_card_2_antigo': atributos.preco_card_2_antigo,
                    'preco_card_2_atual': atributos.preco_card_2_atual,
                    'preco_card_2_unit': atributos.preco_card_2_unit,
                    'preco_card_2_bonus': atributos.preco_card_2_bonus,
                    'preco_card_2_botao': atributos.preco_card_2_botao,
                    'preco_card_3_titulo': atributos.preco_card_3_titulo,
                    'preco_card_3_subtitulo': atributos.preco_card_3_subtitulo,
                    'preco_card_3_antigo': atributos.preco_card_3_antigo,
                    'preco_card_3_atual': atributos.preco_card_3_atual,
                    'preco_card_3_unit': atributos.preco_card_3_unit,
                    'preco_card_3_bonus': atributos.preco_card_3_bonus,
                    'preco_card_3_botao': atributos.preco_card_3_botao,
                    'garantia_titulo': atributos.garantia_titulo,
                    'garantia_texto': atributos.garantia_texto,
                    'faq_titulo': atributos.faq_titulo,
                    'faq_1_pergunta': atributos.faq_1_pergunta,
                    'faq_1_resposta': atributos.faq_1_resposta,
                    'faq_2_pergunta': atributos.faq_2_pergunta,
                    'faq_2_resposta': atributos.faq_2_resposta,
                    'faq_3_pergunta': atributos.faq_3_pergunta,
                    'faq_3_resposta': atributos.faq_3_resposta,
                    'footer_texto': atributos.footer_texto,
                    'footer_disclaimer': atributos.footer_disclaimer
                };
                
                // Aplicar valores nos elementos
                Object.keys(campos).forEach(field => {
                    if (campos[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            if (elemento.tagName === 'BUTTON' || elemento.tagName === 'A' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = campos[field];
                                } else {
                                    elemento.textContent = campos[field];
                                }
                            } else {
                                elemento.innerHTML = campos[field];
                            }
                        }
                    }
                });
                
                // Aplicar v√≠deo do hero
                if (atributos.hero_video) {
                    const videoContainer = document.querySelector('[data-field="hero_video"]');
                    if (videoContainer) {
                        const videoBox = videoContainer.querySelector('.hero-video-box');
                        if (videoBox) {
                            // Normalizar valor do v√≠deo
                            const videoValue = normalizarValorAtributo(atributos.hero_video);
                            
                            // Se for uma URL de v√≠deo (YouTube/Vimeo), criar iframe
                            if (videoValue && typeof videoValue === 'string' && (videoValue.includes('youtube.com') || videoValue.includes('youtu.be') || videoValue.includes('vimeo.com'))) {
                                let videoUrl = videoValue;
                                if (videoUrl.includes('youtube.com/watch?v=')) {
                                    videoUrl = videoUrl.replace('youtube.com/watch?v=', 'youtube.com/embed/');
                                } else if (videoUrl.includes('youtu.be/')) {
                                    videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                                } else if (videoUrl.includes('vimeo.com/')) {
                                    videoUrl = videoUrl.replace('vimeo.com/', 'player.vimeo.com/video/');
                                }
                                
                                videoBox.innerHTML = `<iframe src="${videoUrl}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="width: 100%; height: 100%;"></iframe>`;
                            } else if (videoValue && typeof videoValue === 'string') {
                                // Se for uma imagem, aplicar como background ou img
                                const img = videoBox.querySelector('.hero-video-image');
                                if (img) {
                                    img.src = videoValue;
                                }
                            }
                        }
                    }
                }
                
                // Aplicar imagem da se√ß√£o How it Works
                if (atributos.how_it_works_imagem) {
                    const wrapper = document.querySelector('[data-field="how_it_works_imagem"]');
                    if (wrapper) {
                        const img = wrapper.querySelector('.how-it-works-image');
                        if (img) {
                            const imgUrl = normalizarValorAtributo(atributos.how_it_works_imagem);
                            if (imgUrl) {
                                img.src = imgUrl;
                            }
                        }
                    }
                }
                
                // Aplicar imagem da garantia
                if (atributos.garantia_imagem) {
                    const img = document.querySelector('[data-field="garantia_imagem"]');
                    if (img && img.tagName === 'IMG') {
                        const imgUrl = normalizarValorAtributo(atributos.garantia_imagem);
                        if (imgUrl) {
                            img.src = imgUrl;
                        }
                    }
                }
                
                console.log('‚úÖ Atributos BioPure Detox aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar atributos BioPure Detox:', error);
            }
        }
        
        // Fun√ß√£o para aplicar atributos do template M√©todo Liberdade Digital
        function aplicarAtributosMetodoLiberdadeDigital(page) {
            try {
                const atributos = page.atributos || {};
                
                // Mapear todos os campos edit√°veis
                const campos = {
                    'navbar_brand': atributos.navbar_brand,
                    'hero_badge': atributos.hero_badge,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'video_caption': atributos.video_caption,
                    'video_sound_warning': atributos.video_sound_warning,
                    'hero_cta': atributos.hero_cta,
                    'social_proof_titulo': atributos.social_proof_titulo,
                    'social_proof_subtitulo': atributos.social_proof_subtitulo,
                    'social_proof_nome_1': atributos.social_proof_nome_1,
                    'social_proof_role_1': atributos.social_proof_role_1,
                    'social_proof_label_1': atributos.social_proof_label_1,
                    'social_proof_valor_1': atributos.social_proof_valor_1,
                    'social_proof_depoimento_1': atributos.social_proof_depoimento_1,
                    'social_proof_nome_2': atributos.social_proof_nome_2,
                    'social_proof_role_2': atributos.social_proof_role_2,
                    'social_proof_label_2': atributos.social_proof_label_2,
                    'social_proof_valor_2': atributos.social_proof_valor_2,
                    'social_proof_depoimento_2': atributos.social_proof_depoimento_2,
                    'social_proof_nome_3': atributos.social_proof_nome_3,
                    'social_proof_role_3': atributos.social_proof_role_3,
                    'social_proof_label_3': atributos.social_proof_label_3,
                    'social_proof_valor_3': atributos.social_proof_valor_3,
                    'social_proof_depoimento_3': atributos.social_proof_depoimento_3,
                    'how_it_works_titulo': atributos.how_it_works_titulo,
                    'step_1_titulo': atributos.step_1_titulo,
                    'step_1_texto': atributos.step_1_texto,
                    'step_2_titulo': atributos.step_2_titulo,
                    'step_2_texto': atributos.step_2_texto,
                    'step_3_titulo': atributos.step_3_titulo,
                    'step_3_texto': atributos.step_3_texto,
                    'oferta_badge': atributos.oferta_badge,
                    'oferta_titulo': atributos.oferta_titulo,
                    'oferta_subtitulo': atributos.oferta_subtitulo,
                    'oferta_preco_antigo': atributos.oferta_preco_antigo,
                    'oferta_preco_atual': atributos.oferta_preco_atual,
                    'oferta_desconto': atributos.oferta_desconto,
                    'beneficio_1': atributos.beneficio_1,
                    'beneficio_2': atributos.beneficio_2,
                    'beneficio_3': atributos.beneficio_3,
                    'beneficio_4': atributos.beneficio_4,
                    'oferta_botao': atributos.oferta_botao,
                    'oferta_garantia': atributos.oferta_garantia,
                    'footer_texto': atributos.footer_texto,
                    'footer_disclaimer': atributos.footer_disclaimer
                };
                
                // Aplicar valores nos elementos
                Object.keys(campos).forEach(field => {
                    if (campos[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            if (elemento.tagName === 'BUTTON' || elemento.tagName === 'A' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = campos[field];
                                } else {
                                    elemento.textContent = campos[field];
                                }
                            } else {
                                elemento.innerHTML = campos[field];
                            }
                        }
                    }
                });
                
                // Aplicar v√≠deo do hero
                if (atributos.hero_video) {
                    const videoContainer = document.querySelector('[data-field="hero_video"]');
                    if (videoContainer) {
                        const videoBox = videoContainer.querySelector('.hero-video-container');
                        if (videoBox) {
                            // Normalizar valor do v√≠deo
                            const videoValue = normalizarValorAtributo(atributos.hero_video);
                            
                            // Se for uma URL de v√≠deo (YouTube/Vimeo), criar iframe
                            if (videoValue && typeof videoValue === 'string' && (videoValue.includes('youtube.com') || videoValue.includes('youtu.be') || videoValue.includes('vimeo.com'))) {
                                let videoUrl = videoValue;
                                if (videoUrl.includes('youtube.com/watch?v=')) {
                                    videoUrl = videoUrl.replace('youtube.com/watch?v=', 'youtube.com/embed/');
                                } else if (videoUrl.includes('youtu.be/')) {
                                    videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
                                } else if (videoUrl.includes('vimeo.com/')) {
                                    videoUrl = videoUrl.replace('vimeo.com/', 'player.vimeo.com/video/');
                                }
                                
                                videoBox.innerHTML = `<iframe src="${videoUrl}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="width: 100%; height: 100%; position: absolute; inset: 0;"></iframe>`;
                            } else if (videoValue && typeof videoValue === 'string') {
                                // Se for uma imagem, aplicar como background ou img
                                const img = videoBox.querySelector('.hero-video-image');
                                if (img) {
                                    img.src = videoValue;
                                }
                            }
                        }
                    }
                }
                
                console.log('‚úÖ Atributos M√©todo Liberdade Digital aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar atributos M√©todo Liberdade Digital:', error);
            }
        }
        
        // Fun√ß√£o para aplicar atributos do template A F√≥rmula da Mulher Irresist√≠vel
        function aplicarAtributosFormulaMulherIrresistivel(page) {
            try {
                const atributos = page.atributos || {};
                
                // Mapear todos os campos edit√°veis
                const campos = {
                    'top_bar': atributos.top_bar,
                    'hero_badge': atributos.hero_badge,
                    'titulo_principal': atributos.titulo_principal,
                    'subtitulo': atributos.subtitulo,
                    'hero_cta': atributos.hero_cta,
                    'hero_note': atributos.hero_note,
                    'pain_points_titulo': atributos.pain_points_titulo,
                    'pain_point_1_titulo': atributos.pain_point_1_titulo,
                    'pain_point_1_texto': atributos.pain_point_1_texto,
                    'pain_point_2_titulo': atributos.pain_point_2_titulo,
                    'pain_point_2_texto': atributos.pain_point_2_texto,
                    'pain_point_3_titulo': atributos.pain_point_3_titulo,
                    'pain_point_3_texto': atributos.pain_point_3_texto,
                    'storytelling_titulo': atributos.storytelling_titulo,
                    'storytelling_paragrafo_1': atributos.storytelling_paragrafo_1,
                    'storytelling_paragrafo_2': atributos.storytelling_paragrafo_2,
                    'solution_titulo': atributos.solution_titulo,
                    'solution_subtitulo': atributos.solution_subtitulo,
                    'solution_features_titulo': atributos.solution_features_titulo,
                    'feature_1': atributos.feature_1,
                    'feature_2': atributos.feature_2,
                    'feature_3': atributos.feature_3,
                    'feature_4': atributos.feature_4,
                    'solution_imagem_texto': atributos.solution_imagem_texto,
                    'social_proof_titulo': atributos.social_proof_titulo,
                    'testimonial_1_texto': atributos.testimonial_1_texto,
                    'testimonial_1_autor': atributos.testimonial_1_autor,
                    'testimonial_2_texto': atributos.testimonial_2_texto,
                    'testimonial_2_autor': atributos.testimonial_2_autor,
                    'testimonial_3_texto': atributos.testimonial_3_texto,
                    'testimonial_3_autor': atributos.testimonial_3_autor,
                    'oferta_titulo': atributos.oferta_titulo,
                    'oferta_subtitulo': atributos.oferta_subtitulo,
                    'oferta_ribbon': atributos.oferta_ribbon,
                    'oferta_preco_antigo': atributos.oferta_preco_antigo,
                    'oferta_preco_atual': atributos.oferta_preco_atual,
                    'oferta_preco_nota': atributos.oferta_preco_nota,
                    'beneficio_1': atributos.beneficio_1,
                    'beneficio_2': atributos.beneficio_2,
                    'beneficio_3': atributos.beneficio_3,
                    'beneficio_4': atributos.beneficio_4,
                    'oferta_botao': atributos.oferta_botao,
                    'oferta_security': atributos.oferta_security,
                    'garantia_titulo': atributos.garantia_titulo,
                    'garantia_texto': atributos.garantia_texto,
                    'faq_titulo': atributos.faq_titulo,
                    'faq_1_pergunta': atributos.faq_1_pergunta,
                    'faq_1_resposta': atributos.faq_1_resposta,
                    'faq_2_pergunta': atributos.faq_2_pergunta,
                    'faq_2_resposta': atributos.faq_2_resposta,
                    'faq_3_pergunta': atributos.faq_3_pergunta,
                    'faq_3_resposta': atributos.faq_3_resposta,
                    'footer_brand': atributos.footer_brand,
                    'footer_descricao': atributos.footer_descricao,
                    'footer_copyright': atributos.footer_copyright
                };
                
                // Aplicar valores nos elementos
                Object.keys(campos).forEach(field => {
                    if (campos[field]) {
                        const elemento = document.querySelector(`[data-field="${field}"]`);
                        if (elemento) {
                            if (elemento.tagName === 'BUTTON' || elemento.tagName === 'A' || elemento.querySelector('span')) {
                                const span = elemento.querySelector('span');
                                if (span) {
                                    span.textContent = campos[field];
                                } else {
                                    elemento.textContent = campos[field];
                                }
                            } else {
                                elemento.innerHTML = campos[field];
                            }
                        }
                    }
                });
                
                // Aplicar imagem de fundo do hero
                if (atributos.hero_background) {
                    const hero = document.querySelector('[data-field="hero_background"]');
                    if (hero) {
                        const bgUrl = normalizarValorAtributo(atributos.hero_background);
                        if (bgUrl) {
                            hero.style.backgroundImage = `linear-gradient(to right bottom, rgba(76, 29, 149, 0.6), rgba(190, 24, 93, 0.6)), url('${bgUrl}')`;
                        }
                    }
                }
                
                // Aplicar imagem da se√ß√£o Storytelling
                if (atributos.storytelling_imagem) {
                    const wrapper = document.querySelector('[data-field="storytelling_imagem"]');
                    if (wrapper) {
                        const img = wrapper.querySelector('.storytelling-image');
                        if (img) {
                            const imgUrl = normalizarValorAtributo(atributos.storytelling_imagem);
                            if (imgUrl) {
                                img.src = imgUrl;
                            }
                        }
                    }
                }
                
                // Aplicar imagem da se√ß√£o Solution
                if (atributos.solution_imagem) {
                    const wrapper = document.querySelector('[data-field="solution_imagem"]');
                    if (wrapper) {
                        const img = wrapper.querySelector('.solution-image');
                        if (img) {
                            const imgUrl = normalizarValorAtributo(atributos.solution_imagem);
                            if (imgUrl) {
                                img.src = imgUrl;
                            }
                        }
                    }
                }
                
                console.log('‚úÖ Atributos A F√≥rmula da Mulher Irresist√≠vel aplicados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar atributos A F√≥rmula da Mulher Irresist√≠vel:', error);
            }
        }
        
        // Fun√ß√£o para injetar CSS de prote√ß√£o de v√≠deo
        function injetarCSSProtecaoVideo() {
            const style = document.createElement('style');
            style.id = 'video-protection-css';
            style.textContent = `
                /* Estilos globais para Master Pack - Garantir visibilidade */
                [data-field="texto_alerta"] {
                    background-color: #10b981 !important;
                    color: #ffffff !important;
                    font-weight: 600 !important;
                }
                
                [data-field="badge_texto"] {
                    color: #34d399 !important;
                    background-color: rgba(52, 211, 153, 0.15) !important;
                    border-color: rgba(52, 211, 153, 0.3) !important;
                }
                
                [data-field="badge_texto"] i,
                [data-field="badge_texto"] span {
                    color: #34d399 !important;
                }
                
                [data-field="titulo_principal"] {
                    color: #ffffff !important;
                    font-weight: 800 !important;
                }
                
                [data-field="subtitulo"] {
                    color: #cbd5e1 !important;
                }
                
                #ctaButton {
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
                    color: #ffffff !important;
                    font-weight: 700 !important;
                    border: none !important;
                }
                
                #ctaButton span,
                #ctaButton i {
                    color: #ffffff !important;
                }
                
                /* Prote√ß√£o de v√≠deo - CSS Universal */
                .video-container-protected {
                    position: relative;
                    user-select: none;
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                }
                
                .video-container-protected video,
                .video-container-protected iframe {
                    pointer-events: none !important;
                    user-select: none !important;
                }
                
                .video-container-protected video::-webkit-media-controls {
                    display: none !important;
                }
                
                .video-container-protected video::-webkit-media-controls-enclosure {
                    display: none !important;
                }
                
                .video-container-protected video::-webkit-media-controls-panel {
                    display: none !important;
                }
                
                .video-protection-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 30;
                    background: transparent;
                    cursor: default;
                }
                
                /* Toast de notifica√ß√£o */
                .upsell-toast {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 10000;
                    animation: slideInToast 0.3s ease;
                    color: white;
                    font-weight: 600;
                }
                
                .upsell-toast.success { background: #28a745; }
                .upsell-toast.error { background: #dc3545; }
                .upsell-toast.warning { background: #ffc107; color: #333; }
                .upsell-toast.info { background: #17a2b8; }
                
                @keyframes slideInToast {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                /* Bot√£o de ativar som */
                .sound-activate-btn {
                    position: absolute;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(249, 115, 22, 0.95);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 100;
                    animation: pulse 2s infinite;
                }
                
                @keyframes pulse {
                    0%, 100% { transform: translateX(-50%) scale(1); }
                    50% { transform: translateX(-50%) scale(1.05); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Fun√ß√£o para injetar script de pagamento universal
        function injetarScriptPagamentoUniversal(page, produto, valor) {
            // Armazenar dados globalmente ANTES do script
            window._upsellData = {
                apiBase: API_BASE,
                pedidoId: pedido,
                produto: produto,
                valor: valor,
                page: page
            };
            
            const script = document.createElement('script');
            script.id = 'upsell-payment-script';
            script.textContent = `
                (function() {
                    // Usar dados armazenados globalmente
                    const upsellData = window._upsellData || {};
                    const API_BASE = upsellData.apiBase || window.location.origin + '/api';
                    const pedidoId = upsellData.pedidoId || new URLSearchParams(window.location.search).get('pedido') || new URLSearchParams(window.location.search).get('idpedido');
                    const produtoSelecionado = upsellData.produto;
                    const valorProduto = upsellData.valor || 0;
                    const upsellPage = upsellData.page;
                    
                    console.log('üîß Script de pagamento universal carregado');
                    console.log('üì¶ Produto:', produtoSelecionado?.nome);
                    console.log('üí∞ Valor:', valorProduto);
                    console.log('üîó Pedido ID:', pedidoId);
                    
                    // Fun√ß√£o de toast
                    function showToast(message, type = 'info') {
                        const existingToast = document.querySelector('.upsell-toast');
                        if (existingToast) existingToast.remove();
                        
                        const toast = document.createElement('div');
                        toast.className = 'upsell-toast ' + type;
                        toast.textContent = message;
                        document.body.appendChild(toast);
                        
                        setTimeout(() => {
                            toast.style.animation = 'slideInToast 0.3s ease reverse';
                            setTimeout(() => toast.remove(), 300);
                        }, 4000);
                    }
                    
                    // Fun√ß√£o de redirecionamento
                    function redirectToSuccess() {
                        const clientName = new URLSearchParams(window.location.search).get('clientName') || 'Cliente';
                        const amount = new URLSearchParams(window.location.search).get('amount') || '0';
                        const productId = new URLSearchParams(window.location.search).get('productId') || '';
                        const params = 'pedido=' + pedidoId + '&productId=' + productId + '&clientName=' + encodeURIComponent(clientName) + '&amount=' + amount;
                        window.location.href = '/payment-success.html?' + params;
                    }
                    
                    // Fun√ß√£o principal de processamento de pagamento - UNIVERSAL
                    async function processarPagamentoUpsell() {
                        console.log('üöÄ Iniciando processamento de pagamento...');
                        
                        if (!pedidoId) {
                            showToast('Erro: Pedido n√£o encontrado', 'error');
                            setTimeout(redirectToSuccess, 2000);
                            return;
                        }
                        
                        if (!produtoSelecionado || !produtoSelecionado.id) {
                            showToast('Erro: Produto n√£o selecionado', 'error');
                            return;
                        }
                        
                        // Encontrar e desabilitar bot√£o CTA
                        const ctaButtons = document.querySelectorAll('button[onclick*="triggerPurchase"], button[onclick*="processOneClickUpsell"], [data-action="accept"], .btn-accept, .cta-button, button:not([onclick*="handleRefusal"]):not([onclick*="reject"])');
                        let activeButton = null;
                        
                        ctaButtons.forEach(btn => {
                            const text = btn.textContent.toLowerCase();
                            if (text.includes('sim') || text.includes('aceitar') || text.includes('adicionar') || text.includes('pagar') || text.includes('comprar') || text.includes('quero')) {
                                activeButton = btn;
                                btn.disabled = true;
                                btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> Processando...';
                            }
                        });
                        
                        try {
                            // Buscar informa√ß√µes do pedido original
                            const pedidoResponse = await fetch(API_BASE + '/upsell/pedido/' + pedidoId);
                            
                            if (!pedidoResponse.ok) {
                                throw new Error('Erro ao buscar informa√ß√µes do pedido');
                            }
                            
                            const pedidoData = await pedidoResponse.json();
                            
                            if (!pedidoData.success || !pedidoData.pedido) {
                                throw new Error('Pedido n√£o encontrado');
                            }
                            
                            console.log('üì¶ Dados do pedido:', pedidoData.pedido);
                            
                            // Processar pagamento
                            const produtoId = produtoSelecionado.id || produtoSelecionado.produto_id;
                            let valorFinal = valorProduto || parseFloat(produtoSelecionado.preco || 0);
                            
                            // Adicionar valor dos produtos complementares selecionados
                            if (selectedOrderBumpProducts && selectedOrderBumpProducts.length > 0) {
                                const valorComplementares = selectedOrderBumpProducts.reduce((sum, produto) => {
                                    const preco = parseFloat(produto.preco_com_desconto || produto.preco || 0);
                                    return sum + preco;
                                }, 0);
                                valorFinal += valorComplementares;
                                console.log('üí∞ Valor dos complementares:', valorComplementares);
                                console.log('üí∞ Valor total (produto + complementares):', valorFinal);
                            }
                            
                            showToast('Enviando cobran√ßa... Digite o PIN no celular', 'info');
                            
                            // Preparar produtos complementares para envio
                            const produtosComplementares = selectedOrderBumpProducts.map(produto => ({
                                id: produto.id,
                                public_id: produto.public_id,
                                custom_id: produto.custom_id,
                                nome: produto.nome,
                                preco: produto.preco,
                                preco_com_desconto: produto.preco_com_desconto || produto.preco,
                                desconto: produto.desconto || 0,
                                imagem_url: produto.imagem_url || produto.imagem,
                                link_conteudo: produto.link_conteudo || produto.linkConteudo,
                                descricao: produto.descricao,
                                tipo: produto.tipo || 'digital',
                                vendedor_id: produto.vendedor_id
                            }));
                            
                            const upsellResponse = await fetch(API_BASE + '/upsell/processar', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    pedido_id: pedidoId,
                                    produto_id: produtoId,
                                    valor: valorFinal,
                                    produtos_complementares: produtosComplementares
                                })
                            });
                            
                            const upsellResult = await upsellResponse.json();
                            
                            if (upsellResult.success) {
                                if (upsellResult.status === 'approved') {
                                    showToast('Pagamento aprovado!', 'success');
                                    setTimeout(redirectToSuccess, 1500);
                    } else {
                                    showToast('Digite o PIN no seu celular para confirmar!', 'info');
                                    
                                    if (activeButton) {
                                        activeButton.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> Aguardando PIN...';
                                    }
                                    
                                    // Verificar status periodicamente
                                    verificarStatus(upsellResult.transaction_id, 0, activeButton);
                                }
                            } else {
                                throw new Error(upsellResult.message || 'Erro ao processar pagamento');
                            }
                            
                        } catch (error) {
                            console.error('‚ùå Erro no pagamento:', error);
                            showToast('Voc√™ est√° perdendo a melhor oportunidade! Tente novamente.', 'warning');
                            
                            if (activeButton) {
                                activeButton.disabled = false;
                                activeButton.innerHTML = '<i class="fas fa-redo" style="margin-right: 8px;"></i> Tentar Novamente';
                            }
                        }
                    }
                    
                    // Fun√ß√£o para verificar status do pagamento
                    async function verificarStatus(transactionId, tentativas, button) {
                        const maxTentativas = 30;
                        
                        if (tentativas >= maxTentativas) {
                            showToast('Tempo esgotado. Verifique o status na p√°gina de sucesso.', 'warning');
                            setTimeout(redirectToSuccess, 2000);
                            return;
                        }
                        
                        try {
                            const response = await fetch(API_BASE + '/pagamento/status/' + transactionId);
                            const data = await response.json();
                            
                            if (!data.success) {
                                setTimeout(() => verificarStatus(transactionId, tentativas + 1, button), 4000);
                                return;
                            }
                            
                            const status = data.data?.venda?.status || data.data?.status || 'Pendente';
                            
                            if (['Pago', 'Aprovado', 'approved', 'success'].includes(status)) {
                                showToast('Pagamento confirmado!', 'success');
                                setTimeout(redirectToSuccess, 1500);
                            } else if (['Cancelado', 'Falha', 'failed', 'rejected'].includes(status)) {
                                showToast('Voc√™ perdeu a oportunidade! Tente novamente.', 'warning');
                                if (button) {
                                    button.disabled = false;
                                    button.innerHTML = '<i class="fas fa-redo" style="margin-right: 8px;"></i> Tentar Novamente';
                                }
                            } else {
                                setTimeout(() => verificarStatus(transactionId, tentativas + 1, button), 4000);
                            }
                        } catch (error) {
                            setTimeout(() => verificarStatus(transactionId, tentativas + 1, button), 4000);
                        }
                    }
                    
                    // Sobrescrever fun√ß√µes do template
                    window.triggerPurchase = processarPagamentoUpsell;
                    window.processOneClickUpsell = processarPagamentoUpsell;
                    
                    // Fun√ß√£o de recusa
                    window.handleRefusal = function() {
                        if (confirm('Tem certeza? Esta oferta nunca mais aparecer√°!')) {
                            redirectToSuccess();
                        }
                    };
                    
                    // Configurar prote√ß√£o de v√≠deo - SEM AUTOPLAY
                    function protegerVideos() {
                        console.log('üé• Iniciando prote√ß√£o de v√≠deos...');
                        
                        // Adicionar CSS
                        if (!document.getElementById('video-overlay-styles')) {
                            const style = document.createElement('style');
                            style.id = 'video-overlay-styles';
                            style.textContent = \`
                                @keyframes pulse-icon { 
                                    0%, 100% { transform: scale(1); } 
                                    50% { transform: scale(1.1); } 
                                }
                                .video-click-overlay {
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0, 0, 0, 0.4);
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    justify-content: center;
                                    cursor: pointer;
                                    z-index: 100;
                                    transition: background 0.3s;
                                }
                                .video-click-overlay:hover {
                                    background: rgba(0, 0, 0, 0.3);
                                }
                                .video-click-overlay .play-circle {
                                    width: 100px;
                                    height: 100px;
                                    background: linear-gradient(135deg, #f97316, #ea580c);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow: 0 10px 40px rgba(249, 115, 22, 0.6);
                                    animation: pulse-icon 2s infinite;
                                }
                                .video-click-overlay .play-circle::after {
                                    content: '';
                                    width: 0;
                                    height: 0;
                                    border-left: 30px solid white;
                                    border-top: 18px solid transparent;
                                    border-bottom: 18px solid transparent;
                                    margin-left: 8px;
                                }
                                .video-click-overlay .play-label {
                                    margin-top: 20px;
                                    color: white;
                                    font-size: 18px;
                                    font-weight: 700;
                                    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
                                }
                                .video-block-layer {
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    z-index: 50;
                                    background: transparent;
                                }
                            \`;
                            document.head.appendChild(style);
                        }
                        
                        // Proteger v√≠deos HTML5 - SEM AUTOPLAY
                        const videos = document.querySelectorAll('video');
                        console.log('üé• V√≠deos encontrados:', videos.length);
                        
                        videos.forEach((video, index) => {
                            console.log('üé• Configurando v√≠deo', index + 1);
                            
                            const container = video.closest('.video-container-protected') || video.parentElement;
                            container.style.userSelect = 'none';
                            container.style.position = 'relative';
                            
                            // PARAR o v√≠deo (sem autoplay)
                            video.pause();
                            video.autoplay = false;
                            video.controls = false;
                            video.playsInline = true;
                            video.muted = false;
                            video.volume = 1.0;
                            video.loop = false;
                            video.currentTime = 0;
                            video.style.pointerEvents = 'none';
                            
                            try {
                                video.controlsList = 'nodownload nofullscreen noremoteplayback';
                                video.disablePictureInPicture = true;
                            } catch(e) {}
                            
                            // Prote√ß√£o contra seeking
                            let maxTime = 0;
                            video.addEventListener('timeupdate', () => {
                                if (video.currentTime > maxTime) maxTime = video.currentTime;
                            });
                            video.addEventListener('seeking', () => {
                                if (video.currentTime > maxTime + 2) video.currentTime = maxTime;
                                if (video.currentTime < maxTime - 2 && maxTime > 2) video.currentTime = maxTime - 2;
                            });
                            
                            // Remover elementos existentes
                            container.querySelectorAll('.video-click-overlay, .video-block-layer').forEach(el => el.remove());
                            
                            // Criar overlay clic√°vel
                            const overlay = document.createElement('div');
                            overlay.className = 'video-click-overlay';
                            overlay.innerHTML = '<div class="play-circle"></div><span class="play-label">CLIQUE PARA ASSISTIR</span>';
                            overlay.oncontextmenu = (e) => { e.preventDefault(); return false; };
                            
                            // Fun√ß√£o para iniciar v√≠deo
                            const iniciarVideo = () => {
                                console.log('üé• Usu√°rio clicou para iniciar');
                                video.muted = false;
                                video.volume = 1.0;
                                
                                video.play().then(() => {
                                    console.log('‚úÖ V√≠deo iniciado COM SOM');
                                    overlay.remove();
                                    // Adicionar camada de bloqueio
                                    const block = document.createElement('div');
                                    block.className = 'video-block-layer';
                                    block.oncontextmenu = (e) => { e.preventDefault(); return false; };
                                    container.appendChild(block);
                                }).catch((err) => {
                                    console.log('‚ö†Ô∏è Som bloqueado:', err.message);
                                    video.muted = true;
                                    video.play().then(() => {
                                        overlay.innerHTML = '<div class="play-circle" style="background:linear-gradient(135deg,#22c55e,#16a34a);"><span style="font-size:40px;">üîä</span></div><span class="play-label">CLIQUE PARA ATIVAR O SOM</span>';
                                        overlay.style.background = 'rgba(0,0,0,0.2)';
                                        overlay.onclick = () => {
                                            video.muted = false;
                                            video.volume = 1.0;
                                            overlay.remove();
                                            const block = document.createElement('div');
                                            block.className = 'video-block-layer';
                                            container.appendChild(block);
                                        };
                                    });
                                });
                            };
                            
                            overlay.onclick = iniciarVideo;
                            container.appendChild(overlay);
                        });
                        
                        // Proteger iframes (YouTube, Vimeo)
                        const iframes = document.querySelectorAll('iframe');
                        console.log('üé• Iframes encontrados:', iframes.length);
                        
                        iframes.forEach((iframe, index) => {
                            iframe.style.pointerEvents = 'none';
                            
                            if (!iframe.allow || !iframe.allow.includes('autoplay')) {
                                iframe.allow = 'autoplay; encrypted-media; fullscreen';
                            }
                            
                            let src = iframe.src || '';
                            if (src.includes('youtube.com') && !src.includes('autoplay=1')) {
                                src += (src.includes('?') ? '&' : '?') + 'autoplay=1&mute=1';
                                iframe.src = src;
                            }
                            if (src.includes('vimeo.com') && !src.includes('autoplay=1')) {
                                src += (src.includes('?') ? '&' : '?') + 'autoplay=1&muted=1';
                                iframe.src = src;
                            }
                            
                            console.log('‚úÖ Iframe', index + 1, 'configurado');
                        });
                        
                        // Bloquear teclas de controle
                        document.addEventListener('keydown', (e) => {
                            if (['Space', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'KeyK', 'KeyJ', 'KeyL', 'KeyM', 'KeyF'].includes(e.code)) {
                                e.preventDefault();
                                e.stopPropagation();
                            }
                        });
                        
                        // Bloquear menu de contexto globalmente em v√≠deos
                        document.addEventListener('contextmenu', (e) => {
                            if (e.target.closest('.video-container-protected') || e.target.tagName === 'VIDEO' || e.target.tagName === 'IFRAME') {
                                e.preventDefault();
                                return false;
                            }
                        });
                        
                        console.log('‚úÖ Prote√ß√£o de v√≠deos configurada');
                    }
                    
                    // Fun√ß√£o para vincular bot√µes CTA automaticamente
                    function vincularBotoesCTA() {
                        console.log('üîó Vinculando bot√µes CTA...');
                        
                        // Buscar todos os bot√µes
                        const todosBotoes = document.querySelectorAll('button, a.btn, .btn, [role="button"]');
                        let ctaVinculados = 0;
                        let recusaVinculados = 0;
                        
                        todosBotoes.forEach(btn => {
                            const texto = (btn.textContent || '').toLowerCase().trim();
                            const classe = (btn.className || '').toLowerCase();
                            const onclick = (btn.getAttribute('onclick') || '').toLowerCase();
                            
                            // Verificar se j√° tem handler via onclick
                            const temOnclickTrigger = onclick.includes('triggerpurchase') || onclick.includes('processoneclickupsell');
                            const temOnclickRefusal = onclick.includes('handlerefusal');
                            
                            // Palavras-chave para identificar bot√µes
                            const palavrasAceitar = ['sim', 'aceitar', 'adicionar', 'comprar', 'quero', 'pagar', 'adquirir', 'yes', 'buy', 'accept', 'add', 'obter'];
                            const palavrasRecusar = ['n√£o', 'recusar', 'no', 'decline', 'reject', 'fechar', 'close', 'obrigado'];
                            
                            const ehBotaoAceitar = temOnclickTrigger || 
                                                  palavrasAceitar.some(p => texto.includes(p)) || 
                                                  classe.includes('accept') || 
                                                  classe.includes('btn-cta') ||
                                                  classe.includes('gradient-orange');
                            
                            const ehBotaoRecusar = temOnclickRefusal ||
                                                  (palavrasRecusar.some(p => texto.includes(p)) && !ehBotaoAceitar);
                            
                            // N√£o duplicar handlers
                            if (btn.dataset.upsellBound) return;
                            
                            if (ehBotaoAceitar) {
                                btn.dataset.upsellBound = 'true';
                                // Remover onclick existente e adicionar novo handler
                                btn.removeAttribute('onclick');
                                btn.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('üõí Bot√£o CTA clicado!');
                                    processarPagamentoUpsell();
                                });
                                ctaVinculados++;
                                console.log('üîó Bot√£o CTA vinculado:', texto.substring(0, 40));
                            } else if (ehBotaoRecusar) {
                                btn.dataset.upsellBound = 'true';
                                btn.removeAttribute('onclick');
                                btn.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('‚ùå Bot√£o de recusa clicado!');
                                    window.handleRefusal();
                                });
                                recusaVinculados++;
                                console.log('üîó Bot√£o recusa vinculado:', texto.substring(0, 40));
                            }
                        });
                        
                        console.log('‚úÖ Bot√µes vinculados - CTA:', ctaVinculados, ', Recusa:', recusaVinculados);
                    }
                    
                    // Inicializar tudo
                    function inicializarSistema() {
                        console.log('üöÄ Inicializando sistema de upsell...');
                        protegerVideos();
                        vincularBotoesCTA();
                        console.log('‚úÖ Sistema de pagamento e prote√ß√£o de v√≠deo configurado');
                    }
                    
                    // Executar quando DOM estiver pronto
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', () => setTimeout(inicializarSistema, 300));
                    } else {
                        setTimeout(inicializarSistema, 300);
                    }
                })();
            `;
            document.body.appendChild(script);
        }

        // Fun√ß√£o para carregar informa√ß√µes do cliente e exibir
        async function carregarInfoCliente() {
            if (!pedido) {
                console.log('‚ö†Ô∏è Pedido n√£o encontrado na URL');
                return null;
            }

            try {
                const response = await fetch(`${API_BASE}/upsell/pedido/${pedido}`);
                if (!response.ok) {
                    throw new Error('Erro ao buscar informa√ß√µes do pedido');
                }

                const data = await response.json();
                if (!data.success || !data.pedido) {
                    throw new Error('Pedido n√£o encontrado');
                }

                const pedidoInfo = data.pedido;
                console.log('üì¶ Dados do cliente carregados:', pedidoInfo);

                // Armazenar informa√ß√µes do cliente globalmente
                window.clienteInfo = {
                    nome: pedidoInfo.cliente?.nome || clientName || 'Cliente',
                    telefone: pedidoInfo.cliente?.telefone || '',
                    metodoPagamento: pedidoInfo.pagamento?.metodo || 'mpesa'
                };

                return pedidoInfo;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar info do cliente:', error);
                return null;
            }
        }

        // Fun√ß√£o para exibir informa√ß√µes do cliente e produto
        function exibirInfoClienteProduto(clienteData, produto) {
            const clienteInfoDiv = document.getElementById('clienteInfo');
            const clienteNome = document.getElementById('clienteNome');
            const clienteTelefone = document.getElementById('clienteTelefone');
            const produtoValor = document.getElementById('produtoValor');

            if (clienteInfoDiv && produto) {
                const nome = clienteData?.cliente?.nome || window.clienteInfo?.nome || clientName || 'Cliente';
                const telefone = clienteData?.cliente?.telefone || window.clienteInfo?.telefone || '';
                const valor = produto.preco ? parseFloat(produto.preco).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'}) : 'N/A';

                if (clienteNome) clienteNome.textContent = nome;
                if (clienteTelefone) clienteTelefone.textContent = telefone || '(telefone do checkout)';
                if (produtoValor) produtoValor.textContent = valor;

                clienteInfoDiv.style.display = 'block';

                console.log('‚úÖ Info do cliente exibida:', { nome, telefone, valor });
            }
        }

        // Event listeners
        document.getElementById('btnAccept')?.addEventListener('click', processOneClickUpsell);
        document.getElementById('btnReject')?.addEventListener('click', redirectToSuccess);

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', async () => {
            // Carregar info do cliente em paralelo com a p√°gina de upsell
            const clientePromise = carregarInfoCliente();
            
            // Carregar p√°gina de upsell
            await loadUpsellPage();
            
            // Ap√≥s carregar, exibir info do cliente se dispon√≠vel
            const clienteData = await clientePromise;
            if (selectedProduct) {
                exibirInfoClienteProduto(clienteData, selectedProduct);
            }
        });
    </script>
</body>
</html>
