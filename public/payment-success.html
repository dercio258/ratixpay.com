<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento Aprovado - RatixPay</title>
    <link rel="icon" type="image/png" href="/assets/images/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <!-- Meta Pixel - Inicializa√ß√£o Direta e Simples -->
    <script>
        // Carregar script base do Meta Pixel
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        
        // Fun√ß√£o para buscar e inicializar Meta Pixel
        async function inicializarMetaPixel() {
            try {
                // Obter ID do produto da URL ou localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const produtoId = urlParams.get('produto') || urlParams.get('productId') || localStorage.getItem('currentProductId');
                
                if (!produtoId) {
                    console.log('‚ÑπÔ∏è Meta Pixel: Nenhum produto identificado');
                    return;
                }
                
                // Buscar produto na API
                const API_BASE = window.location.origin + '/api';
                const response = await fetch(`${API_BASE}/produtos/public/${produtoId}`);
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Meta Pixel: Falha ao carregar produto');
                    return;
                }
                
                const produto = await response.json();
                
                if (!produto.pixel_id || !/^\d{15,16}$/.test(produto.pixel_id)) {
                    console.log('‚ÑπÔ∏è Meta Pixel: Produto n√£o possui pixel_id v√°lido');
                    return;
                }
                
                const pixelId = produto.pixel_id;
                const pixelEvents = produto.pixel_events || ['Purchase', 'ViewContent', 'AddToCart', 'InitiateCheckout', 'Lead'];
                
                console.log('‚úÖ Meta Pixel: Inicializando com ID:', pixelId);
                
                // Inicializar pixel
                fbq('init', pixelId);
                fbq('track', 'PageView');
                
                // Disparar Purchase na p√°gina de sucesso
                if (window.location.pathname.includes('payment-success')) {
                    // Obter dados do pedido
                    const pedido = urlParams.get('pedido') || urlParams.get('idpedido');
                    const valor = parseFloat(urlParams.get('amount') || urlParams.get('valor') || '0');
                    
                    // Tentar obter do orderData se dispon√≠vel
                    let orderValue = valor;
                    if (typeof orderData !== 'undefined' && orderData) {
                        orderValue = parseFloat(orderData.valor || orderData.pagamento?.valor || valor);
            }
                    
                    if (orderValue > 0 && pixelEvents.includes('Purchase')) {
                        fbq('track', 'Purchase', {
                            value: orderValue,
                            currency: 'MZN',
                            content_ids: [produto.id],
                            content_name: produto.nome
                        });
                        console.log('‚úÖ Meta Pixel: Purchase disparado - Valor:', orderValue);
                    }
            }
            
                // Atualizar noscript
            const noscriptElement = document.getElementById('fb-pixel-noscript');
            if (noscriptElement) {
                const img = noscriptElement.querySelector('img');
                if (img) {
                    img.src = `https://www.facebook.com/tr?id=${pixelId}&ev=PageView&noscript=1`;
                }
            }
            
            } catch (error) {
                console.error('‚ùå Meta Pixel: Erro ao inicializar:', error);
            }
        }
        
        // Inicializar quando a p√°gina carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarMetaPixel);
        } else {
            inicializarMetaPixel();
        }
    </script>
    
    <!-- Noscript para Meta Pixel - Ser√° atualizado dinamicamente -->
    <noscript id="fb-pixel-noscript">
        <img height="1" width="1" style="display:none"
             src="https://www.facebook.com/tr?id=PLACEHOLDER&ev=PageView&noscript=1"/>
    </noscript>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b3540 0%, #f7931e6b 50%, #ff6b3540 100%);
            background-size: 200% 200%;
            animation: gradientShift 8s ease-in-out infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .success-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 500px;
            position: relative;
            border: 2px solid #F64c00;
            margin: 0 auto;
        }
        
        .success-header {
            background: #F64C00;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .logo {
            margin-bottom: 20px;
        }

        .logo img {
            max-width: 240px;
            height: auto;
            filter: brightness(0) invert(1);
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #4CAF50;
            animation: bounceIn 0.8s ease-out;
        }

        .success-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .footer-logo {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .footer-logo img {
            max-width: 200px;
            height: auto;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(180deg); }
        }

        .success-message {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .success-content {
            padding: 30px;
        }
        
        .product-info {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .product-details h5 {
            margin: 0;
            color: #333;
            font-weight: 600;
        }
        
        .transaction-info {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .transaction-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #28a745;
        }
        
        .transaction-date {
            border-top: 1px solid #c3e6cb;
            padding-top: 15px;
        }
        
        .transaction-date h6 {
            color: #28a745;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .transaction-date-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #28a745;
            font-size: 14px;
        }
        
        .transaction-actions {
            border-top: 1px solid #c3e6cb;
            padding-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-copy, .btn-share {
            background: #f64c00;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }
        
        .btn-copy:hover, .btn-share:hover {
            background: rgba(246, 76, 0, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(246, 76, 0, 0.3);
        }
        
        .btn-copy:active, .btn-share:active {
            transform: translateY(0);
        }
        
        .btn-copy.copied {
            background: rgba(246, 76, 0, 0.8);
        }
        
        .btn-share.shared {
            background: rgba(246, 76, 0, 0.8);
        }
        
        .contact-info {
            background: #f0f8ff;
            border: 1px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .contact-item:last-child {
            margin-bottom: 0;
        }
        
        .contact-icon {
            width: 30px;
            color: #007bff;
            margin-right: 10px;
        }
        
        .contact-link {
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s;
            display: inline-block;
        }
        
        .contact-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        
        .btn-download {
            background: #f64c00;
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .btn-download:hover {
            background: rgba(246, 76, 0, 0.8);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(246, 76, 0, 0.3);
        }
        
        /* Estilos espec√≠ficos para produtos complementares */
        .complementar-product {
            border-left: 4px solid #f59e0b !important;
            position: relative;
        }
        
        .complementar-product::before {
            content: "BONUS";
            position: absolute;
            top: -8px;
            right: 15px;
            background: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 1;
        }
        
        .complementar-product .product-image {
            border: 2px solid #f59e0b;
        }
        
        .complementar-product .btn-download {
            background: #f59e0b !important;
        }
        
        .complementar-product .btn-download:hover {
            background: rgba(245, 158, 11, 0.8) !important;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3) !important;
        }
        
        /* Responsividade para produtos complementares */
        @media (max-width: 768px) {
            .complementar-product {
                padding: 12px !important;
            }
            
            .complementar-product .product-image {
                width: 60px !important;
                height: 60px !important;
                margin-right: 12px !important;
            }
            
            .complementar-product .product-details h5 {
                font-size: 0.95rem !important;
            }
            
            .complementar-product .btn-download {
                padding: 6px 12px !important;
                font-size: 0.8rem !important;
                width: 100% !important;
                text-align: center !important;
                margin-bottom: 8px !important;
            }
        }
        
        @media (max-width: 480px) {
            .complementar-product .btn-download {
                padding: 5px 10px !important;
                font-size: 0.75rem !important;
                width: 100% !important;
                text-align: center !important;
                margin-bottom: 6px !important;
            }
            
            .complementar-product .product-details h5 {
                font-size: 0.85rem !important;
            }
        }
        
        /* Estilos para m√∫ltiplos product-info */
        .principal-product {
            border-left: 4px solid #28a745 !important;
            position: relative;
        }
        
        .principal-product::before {
            content: "PRINCIPAL";
            position: absolute;
            top: -8px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 1;
        }
        
        .principal-product .product-image {
            border: 2px solid #28a745;
        }
        
        .principal-product .btn-download {
            background: #28a745 !important;
        }
        
        .principal-product .btn-download:hover {
            background: rgba(40, 167, 69, 0.8) !important;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
        }
        
        /* Responsividade para m√∫ltiplos product-info */
        @media (max-width: 768px) {
            .principal-product {
                padding: 12px !important;
            }
            
            .principal-product .product-image {
                width: 60px !important;
                height: 60px !important;
                margin-right: 12px !important;
            }
            
            .principal-product .product-details h5 {
                font-size: 0.95rem !important;
            }
            
            .principal-product .btn-download {
                padding: 12px 20px !important;
                font-size: 0.9rem !important;
            }
        }
        
        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 15px;
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .btn-whatsapp:hover {
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }
        
        .btn-email {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 15px;
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .btn-email:hover {
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }
        
        .btn-support {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .btn-support:hover {
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        /* WhatsApp Options */
        .whatsapp-section {
            margin-bottom: 20px;
        }
        
        .whatsapp-options {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-select, .form-control {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* Radio Buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-option:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #25d366;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"]:checked + label {
            color: #25d366;
            font-weight: 600;
        }
        
        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            transition: color 0.3s ease;
        }
        
        .radio-option:has(input[type="radio"]:checked) {
            background: #e8f5e8;
            border-color: #25d366;
        }
        
        /* Bot√£o de Suporte Flutuante */
        .support-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f64c00 0%, #ff6b35 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(246, 76, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            animation: float 3s ease-in-out infinite;
        }
        
        .support-button img {
            width: 64px;
            height: 64px;
            filter: brightness(0) invert(1);
        }
        
        .support-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(246, 76, 0, 0.4);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Chat de Suporte */
        .support-chat {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .support-chat.active {
            display: flex;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #f64c00 0%, #ff6b35 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 20px 20px 0 0;
        }
        
        .chat-title {
            font-weight: 700;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 450px;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 15px 18px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .message.support {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            margin-left: 0;
            border-bottom-left-radius: 8px;
        }
        
        .message.user {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            margin-left: auto;
            border-bottom-right-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .message strong {
            font-weight: 700;
        }
        
        .message-header {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .message-content {
            font-size: 14px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 18px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 20px;
            margin-left: 0;
            margin-right: auto;
            max-width: 85%;
            border-bottom-left-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Ocultar mensagens com spinner */
        .message:has(.fa-spinner) {
            display: none !important;
        }
        
        /* Fallback para navegadores que n√£o suportam :has() */
        .message .fa-spinner {
            display: none !important;
        }
        
        /* Ocultar mensagens que cont√™m spinner */
        .message:has(.fa-spinner),
        .message .fa-spinner {
            display: none !important;
        }
        
        /* Scroll autom√°tico no hover */
        .chat-messages:hover {
            scroll-behavior: smooth;
        }
        
        /* Melhorar scroll autom√°tico */
        .chat-messages {
            scroll-behavior: smooth;
        }
        
        /* Auto-scroll quando nova mensagem √© adicionada */
        .message:last-child {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-options {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 15px 15px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 25px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }
        
        .chat-input-container:focus-within {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-size: 14px;
            line-height: 1.4;
            max-height: 100px;
            min-height: 40px;
            padding: 8px 0;
            overflow-y: hidden;
        }
        
        .chat-input::placeholder {
            color: #6c757d;
        }
        
        .chat-send-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }
        
        .chat-send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .support-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .support-option {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 12px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            line-height: 1.3;
        }
        
        .support-option:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .support-option.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .support-details {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .support-details textarea {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            font-size: 14px;
            line-height: 1.4;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }
        
        .support-details textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .btn-send-support {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 25px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        
        .btn-send-support:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-send-support:active {
            transform: translateY(0);
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .support-chat {
                width: 95vw;
                height: 75vh;
                right: 2.5vw;
                bottom: 90px;
                border-radius: 15px;
            }
            
            .chat-header {
                padding: 18px 20px;
                border-radius: 15px 15px 0 0;
            }
            
            .chat-title {
                font-size: 16px;
            }
            
            .chat-messages {
                padding: 15px;
                max-height: 300px;
            }
            
            .chat-options {
                padding: 15px;
            }
            
            .chat-input-container {
                padding: 12px;
            }
            
            .chat-send-btn {
                width: 36px;
                height: 36px;
            }
            
            .message {
                max-width: 90%;
                font-size: 13px;
                padding: 12px 15px;
            }
            
            .support-options {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .support-option {
                padding: 14px 16px;
                font-size: 14px;
            }
            
            .support-button {
                bottom: 20px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 22px;
            }
            
            .transaction-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn-copy, .btn-share {
                min-width: auto;
                width: 100%;
            }
        }
        
        .support-option {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .support-option:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .support-option.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .support-details {
            margin-top: 15px;
        }
        
        .btn-send-support {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-send-support:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        


        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>

    <!-- Sistema de Autentica√ß√£o Global -->
    <script src="/js/server-check.js"></script>
    <script src="/js/global-auth.js"></script>

    
    
    
    

</head>
<body>
    <div class="container">
    <div class="success-container">
            <div class="success-header">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="success-title">Venda Aprovada</div>
                <div class="success-message" id="successMessage">
                    Oi! <span id="customerName">Cliente</span>. A sua compra foi feita com sucesso.
                </div>
        </div>

            <div class="success-content">
                <!-- Loading state -->
                <div id="loadingState" class="loading">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Carregando...</span>
            </div>
                    <p class="mt-3">Carregando informa√ß√µes da compra...</p>
            </div>
                
                <!-- Content state -->
                <div id="contentState" style="display: none;">
                    <!-- Transaction ID -->
                    <div class="transaction-info">
                        <h6><i class="fas fa-receipt me-2"></i>ID da Transa√ß√£o</h6>
                        <div class="transaction-id" id="transactionId">-</div>
                        
                        <!-- Data da Compra -->
                        <div class="transaction-date mt-3">
                            <h6><i class="fas fa-calendar-alt me-2"></i>Data da Compra</h6>
                            <div class="transaction-date-value" id="transactionDate">-</div>
                        </div>
                        
                        <!-- Bot√µes de A√ß√£o -->
                        <div class="transaction-actions mt-3">
                            <button class="btn-copy" onclick="copyReceiptLink()" title="Copiar Link do Comprovativo">
                                <i class="fas fa-link me-2"></i>Copiar Link
                            </button>
                            <button class="btn-share" onclick="shareReceipt()" title="Compartilhar Comprovativo">
                                <i class="fas fa-share-alt me-2"></i>Compartilhar
                            </button>
                        </div>
            </div>
                    
                    <!-- Products Info (principal + complementares) -->
                    <div id="productsContainer">
                        <div class="product-info" id="principalInfo">
                            <img id="productImage" class="product-image" src="" alt="Produto">
                            <div class="product-details">
                                <h5 id="productName">Produto</h5>
                                <div class="product-price" id="productPrice" style="color: #28a745; font-weight: bold; font-size: 1.1rem; margin-top: 5px;">
                                    MZN 0,00
                                </div>
                                <div class="mt-3">
                                    <a href="#" id="downloadBtn" class="btn-download">
                                        <i class="fas fa-download me-2"></i>Baixar Conte√∫do
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div id="orderBumpList"></div>
                    </div>

                                        <!-- Contact Info -->
                    <div class="contact-info">
                        <h6><i class="fas fa-user-tie me-2"></i><span id="contactTitle">Informa√ß√µes do Vendedor</span></h6>
                        
                        <div class="contact-item" style="margin-bottom: 15px;">
                            <i class="fas fa-user contact-icon"></i>
                            <span id="vendedorNome" style="font-weight: bold; color: #333;">Nome do Vendedor</span>
                        </div>
                        
                        <div class="contact-item">
                            <i class="fab fa-whatsapp contact-icon"></i>
                            <a href="#" id="vendedorWhatsappLink" class="contact-link">
                                <span id="vendedorWhatsapp">WhatsApp do vendedor</span>
                            </a>
                        </div>
                        
                        <div class="contact-item">
                            <i class="fas fa-envelope contact-icon"></i>
                            <a href="#" id="vendedorEmailLink" class="contact-link">
                                <span id="vendedorEmail">Email do vendedor</span>
                            </a>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center">
                        <div class="mt-3">
                            <p class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                O conte√∫do tamb√©m foi enviado automaticamente para seu email e WhatsApp
                            </p>
                        </div>
                    </div>
        </div>
            </div>
        </div>
    </div>
    
                    <!-- Notification Container -->
        <div id="notificationContainer"></div>
        
        <!-- Bot√£o de Suporte Flutuante -->
        <div id="supportButton" class="support-button" onclick="toggleSupportChat()">
            <img src="/assets/images/external/support-icon.png" alt="Suporte">
        </div>
        
        <!-- Chat de Suporte -->
        <div id="supportChat" class="support-chat">
            <div class="chat-header">
                <div class="chat-title">
                    <img src="/assets/images/external/support-icon.png" alt="Suporte" style="width: 48px; height: 48px; margin-right: 8px; filter: brightness(0) invert(1);">
                    Suporte RatixPay
                </div>
                <button class="chat-close" onclick="toggleSupportChat()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Mensagens ser√£o inseridas aqui -->
            </div>
            
            <div class="chat-options" id="chatOptions">
                <!-- Options will be dynamically loaded here -->
            </div>
            
            <!-- Chat Input Container (hidden by default) -->
            <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                <textarea class="chat-input" id="chatInput" placeholder="Digite sua mensagem..." rows="1"></textarea>
                <button class="chat-send-btn" id="chatSendBtn" onclick="enviarMensagem()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // API Base URL
        const API_BASE = window.API_BASE || window.location.origin + '/api';
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const pedidoNumero = urlParams.get('pedido');
        const idPedido = urlParams.get('idpedido');
        const productId = urlParams.get('productId');
        const clientName = urlParams.get('clientName');
        const amount = urlParams.get('amount');
        
        // Capturar par√¢metros UTM da URL e salvar no localStorage (se ainda n√£o estiverem salvos)
        // Isso garante que os par√¢metros UTM sejam preservados mesmo se vierem da URL
        try {
            const utmParamsFromUrl = {
                utm_source: urlParams.get('utm_source'),
                utm_medium: urlParams.get('utm_medium'),
                utm_campaign: urlParams.get('utm_campaign'),
                utm_content: urlParams.get('utm_content'),
                utm_term: urlParams.get('utm_term'),
                src: urlParams.get('src'),
                sck: urlParams.get('sck')
            };
            
            // Verificar se h√° par√¢metros UTM na URL
            const hasUtmInUrl = Object.values(utmParamsFromUrl).some(v => v !== null);
            
            if (hasUtmInUrl) {
                // Salvar no localStorage para garantir persist√™ncia
                localStorage.setItem('utm_tracking_params', JSON.stringify(utmParamsFromUrl));
                console.log('‚úÖ Par√¢metros UTM capturados da URL e salvos no localStorage:', utmParamsFromUrl);
            } else {
                // Tentar carregar do localStorage se n√£o estiverem na URL
                const savedUtmParams = localStorage.getItem('utm_tracking_params');
                if (savedUtmParams) {
                    console.log('‚ÑπÔ∏è Par√¢metros UTM carregados do localStorage:', JSON.parse(savedUtmParams));
                }
            }
        } catch (error) {
            console.error('‚ùå Erro ao processar par√¢metros UTM:', error);
        }
        
        // Verificar se √© produto premium
        const isPremiumProduct = productId === 'V7XZPKGEF' || window.location.href.includes('V7XZPKGEF');
        
        // Log para debug
        console.log('üîç Par√¢metros da URL:', {
            pedido: pedidoNumero,
            idpedido: idPedido,
            productId: productId,
            clientName: clientName,
            amount: amount,
            urlCompleta: window.location.href
        });
        
        // Validar acesso seguro
        function validarAcessoSeguro() {
            if (!pedidoNumero && !idPedido) {
                console.log('‚ùå Par√¢metros de acesso inv√°lidos');
                showErrorState('Acesso negado. Link inv√°lido ou expirado.');
                return false;
            }
            
            console.log('‚úÖ Par√¢metros de acesso v√°lidos');
            return true;
        }

        // Fun√ß√£o para enviar venda para UTMify
        async function enviarVendaParaUTMify(vendaId, produtoId, orderData) {
            try {
                // Normalizar vendaId para garantir consist√™ncia
                const vendaIdNormalizado = String(vendaId || '').trim();
                
                if (!vendaIdNormalizado) {
                    console.error('‚ùå UTMIFY: vendaId n√£o fornecido ou inv√°lido');
                    return;
                }
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üöÄ UTMIFY: Iniciando verifica√ß√£o de envio');
                console.log('üì¶ Venda ID (original):', vendaId);
                console.log('üì¶ Venda ID (normalizado):', vendaIdNormalizado);
                console.log('üì¶ Produto ID:', produtoId);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // Verificar se j√° foi enviado - se sim, n√£o tentar novamente
                if (orderData && orderData.tracking_data && orderData.tracking_data.utmfy_enviado === true) {
                    console.log('‚úÖ UTMIFY: Venda j√° foi enviada anteriormente.');
                    console.log('üìÖ Data do envio:', orderData.tracking_data.utmfy_enviado_em);
                    console.log('‚ÑπÔ∏è UTMIFY: N√£o tentando enviar novamente - j√° foi processado.');
                    return; // N√£o tentar enviar se j√° foi enviado
                }
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üöÄ UTMIFY: Enviando requisi√ß√£o para backend');
                console.log('üì¶ Venda ID:', vendaIdNormalizado);
                console.log('üì¶ Produto ID:', produtoId);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // Usar API_BASE j√° definido no escopo global
                const API_BASE_UTMIFY = API_BASE || window.API_BASE || window.location.origin + '/api';
                
                // Buscar produto para obter token UTMify
                const produtoResponse = await fetch(`${API_BASE_UTMIFY}/produtos/public/${produtoId}`);
                if (!produtoResponse.ok) {
                    console.warn('‚ö†Ô∏è UTMIFY: Falha ao buscar produto - Status:', produtoResponse.status);
                    console.warn('‚ö†Ô∏è UTMIFY: URL tentada:', `${API_BASE_UTMIFY}/produtos/public/${produtoId}`);
                    return;
                }
                
                const produtoData = await produtoResponse.json();
                const produto = produtoData.produto || produtoData;
                
                // Verificar se produto tem token UTMify configurado
                if (!produto.utmfy_api_key || !produto.utmfy_active) {
                    console.log('‚ÑπÔ∏è UTMIFY: Produto n√£o possui token UTMify configurado ou n√£o est√° ativo');
                    console.log('‚ÑπÔ∏è UTMIFY: utmfy_api_key:', produto.utmfy_api_key ? 'existe' : 'n√£o existe');
                    console.log('‚ÑπÔ∏è UTMIFY: utmfy_active:', produto.utmfy_active);
                    return;
                }
                
                console.log('‚úÖ UTMIFY: Token encontrado, enviando venda para backend...');
                
                // Buscar par√¢metros UTM salvos na venda (tracking_data)
                let trackingParams = {
                    utm_source: null,
                    utm_medium: null,
                    utm_campaign: null,
                    utm_content: null,
                    utm_term: null,
                    src: null,
                    sck: null,
                    ip: null
                };
                
                // Tentar obter tracking_data da venda (orderData)
                console.log('üîç UTMIFY: Verificando orderData:', {
                    hasOrderData: !!orderData,
                    hasTrackingData: !!(orderData && orderData.tracking_data),
                    trackingData: orderData?.tracking_data
                });
                
                if (orderData && orderData.tracking_data) {
                    trackingParams = {
                        utm_source: orderData.tracking_data.utm_source || null,
                        utm_medium: orderData.tracking_data.utm_medium || null,
                        utm_campaign: orderData.tracking_data.utm_campaign || null,
                        utm_content: orderData.tracking_data.utm_content || null,
                        utm_term: orderData.tracking_data.utm_term || null,
                        src: orderData.tracking_data.src || null,
                        sck: orderData.tracking_data.sck || null,
                        ip: null // IP n√£o dispon√≠vel no frontend
                    };
                    console.log('‚úÖ UTMIFY: Par√¢metros UTM carregados da venda (tracking_data):', trackingParams);
                } else {
                    // Fallback: tentar capturar da URL
                    const urlParamsUtm = new URLSearchParams(window.location.search);
                    trackingParams = {
                        utm_source: urlParamsUtm.get('utm_source') || null,
                        utm_medium: urlParamsUtm.get('utm_medium') || null,
                        utm_campaign: urlParamsUtm.get('utm_campaign') || null,
                        utm_content: urlParamsUtm.get('utm_content') || null,
                        utm_term: urlParamsUtm.get('utm_term') || null,
                        src: urlParamsUtm.get('src') || null,
                        sck: urlParamsUtm.get('sck') || null,
                        ip: null
                    };
                    console.log('‚ÑπÔ∏è UTMIFY: Usando par√¢metros UTM da URL (fallback):', trackingParams);
                    if (!orderData) {
                        console.warn('‚ö†Ô∏è UTMIFY: orderData n√£o foi fornecido!');
                    } else if (!orderData.tracking_data) {
                        console.warn('‚ö†Ô∏è UTMIFY: orderData n√£o cont√©m tracking_data!');
                    }
                }
                
                // Enviar para o backend processar (API_BASE_UTMIFY j√° inclui /api)
                // Sempre tenta enviar - sem restri√ß√µes
                const utmifyResponse = await fetch(`${API_BASE_UTMIFY}/pagamento/venda/${vendaId}/utmify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        produtoId: produtoId,
                        trackingParams: trackingParams
                    })
                });
                
                // Verificar se a resposta √© v√°lida
                if (!utmifyResponse.ok) {
                    console.error(`‚ùå UTMIFY: Erro HTTP ${utmifyResponse.status} ao enviar venda`);
                    try {
                        const errorData = await utmifyResponse.json();
                        console.error('‚ùå UTMIFY: Detalhes do erro:', errorData);
                    } catch (e) {
                        console.error('‚ùå UTMIFY: N√£o foi poss√≠vel ler resposta de erro');
                    }
                    return;
                }
                
                const utmifyResult = await utmifyResponse.json();
                
                if (utmifyResult.success) {
                    console.log('‚úÖ UTMIFY: Venda enviada com SUCESSO!');
                    console.log('üì¶ Resposta:', utmifyResult);
                } else if (utmifyResult.skipped) {
                    const reason = utmifyResult.reason || utmifyResult.message || 'raz√£o n√£o especificada';
                    console.log(`‚ö†Ô∏è UTMIFY: Envio pulado pelo servi√ßo - ${reason}`);
                } else {
                    console.error('‚ùå UTMIFY: Erro ao enviar venda:', utmifyResult.error || utmifyResult.message);
                    // Permite tentar novamente se houver erro
                }
                
            } catch (error) {
                console.error('‚ùå UTMIFY: Erro ao processar envio:', error);
            }
        }
        
        // Load transaction data
        async function loadTransactionData() {
            try {
                // Validar acesso seguro primeiro
                if (!validarAcessoSeguro()) {
                    return;
                }
                
                console.log('üîç Carregando dados do pedido:', pedidoNumero);
                
                // Buscar dados do pedido usando o ID (API_BASE j√° inclui /api)
                const response = await fetch(`${API_BASE}/success/venda/${pedidoNumero}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Dados carregados do endpoint /api/success/venda:', data);
                    console.log('üìä Tracking Data recebido:', data.data?.tracking_data);
                    
                    // Verificar se a resposta tem sucesso
                    if (!data.success) {
                        console.error('‚ùå Resposta do servidor indica erro:', data.message);
                        showErrorState(data.message || 'Erro ao carregar dados do pedido.');
                        return;
                    }
                    
                    displayTransactionData(data.data);
                    
                    // Tentar enviar para UTMify apenas se ainda n√£o foi enviado
                    // O envio principal acontece quando a PayMoz responde
                    const produtoId = urlParams.get('productId') || urlParams.get('produto') || data.data?.produto?.id;
                    if (produtoId && pedidoNumero) {
                        const trackingData = data.data?.tracking_data || {};
                        if (trackingData.utmfy_enviado === true) {
                            console.log('‚úÖ UTMIFY: Venda j√° foi enviada automaticamente durante o processamento.');
                            console.log('üìÖ Data do envio:', trackingData.utmfy_enviado_em);
                            // N√£o tentar enviar novamente se j√° foi enviado
                        } else {
                            console.log('‚ö†Ô∏è UTMIFY: Venda ainda n√£o foi enviada. Tentando enviar agora como fallback...');
                            // Apenas uma tentativa se n√£o foi enviado ainda
                        enviarVendaParaUTMify(pedidoNumero, produtoId, data.data).catch(error => {
                            console.error('‚ùå UTMIFY: Erro ao enviar venda:', error);
                        });
                        }
                    } else {
                        console.warn('‚ö†Ô∏è UTMIFY: N√£o foi poss√≠vel enviar - produtoId ou pedidoNumero ausente', {
                            produtoId: produtoId,
                            pedidoNumero: pedidoNumero
                        });
                    }
                    
                    // Mostrar chave de desbloqueio se for produto premium
                    if (isPremiumProduct) {
                        showPremiumUnlockKey();
                    }
                    
                    // Usar produtos complementares que v√™m do endpoint principal
                    if (data.data.produtosComplementares && data.data.produtosComplementares.length > 0) {
                        console.log('üì¶ Produtos complementares encontrados no endpoint principal:', data.data.produtosComplementares);
                        data.data.produtosComplementares.forEach((produtoComplementar, index) => {
                            console.log(`üîç Criando product-info para produto complementar ${index + 1}:`, produtoComplementar);
                            console.log(`üîó Link do conte√∫do: ${produtoComplementar.link_conteudo}`);
                            criarProductInfoComplementar(produtoComplementar, index);
                        });
                        console.log('‚úÖ Produtos complementares carregados do endpoint principal');
                    } else {
                        console.log('‚ÑπÔ∏è Nenhum produto complementar encontrado no endpoint principal');
                    }
                } else {
                    // Tentar obter mensagem de erro mais espec√≠fica
                    let errorMessage = 'Pedido n√£o encontrado. Verifique se o link est√° correto.';
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        // Ignorar erro ao parsear JSON
                    }
                    
                    console.log(`‚ö†Ô∏è Endpoint /success/venda retornou ${response.status}, tentando endpoint alternativo`);
                    
                    // Tentar endpoint alternativo (API_BASE j√° inclui /api)
                    const altResponse = await fetch(`${API_BASE}/success/${pedidoNumero}`);
                    
                    if (altResponse.ok) {
                        const data = await altResponse.json();
                        console.log('‚úÖ Dados carregados do endpoint /api/success:', data);
                        
                        // Verificar se a resposta tem sucesso
                        if (!data.success) {
                            console.error('‚ùå Resposta do servidor indica erro:', data.message);
                            showErrorState(data.message || errorMessage);
                            return;
                        }
                        
                        displayTransactionData(data.data);
                        
                        // Verificar se a venda foi enviada para UTMify (apenas verifica√ß√£o, n√£o envio)
                        // O envio deve acontecer automaticamente quando a PayMoz responde, n√£o aqui
                        const produtoId = urlParams.get('productId') || urlParams.get('produto') || data.data?.produto?.id;
                        if (produtoId && pedidoNumero) {
                            const trackingData = data.data?.tracking_data || {};
                            if (trackingData.utmfy_enviado === true) {
                                console.log('‚úÖ UTMIFY: Venda j√° foi enviada automaticamente durante o processamento do pagamento.');
                                console.log('üìÖ Data do envio:', trackingData.utmfy_enviado_em);
                            } else {
                                console.log('‚ö†Ô∏è UTMIFY: Venda ainda n√£o foi enviada para UTMify.');
                                console.log('‚ÑπÔ∏è UTMIFY: O envio deve acontecer automaticamente quando a PayMoz responde.');
                                // N√£o tentar enviar aqui - o envio deve ser autom√°tico durante o processamento
                            }
                        }
                        
                        // Mostrar chave de desbloqueio se for produto premium
                        if (isPremiumProduct) {
                            showPremiumUnlockKey();
                        }
                        
                        // Usar produtos complementares que v√™m do endpoint principal
                        if (data.data.produtosComplementares && data.data.produtosComplementares.length > 0) {
                            console.log('üì¶ Produtos complementares encontrados no endpoint alternativo:', data.data.produtosComplementares);
                            data.data.produtosComplementares.forEach((produtoComplementar, index) => {
                                console.log(`üîç Criando product-info para produto complementar ${index + 1}:`, produtoComplementar);
                                console.log(`üîó Link do conte√∫do: ${produtoComplementar.link_conteudo}`);
                                criarProductInfoComplementar(produtoComplementar, index);
                            });
                            console.log('‚úÖ Produtos complementares carregados do endpoint alternativo');
                        } else {
                            console.log('‚ÑπÔ∏è Nenhum produto complementar encontrado no endpoint alternativo');
                        }
                    } else {
                        console.log(`‚ùå Nenhum endpoint encontrado para o pedido: ${pedidoNumero} (Status: ${altResponse.status})`);
                        showErrorState(errorMessage);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do pedido:', error);
                showErrorState('Erro ao carregar dados do pedido. Tente novamente.');
            }
        }
        
        // Fun√ß√£o para criar product-info do produto principal
        function criarProductInfoPrincipal(data) {
            console.log('üîÑ Criando product-info para produto principal');
            
            const productsContainer = document.getElementById('productsContainer');
            
            // Limpar container existente
            productsContainer.innerHTML = '';
            
            // Criar elemento product-info para o produto principal
            const productInfo = document.createElement('div');
            productInfo.className = 'product-info principal-product';
            productInfo.style.cssText = 'margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #28a745;';
            
            // Determinar dados do produto
            let produtoData = null;
            let priceValue = null;
            
            if (data.produto) {
                produtoData = data.produto;
                
                // Tentar diferentes caminhos para o valor, priorizando pre√ßo original
                if (data.produto?.preco_original) {
                    priceValue = data.produto.preco_original;
                    console.log('üí∞ Pre√ßo original encontrado em data.produto.preco_original:', priceValue);
                } else if (data.produto?.valor_original) {
                    priceValue = data.produto.valor_original;
                    console.log('üí∞ Pre√ßo original encontrado em data.produto.valor_original:', priceValue);
                } else if (data.produto?.preco) {
                    priceValue = data.produto.preco;
                    console.log('üí∞ Pre√ßo encontrado em data.produto.preco:', priceValue);
                } else if (data.produto?.valor) {
                    priceValue = data.produto.valor;
                    console.log('üí∞ Valor encontrado em data.produto.valor:', priceValue);
                } else if (data.valor_original) {
                    priceValue = data.valor_original;
                    console.log('üí∞ Pre√ßo original encontrado em data.valor_original:', priceValue);
                } else if (data.valor) {
                    priceValue = data.valor;
                    console.log('üí∞ Valor encontrado em data.valor:', priceValue);
                } else if (data.pagamento?.valor) {
                    priceValue = data.pagamento.valor;
                    console.log('üí∞ Valor encontrado em data.pagamento.valor:', priceValue);
                } else if (data.venda?.valor) {
                    priceValue = data.venda.valor;
                    console.log('üí∞ Valor encontrado em data.venda.valor:', priceValue);
                }
            } else {
                // Fallback para dados de pagamento
                console.log('‚ö†Ô∏è Dados do produto n√£o encontrados, usando dados de pagamento');
                
                if (data.pagamento?.valor_original) {
                    priceValue = data.pagamento.valor_original;
                    console.log('üí∞ Pre√ßo original encontrado em dados de pagamento:', priceValue);
                } else if (data.pagamento?.valor) {
                    priceValue = data.pagamento.valor;
                    console.log('üí∞ Pre√ßo encontrado em dados de pagamento:', priceValue);
                } else if (data.valor_original) {
                    priceValue = data.valor_original;
                    console.log('üí∞ Pre√ßo original encontrado em data.valor_original:', priceValue);
                } else if (data.valor) {
                    priceValue = data.valor;
                    console.log('üí∞ Pre√ßo encontrado em data.valor:', priceValue);
                }
                
                produtoData = {
                    nome: 'Produto Principal',
                    imagem: '',
                    linkConteudo: ''
                };
            }
            
            // Construir HTML do product-info
            const nomeProduto = produtoData?.nome || 'Produto Principal';
            const precoFormatado = priceValue ? `MZN ${parseFloat(priceValue).toFixed(2).replace('.', ',')}` : 'MZN 0,00';
            const imagemUrl = produtoData?.imagem || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik00MCAyOEMzNy43OTA5IDI4IDM2IDI5Ljc5MDkgMzYgMzJWNDhDMzYgNTAuMjA5MSAzNy43OTA5IDUyIDQwIDUySDQ4QzUwLjIwOTEgNTIgNTIgNTAuMjA5MSA1MiA0OFY0OEM1MiA0NS43OTA5IDUwLjIwOTEgNDQgNDggNDRINDBDMzcuNzkwOSA0NCAzNiA0NS43OTA5IDM2IDQ4VjMyWiIgZmlsbD0iI0U5RUNFRiIvPgo8L3N2Zz4K';
            const linkConteudo = produtoData?.linkConteudo || produtoData?.link_conteudo || '';
            
            productInfo.innerHTML = `
                <img class="product-image" src="${imagemUrl}" alt="${nomeProduto}" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik00MCAyOEMzNy43OTA5IDI4IDM2IDI5Ljc5MDkgMzYgMzJWNDhDMzYgNTAuMjA5MSAzNy43OTA5IDUyIDQwIDUySDQ4QzUwLjIwOTEgNTIgNTIgNTAuMjA5MSA1MiA0OFY0OEM1MiA0NS43OTA5IDUwLjIwOTEgNDQgNDggNDRINDBDMzcuNzkwOSA0NCAzNiA0NS43OTA5IDM2IDQ4VjMyWiIgZmlsbD0iI0U5RUNFRiIvPgo8L3N2Zz4K';">
                <div class="product-details">
                    <h5 style="margin: 0; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        ${nomeProduto}
                        <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                            PRINCIPAL
                        </span>
                    </h5>
                    <div class="product-price" style="color: #28a745; font-weight: bold; font-size: 1.1rem; margin-top: 5px; margin-bottom: 15px;">
                        ${precoFormatado}
                    </div>
                    <div class="mt-3">
                        ${linkConteudo ? `
                            <a href="${linkConteudo}" target="_blank" class="btn-download" style="background: #28a745; border: none; color: white; padding: 15px 30px; border-radius: 10px; font-weight: 600; text-decoration: none; display: inline-block; margin-bottom: 15px; transition: all 0.3s ease;">
                                <i class="fas fa-download me-2"></i>Baixar Conte√∫do Principal
                            </a>
                        ` : `
                            <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 10px; padding: 15px; text-align: center;">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2rem; margin-right: 8px;"></i>
                                <span style="color: #28a745; font-weight: 600;">Produto principal inclu√≠do na compra</span>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // Adicionar hover effect para o bot√£o de download
            const downloadBtn = productInfo.querySelector('.btn-download');
            if (downloadBtn) {
                downloadBtn.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(40, 167, 69, 0.8)';
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(40, 167, 69, 0.3)';
                });
                downloadBtn.addEventListener('mouseleave', function() {
                    this.style.background = '#28a745';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            }
            
            productsContainer.appendChild(productInfo);
            console.log('‚úÖ Product-info do produto principal criado');
        }
        
        // Fun√ß√£o para criar product-info de produtos complementares
        function criarProductInfoComplementar(produto, index) {
            console.log(`üîÑ Criando product-info para produto complementar ${index + 1}:`, produto);
            console.log(`üîó Link do conte√∫do recebido:`, produto.link_conteudo);
            console.log(`üìù Descri√ß√£o recebida:`, produto.descricao);
            console.log(`üñºÔ∏è Imagem recebida:`, produto.imagem);
            
            const productsContainer = document.getElementById('productsContainer');
            
            // Criar elemento product-info para o produto complementar
            const productInfo = document.createElement('div');
            productInfo.className = 'product-info complementar-product';
            productInfo.style.cssText = 'margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #f59e0b;';
            
            // Construir URLs das imagens
            let imageUrl = produto.imagem || '';
            if (imageUrl && !imageUrl.startsWith('http')) {
                imageUrl = `${window.API_BASE}/produtos/imagem/${produto.id}`;
            }
            
            let thumbnailUrl = produto.miniatura || '';
            if (thumbnailUrl && !thumbnailUrl.startsWith('http')) {
                thumbnailUrl = `${window.API_BASE}/produtos/miniatura/${produto.id}`;
            }
            
            // Usar miniatura se dispon√≠vel, sen√£o usar imagem principal
            const displayImageUrl = thumbnailUrl || imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik00MCAyOEMzNy43OTA5IDI4IDM2IDI5Ljc5MDkgMzYgMzJWNDhDMzYgNTAuMjA5MSAzNy43OTA5IDUyIDQwIDUySDQ4QzUwLjIwOTEgNTIgNTIgNTAuMjA5MSA1MiA0OFY0OEM1MiA0NS43OTA5IDUwLjIwOTEgNDQgNDggNDRINDBDMzcuNzkwOSA0NCAzNiA0NS43OTA5IDM2IDQ4VjMyWiIgZmlsbD0iI0U5RUNFRiIvPgo8L3N2Zz4K';
            
            // Construir pre√ßo com desconto se aplic√°vel
            const precoOriginal = parseFloat(produto.preco) || 0;
            const desconto = parseFloat(produto.desconto || 0);
            const precoComDesconto = desconto > 0 ? precoOriginal * (1 - desconto / 100) : precoOriginal;
            
            const precoFormatado = desconto > 0 ? 
                `<span style="color: #999; text-decoration: line-through; font-size: 0.9rem; margin-right: 8px;">MZN ${precoOriginal.toFixed(2).replace('.', ',')}</span>
                 MZN ${precoComDesconto.toFixed(2).replace('.', ',')}
                 <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">-${desconto}% OFF</span>` :
                `MZN ${precoOriginal.toFixed(2).replace('.', ',')}`;
            
            productInfo.innerHTML = `
                <img class="product-image" src="${displayImageUrl}" alt="${produto.nome || 'Produto Complementar'}" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik00MCAyOEMzNy43OTA5IDI4IDM2IDI5Ljc5MDkgMzYgMzJWNDhDMzYgNTAuMjA5MSAzNy43OTA5IDUyIDQwIDUySDQ4QzUwLjIwOTEgNTIgNTIgNTAuMjA5MSA1MiA0OFY0OEM1MiA0NS43OTA5IDUwLjIwOTEgNDQgNDggNDRINDBDMzcuNzkwOSA0NCAzNiA0NS43OTA5IDM2IDQ4VjMyWiIgZmlsbD0iI0U5RUNFRiIvPgo8L3N2Zz4K';">
                <div class="product-details">
                    <h5 style="margin: 0; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        ${produto.nome || 'Produto Complementar'}
                        <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                            COMPLEMENTAR
                        </span>
                    </h5>
                    ${produto.descricao ? `<p style="margin: 8px 0; color: #666; font-size: 0.9rem; line-height: 1.4;">${produto.descricao}</p>` : ''}
                    <div class="product-price" style="color: #28a745; font-weight: bold; font-size: 1.1rem; margin-top: 5px; margin-bottom: 15px;">
                        ${precoFormatado}
                    </div>
                    <div class="mt-3">
                        ${produto.link_conteudo && produto.link_conteudo.trim() !== '' ? `
                            <a href="${produto.link_conteudo}" target="_blank" class="btn-download" style="background: #f59e0b; border: none; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 500; text-decoration: none; display: inline-block; font-size: 0.85rem; transition: all 0.3s ease; max-width: 100%;">
                                <i class="fas fa-download" style="margin-right: 6px;"></i>Baixar Conte√∫do
                            </a>
                        ` : `
                            <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; padding: 10px; text-align: center; font-size: 0.85rem;">
                                <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 1rem; margin-right: 6px;"></i>
                                <span style="color: #ef4444; font-weight: 500;">Link n√£o dispon√≠vel</span>
                                <br><small style="color: #7f1d1d; margin-top: 3px; display: block; font-size: 0.75rem;">Entre em contato com o vendedor</small>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // Adicionar hover effect para o bot√£o de download
            const downloadBtn = productInfo.querySelector('.btn-download');
            if (downloadBtn) {
                downloadBtn.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(245, 158, 11, 0.8)';
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.3)';
                });
                downloadBtn.addEventListener('mouseleave', function() {
                    this.style.background = '#f59e0b';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            }
            
            productsContainer.appendChild(productInfo);
            console.log(`‚úÖ Product-info do produto complementar ${index + 1} criado`);
        }
        
        // Fun√ß√£o para buscar produtos complementares do banco de dados
        async function buscarProdutosComplementaresDoBanco(transactionId) {
            try {
                console.log('üîç Buscando produtos complementares do banco de dados:', transactionId);
                
                // Primeiro tentar com o ID como est√° (pode ser public_id ou venda_id)
                let response = await fetch(`${API_BASE}/api/produtos-complementares/venda/${transactionId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                // Se n√£o encontrar e o ID parece ser um UUID (venda_id), tentar buscar o public_id
                if (!response.ok && transactionId && transactionId.includes('-')) {
                    console.log('üîÑ ID parece ser venda_id (UUID), tentando buscar public_id...');
                    
                    // Buscar o public_id da venda
                    const vendaResponse = await fetch(`${API_BASE}/api/success/venda/${transactionId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (vendaResponse.ok) {
                        const vendaData = await vendaResponse.json();
                        const publicId = vendaData.data?.venda?.public_id || vendaData.data?.pedido?.numero;
                        
                        if (publicId) {
                            console.log('üîç Tentando com public_id:', publicId);
                            response = await fetch(`${API_BASE}/api/produtos-complementares/venda/${publicId}`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });
                        }
                    }
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì¶ Produtos complementares encontrados no banco:', result);
                    
                    if (result.success && result.data && result.data.length > 0) {
                        // O endpoint agora retorna informa√ß√µes completas, n√£o precisamos buscar mais
                        result.data.forEach((produtoComplementar, index) => {
                            console.log(`üîç Criando product-info para produto complementar ${index + 1}:`, produtoComplementar);
                            console.log(`üîó Link do conte√∫do: ${produtoComplementar.link_conteudo}`);
                            criarProductInfoComplementar(produtoComplementar, index);
                        });
                        
                        console.log('‚úÖ Produtos complementares carregados do banco de dados com informa√ß√µes completas');
                    } else {
                        console.log('‚ÑπÔ∏è Nenhum produto complementar encontrado no banco de dados');
                    }
                } else {
                    console.log('‚ö†Ô∏è Erro ao buscar produtos complementares no banco:', response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar produtos complementares do banco:', error);
            }
        }
        
        // Verificar e ativar Premium automaticamente
        async function checkAndActivatePremium(data) {
            try {
                // Verificar se √© um pagamento Premium (produto 1PZO2Y0M6 ou valor 250 MZN)
                const isPremiumPayment = (
                    productId === '1PZO2Y0M6' || 
                    amount === '250' || 
                    data.produto?.id === '1PZO2Y0M6' ||
                    parseFloat(data.produto?.preco || 0) === 250
                );

                if (isPremiumPayment) {
                    console.log('üéØ Pagamento Premium detectado, ativando automaticamente...');

                    // Verificar se o usu√°rio est√° logado
                    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                    if (!token) {
                        console.log('‚ö†Ô∏è Usu√°rio n√£o logado, n√£o √© poss√≠vel ativar Premium automaticamente');
                        showNotification('‚ö†Ô∏è Para ativar o Premium, voc√™ precisa estar logado. Fa√ßa login e acesse novamente esta p√°gina.', 'warning');
                        return;
                    }

                    console.log('üîë Token encontrado, ativando Premium...');

                    // Ativar Premium usando o token de autentica√ß√£o
                    const response = await fetch(`${API_BASE}/api/marketing/activate-premium-payment`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            payment_id: data.numeroPedido || pedidoNumero,
                            amount: parseFloat(amount || data.produto?.preco || 0)
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Premium ativado automaticamente:', result);

                        // Mostrar notifica√ß√£o de sucesso
                        showNotification('üéâ Premium ativado com sucesso! Agora voc√™ tem acesso ao Marketing Avan√ßado!', 'success');
                        
                        // Adicionar indicador visual na p√°gina
                        addPremiumActivatedIndicator();
                    } else {
                        const errorData = await response.json();
                        console.log('‚ö†Ô∏è Erro ao ativar Premium automaticamente:', errorData);
                        showNotification('‚ö†Ô∏è Erro ao ativar Premium. Entre em contato com o suporte.', 'error');
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar/ativar Premium:', error);
                showNotification('‚ö†Ô∏è Erro ao ativar Premium. Entre em contato com o suporte.', 'error');
            }
        }

        // Fun√ß√£o para gerar chave de desbloqueio
        function generateUnlockKey() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 8);
            const pedido = pedidoNumero ? pedidoNumero.substring(pedidoNumero.length - 4) : '0000';
            return `RATIX-${timestamp.toUpperCase()}-${random.toUpperCase()}-${pedido}`;
        }

        // Fun√ß√£o para mostrar chave de desbloqueio premium
        function showPremiumUnlockKey() {
            const successContainer = document.querySelector('.success-container');
            if (successContainer && isPremiumProduct) {
                const unlockKey = generateUnlockKey();
                
                const premiumUnlockCard = document.createElement('div');
                premiumUnlockCard.style.cssText = `
                    background: linear-gradient(135deg, #FFD700, #FFA500);
                    color: #000;
                    padding: 25px;
                    margin: 20px;
                    border-radius: 15px;
                    text-align: center;
                    font-weight: bold;
                    box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
                    border: 2px solid #FFA500;
                    position: relative;
                    overflow: hidden;
                `;
                
                premiumUnlockCard.innerHTML = `
                    <div style="position: relative; z-index: 2;">
                        <div style="font-size: 2rem; margin-bottom: 15px;">
                            <i class="fas fa-crown" style="color: #000; margin-right: 10px;"></i>
                            <i class="fas fa-key" style="color: #000;"></i>
                        </div>
                        <h3 style="color: #000; margin-bottom: 15px; font-size: 1.5rem;">
                            üéâ Marketing Avan√ßado Premium Ativado!
                        </h3>
                        <p style="color: #000; margin-bottom: 20px; font-size: 1.1rem;">
                            Sua chave de desbloqueio para acessar todas as funcionalidades premium:
                        </p>
                        <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-family: 'Courier New', monospace; font-size: 1.3rem; font-weight: bold; color: #000; letter-spacing: 2px;">
                                ${unlockKey}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="copyUnlockKey('${unlockKey}')" style="
                                background: #000; 
                                color: #FFD700; 
                                border: none; 
                                padding: 10px 20px; 
                                border-radius: 25px; 
                                font-weight: bold; 
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#333'" onmouseout="this.style.background='#000'">
                                <i class="fas fa-copy"></i> Copiar Chave
                            </button>
                            <button onclick="goToMarketingPage()" style="
                                background: #FFA500; 
                                color: #000; 
                                border: none; 
                                padding: 10px 20px; 
                                border-radius: 25px; 
                                font-weight: bold; 
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#FF8C00'" onmouseout="this.style.background='#FFA500'">
                                <i class="fas fa-rocket"></i> Acessar Premium
                            </button>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.9rem; color: #000; opacity: 0.8;">
                            <i class="fas fa-info-circle"></i>
                            Guarde esta chave para futuras refer√™ncias
                        </div>
                    </div>
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: shimmer 3s ease-in-out infinite;"></div>
                `;
                
                // Inserir ap√≥s o header
                const successHeader = document.querySelector('.success-header');
                if (successHeader) {
                    successHeader.insertAdjacentElement('afterend', premiumUnlockCard);
                }
                
                // Salvar chave no localStorage
                localStorage.setItem('ratixpay_premium_key', unlockKey);
                localStorage.setItem('ratixpay_premium_activated', 'true');
                
                console.log('üîë Chave de desbloqueio gerada:', unlockKey);
            }
        }

        // Fun√ß√£o para copiar chave
        function copyUnlockKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                alert('Chave copiada para a √°rea de transfer√™ncia!');
            }).catch(() => {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = key;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Chave copiada para a √°rea de transfer√™ncia!');
            });
        }

        // Fun√ß√£o para ir para p√°gina de marketing
        function goToMarketingPage() {
            window.location.href = '/marketing-avancado.html';
        }

        // Fun√ß√£o para adicionar indicador visual de Premium ativado
        function addPremiumActivatedIndicator() {
            const successContainer = document.querySelector('.success-container');
            if (successContainer) {
                const premiumIndicator = document.createElement('div');
                premiumIndicator.style.cssText = `
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                    padding: 15px;
                    margin: 20px;
                    border-radius: 10px;
                    text-align: center;
                    font-weight: bold;
                    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                `;
                premiumIndicator.innerHTML = `
                    <i class="fas fa-crown" style="margin-right: 8px;"></i>
                    üéâ Marketing Avan√ßado Ativado!
                    <br>
                    <small style="opacity: 0.9;">Agora voc√™ tem acesso a todas as funcionalidades Premium</small>
                `;
                
                // Inserir ap√≥s o header
                const successHeader = document.querySelector('.success-header');
                if (successHeader) {
                    successHeader.insertAdjacentElement('afterend', premiumIndicator);
                }
            }
        }
        
        // Display transaction data
        function displayTransactionData(data) {
            console.log('üìä Exibindo dados do pedido:', data);
            console.log('üîç Estrutura completa dos dados:', JSON.stringify(data, null, 2));
            
            // Verificar se √© produto premium atrav√©s dos dados
            if (data && data.produto && data.produto.custom_id === 'V7XZPKGEF') {
                console.log('üéØ Produto premium detectado atrav√©s dos dados:', data.produto.custom_id);
                if (!isPremiumProduct) {
                    isPremiumProduct = true;
                    showPremiumUnlockKey();
                }
            }
            
            // Store order data globally
            orderData = data;
            
            // Verificar se √© um pagamento Premium e ativar automaticamente
            checkAndActivatePremium(data);
            
            // Update success message with client name
            const clientName = data.cliente?.nome || 'Cliente';
            document.getElementById('customerName').textContent = clientName;
            
            // Fun√ß√£o para formatar transaction_id do PayMoz como TXP_{8 √∫ltimos n√∫meros}
            function formatarTransactionIdPayMoz(transactionId) {
                if (!transactionId || transactionId === 'N/A') return transactionId;
                const txStr = String(transactionId);
                
                // Extrair apenas n√∫meros da transaction_id
                const numeros = txStr.replace(/\D/g, '');
                
                // Pegar os √∫ltimos 8 n√∫meros
                const ultimos8Numeros = numeros.length > 8 ? numeros.slice(-8) : numeros;
                
                // Se n√£o houver n√∫meros suficientes, usar o que tiver (preencher com zeros √† esquerda se necess√°rio)
                const numerosFormatados = ultimos8Numeros.padStart(Math.min(8, numeros.length), '0');
                
                // Adicionar prefixo TXP_
                return `TXP_${numerosFormatados}`;
            }
            
            // Transaction ID (formatado como TXP_{8 √∫ltimos n√∫meros})
            const transactionIdOriginal = data.numeroPedido || 'N/A';
            document.getElementById('transactionId').textContent = formatarTransactionIdPayMoz(transactionIdOriginal);
            
            // Transaction Date
            const transactionDateElement = document.getElementById('transactionDate');
            let transactionDate = null;
            
            // Tentar diferentes fontes para a data
            if (data.dataHora) {
                transactionDate = data.dataHora;
            } else if (data.data_compra) {
                transactionDate = data.data_compra;
            } else if (data.created_at) {
                transactionDate = data.created_at;
            } else if (data.data) {
                transactionDate = data.data;
            } else {
                // Usar data atual como fallback
                transactionDate = new Date().toLocaleString('pt-BR');
            }
            
            // Formatar a data
            try {
                const date = new Date(transactionDate);
                if (!isNaN(date.getTime())) {
                    transactionDateElement.textContent = date.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    transactionDateElement.textContent = transactionDate;
                }
            } catch (error) {
                transactionDateElement.textContent = transactionDate || 'Data n√£o dispon√≠vel';
            }
            
            // Criar product-info para o produto principal
            criarProductInfoPrincipal(data);
            
            // Vendedor/Expert info
            if (data.vendedor) {
                // Verificar se h√° expert associado ao produto
                const expert = data.expert;
                const isExpert = expert && expert.nome;
                
                // Atualizar t√≠tulo da se√ß√£o
                const contactTitle = document.getElementById('contactTitle');
                if (isExpert) {
                    contactTitle.textContent = 'Informa√ß√µes do Expert';
                    console.log('‚úÖ Mostrando informa√ß√µes do expert:', expert.nome);
                } else {
                    contactTitle.textContent = 'Informa√ß√µes do Vendedor';
                    console.log('‚ÑπÔ∏è Mostrando informa√ß√µes do vendedor (sem expert)');
                }
                
                // Usar dados do expert se dispon√≠vel, sen√£o usar dados do vendedor
                const nome = isExpert ? expert.nome : (data.vendedor.nome || 'Nome n√£o dispon√≠vel');
                const whatsappText = isExpert ? expert.whatsapp : (data.vendedor.whatsapp || 'WhatsApp n√£o dispon√≠vel');
                const emailText = isExpert ? expert.email : (data.vendedor.email || 'Email n√£o dispon√≠vel');
                
                document.getElementById('vendedorNome').textContent = nome;
                document.getElementById('vendedorWhatsapp').textContent = whatsappText;
                document.getElementById('vendedorEmail').textContent = emailText;
                
                // Configurar links clic√°veis
                const whatsappLink = document.getElementById('vendedorWhatsappLink');
                const emailLink = document.getElementById('vendedorEmailLink');
                
                if (whatsappText && whatsappText !== 'WhatsApp n√£o dispon√≠vel') {
                    whatsappLink.href = `https://wa.me/${whatsappText.replace(/\D/g, '')}`;
                    whatsappLink.target = '_blank';
                } else {
                    whatsappLink.style.pointerEvents = 'none';
                    whatsappLink.style.opacity = '0.6';
                }
                
                if (emailText && emailText !== 'Email n√£o dispon√≠vel') {
                    emailLink.href = `mailto:${emailText}`;
                    emailLink.target = '_blank';
                } else {
                    emailLink.style.pointerEvents = 'none';
                    emailLink.style.opacity = '0.6';
                }
            }
            
            // Show content
            showContent();
            
            // Update WhatsApp select text
            updateWhatsAppSelectText();
        }
        
        // Display product data (fallback)
        function displayProductData(productData) {
            console.log('üìä Exibindo dados do produto:', productData);
            
            if (productData.nome) {
                document.getElementById('productName').textContent = productData.nome;
            }
            
            // Product image
            const productImage = document.getElementById('productImage');
            if (productData.imagem_url) {
                productImage.src = productData.imagem_url;
            }
            
            // Download button
            const downloadBtn = document.getElementById('downloadBtn');
            if (productData.link_conteudo) {
                downloadBtn.href = productData.link_conteudo;
                downloadBtn.target = '_blank';
            } else {
                downloadBtn.style.display = 'none';
            }
        }
        
        // Show content and hide loading
        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';
        }
        
        // Show error state
        function showErrorState(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';
            
            // Substituir conte√∫do por mensagem de erro
            document.getElementById('contentState').innerHTML = `
                <div class="text-center" style="padding: 40px 20px;">
                    <div style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="color: #dc3545; margin-bottom: 15px;">Ops! Algo deu errado</h3>
                    <p style="color: #6c757d; margin-bottom: 25px;">${message}</p>
                    <a href="/" class="btn-support">
                        <i class="fas fa-home me-2"></i>Voltar ao In√≠cio
                    </a>
                </div>
            `;
        }
        
        // Global variables to store order data
        let orderData = null;
        
        // Show notification function
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 5000);
        }
        
        // Fun√ß√£o removida - envio autom√°tico implementado
        
        // Update WhatsApp radio text with client phone
        function updateWhatsAppSelectText() {
            const label = document.getElementById('whatsappClienteLabel');
            if (label && orderData && orderData.cliente && orderData.cliente.telefone) {
                label.textContent = `Receber no n√∫mero ${orderData.cliente.telefone}`;
            }
        }
        
        // Chat de Suporte - Vari√°veis globais
        let selectedSupportOption = null;
        let supportChatOpen = false;
        let sessaoInicializada = false;
        let conversaAtual = [];
        let modoReclamacao = false;
        
        // Fun√ß√µes para gerenciar conversas
        function salvarConversaNoNavegador() {
            try {
                const chaveConversa = `chatbot_conversa_${orderData?.pedido?.id || 'default'}`;
                localStorage.setItem(chaveConversa, JSON.stringify(conversaAtual));
                console.log('üíæ Conversa salva no navegador:', conversaAtual.length, 'mensagens');
            } catch (error) {
                console.error('‚ùå Erro ao salvar conversa:', error);
            }
        }
        
        function carregarConversaDoNavegador() {
            try {
                const chaveConversa = `chatbot_conversa_${orderData?.pedido?.id || 'default'}`;
                const conversaSalva = localStorage.getItem(chaveConversa);
                if (conversaSalva) {
                    conversaAtual = JSON.parse(conversaSalva);
                    console.log('üìÇ Conversa carregada do navegador:', conversaAtual.length, 'mensagens');
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar conversa:', error);
            }
            return false;
        }
        
        function limparConversaDoNavegador() {
            try {
                const chaveConversa = `chatbot_conversa_${orderData?.pedido?.id || 'default'}`;
                localStorage.removeItem(chaveConversa);
                conversaAtual = [];
                console.log('üóëÔ∏è Conversa limpa do navegador');
            } catch (error) {
                console.error('‚ùå Erro ao limpar conversa:', error);
            }
        }
        
        function adicionarMensagemConversa(tipo, conteudo, timestamp = new Date()) {
            const mensagem = {
                tipo: tipo, // 'usuario' ou 'chatbot'
                conteudo: conteudo,
                timestamp: timestamp.toISOString(),
                produto: orderData?.produto?.nome || 'Produto'
            };
            conversaAtual.push(mensagem);
            salvarConversaNoNavegador();
        }
        
        function gerarPDFConversa() {
            try {
                if (conversaAtual.length === 0) {
                    alert('N√£o h√° conversa para gerar PDF.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configura√ß√µes do PDF
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                let yPosition = 30;
                
                // Cabe√ßalho
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Hist√≥rico de Conversa - RatixPay', margin, yPosition);
                yPosition += 15;
                
                // Informa√ß√µes do produto
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Produto: ${orderData?.produto?.nome || 'N/A'}`, margin, yPosition);
                yPosition += 8;
                doc.text(`Cliente: ${orderData?.cliente?.nome || 'N/A'}`, margin, yPosition);
                yPosition += 8;
                doc.text(`Data: ${new Date().toLocaleString('pt-BR')}`, margin, yPosition);
                yPosition += 15;
                
                // Linha separadora
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Conversa
                doc.setFontSize(10);
                conversaAtual.forEach((mensagem, index) => {
                    // Verificar se precisa de nova p√°gina
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    const timestamp = new Date(mensagem.timestamp).toLocaleString('pt-BR');
                    const remetente = mensagem.tipo === 'usuario' ? 'Cliente' : 'RatixPay';
                    
                    // Cabe√ßalho da mensagem
                    doc.setFont(undefined, 'bold');
                    doc.text(`${remetente} - ${timestamp}`, margin, yPosition);
                    yPosition += 6;
                    
                    // Conte√∫do da mensagem
                    doc.setFont(undefined, 'normal');
                    const lines = doc.splitTextToSize(mensagem.conteudo, pageWidth - 2 * margin);
                    doc.text(lines, margin, yPosition);
                    yPosition += lines.length * 5 + 10;
                });
                
                // Salvar PDF
                const nomeArquivo = `conversa_${orderData?.produto?.nome?.replace(/[^a-zA-Z0-9]/g, '_') || 'produto'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                
                console.log('üìÑ PDF gerado com sucesso:', nomeArquivo);
                
                // Enviar PDF para o vendedor
                enviarPDFParaVendedor(doc.output('blob'));
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Tente novamente.');
            }
        }
        
        async function enviarPDFParaVendedor(pdfBlob) {
            try {
                const formData = new FormData();
                formData.append('pdf', pdfBlob, 'conversa_chatbot.pdf');
                formData.append('pedido_id', orderData?.pedido?.id || '');
                formData.append('produto_nome', orderData?.produto?.nome || '');
                formData.append('cliente_nome', orderData?.cliente?.nome || '');
                formData.append('conversa', JSON.stringify(conversaAtual));
                
                const response = await fetch(`${API_BASE}/api/chatbot/enviar-pdf-vendedor`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ PDF enviado para o vendedor com sucesso');
                } else {
                    console.log('‚ö†Ô∏è Erro ao enviar PDF para o vendedor:', data.message);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar PDF:', error);
            }
        }
        
        // Toggle support chat
        function toggleSupportChat() {
            const chat = document.getElementById('supportChat');
            const button = document.getElementById('supportButton');
            
            if (!supportChatOpen) {
                chat.classList.add('active');
                supportChatOpen = true;
                button.style.display = 'none';
                initializeSupportChat();
            } else {
                chat.classList.remove('active');
                supportChatOpen = false;
                button.style.display = 'flex';
            }
        }
        
        // Initialize support chat
        function initializeSupportChat() {
            const chatMessages = document.getElementById('chatMessages');
            const chatOptions = document.getElementById('chatOptions');
            const clientName = orderData?.cliente?.nome || 'Cliente';
            const orderId = orderData?.numeroPedido || 'N/A';
            
            // Clear previous messages and reset state
            chatMessages.innerHTML = '';
            chatOptions.innerHTML = '';
            selectedSupportOption = null;
            modoReclamacao = false;
            
            // Add initial support message with action buttons
            const supportMessage = `
                <div class="message support">
                    <div class="message-header">RatixPay</div>
                    <div class="message-content">
                    <div style="margin-bottom: 8px;">
                        <strong>Oi ${clientName}!</strong>
                    </div>
                    <div style="margin-bottom: 12px;">
                        Seu pagamento foi aprovado com sucesso!
                    </div>
                    <div style="margin-bottom: 8px;">
                        Somos a <strong>RatixPay</strong>, especializados em venda de info-produtos de forma r√°pida e segura.
                    </div>
                    <div>
                        <strong>Como posso ajudar voc√™ hoje?</strong>
                    </div>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML = supportMessage;
            
            // Add action buttons
            const actionButtons = `
                <div class="text-center mt-3">
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn-send-support" onclick="iniciarReclamacao()" style="background: linear-gradient(135deg, #f64c00 0%, #ff6b35 100%); flex: 1; min-width: 120px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <img src="/assets/images/external/support-icon.png" alt="Relama√ß√£o" style="width: 40px; height: 40px; filter: brightness(0) invert(1);">
                            Tens uma relama√ß√£o?
                        </button>
                        <button class="btn-send-support" onclick="iniciarConversa()" style="background: linear-gradient(135deg, #f64c00 0%, #ff6b35 100%); flex: 1; min-width: 120px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <img src="/assets/images/external/support-icon.png" alt="D√∫vida" style="width: 40px; height: 40px; filter: brightness(0) invert(1);">
                            Tens uma d√∫vida?
                    </button>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += actionButtons;
            scrollToBottom();
        }
        
        // Iniciar reclama√ß√£o
        function iniciarReclamacao() {
            console.log('üîÑ Iniciando modo reclama√ß√£o...');
            modoReclamacao = true;
            
            const chatMessages = document.getElementById('chatMessages');
            const chatOptions = document.getElementById('chatOptions');
            
            // Mostrar op√ß√µes de reclama√ß√£o
            const complaintOptions = `
                <div class="message support">
                    <div class="message-header">RatixPay</div>
                    <div class="message-content">
                        <strong>Quero reportar um problema</strong><br><br>
                        <div class="support-options" style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="support-option" onclick="selectSupportOption('link_quebrado')" style="
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                                text-align: left;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                üîó Link do produto quebrado
                            </button>
                            <button class="support-option" onclick="selectSupportOption('produto_errado')" style="
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                                text-align: left;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                üì¶ Produto n√£o corresponde √† descri√ß√£o
                            </button>
                            <button class="support-option" onclick="selectSupportOption('fraude')" style="
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                                text-align: left;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                üö® Fraude
                            </button>
                            <button class="support-option" onclick="selectSupportOption('reembolso')" style="
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                                text-align: left;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                üí∞ Reembolso
                            </button>
                            <button class="support-option" onclick="selectSupportOption('outro')" style="
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                                text-align: left;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                ‚ùì Outro problema
                            </button>
                            <button class="support-option" onclick="selectSupportOption('mais_info')" style="
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.3s ease;
                                text-align: left;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                ‚ûï Mais informa√ß√µes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.innerHTML += complaintOptions;
            
            // Focar no input e configurar eventos
            setTimeout(() => {
                chatInput.focus();
                scrollToBottom();
                
                // Adicionar evento para Enter (Shift+Enter para nova linha)
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        enviarMensagem();
                    }
                });
                
                // Auto-resize do textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            }, 100);
        }

        // Iniciar conversa
        async function iniciarConversa() {
            console.log('üîÑ Iniciando modo conversa...');
            modoReclamacao = false;
            
            const chatMessages = document.getElementById('chatMessages');
            const chatOptions = document.getElementById('chatOptions');
            
            // Inicializar chatbot se ainda n√£o foi inicializado
            if (!sessaoInicializada) {
                const sucesso = await inicializarChatbot();
                if (!sucesso) {
                    const errorMessage = `
                        <div class="message support">
                            <div class="message-header">RatixPay</div>
                            <div class="message-content">
                                <div style="margin-bottom: 8px;">
                                    <strong>Erro ao inicializar suporte</strong>
                                </div>
                                <div>
                                    Desculpe, n√£o foi poss√≠vel inicializar o suporte inteligente. Tente novamente.
                                </div>
                            </div>
                        </div>
                    `;
                    chatMessages.innerHTML += errorMessage;
                    scrollToBottom();
                    return;
                }
            }
            
            // Adicionar mensagem do bot
            const botMessage = `
                <div class="message support">
                    <div style="margin-bottom: 8px;">
                        <strong>Suporte ativo</strong>
                    </div>
                    <div>
                        Posso ajudar com d√∫vidas sobre o produto que voc√™ adquiriu. O que gostaria de saber?
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += botMessage;
            
            // Mostrar campo de texto
            // Mostrar input de chat
            const chatInputContainer = document.getElementById('chatInputContainer');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            
            chatInputContainer.style.display = 'flex';
            chatInput.placeholder = 'Digite sua pergunta sobre o produto...';
            chatSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            
            // Adicionar mensagem de instru√ß√£o
            const instructionMessage = `
                <div class="message support">
                    <div class="message-header">RatixPay</div>
                    <div class="message-content">
                        <strong>Como posso ajudar?</strong><br>
                        Fa√ßa qualquer pergunta sobre o produto que voc√™ comprou. Posso esclarecer d√∫vidas sobre o conte√∫do, download ou contato.
                    </div>
                </div>
            `;
            chatMessages.innerHTML += instructionMessage;
            
            // Adicionar bot√£o para gerar PDF
            const pdfButton = `
                <div class="message support" style="margin-top: 10px;">
                    <div class="message-content" style="text-align: center;">
                        <button onclick="gerarPDFConversa()" style="
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                            üìÑ Gerar PDF da Conversa
                        </button>
                    </div>
                </div>
            `;
            chatMessages.innerHTML += pdfButton;
            
            // Focar no input e configurar eventos
            setTimeout(() => {
                chatInput.focus();
                scrollToBottom();
                
                // Adicionar evento para Enter (Shift+Enter para nova linha)
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        enviarMensagem();
                    }
                });
                
                // Auto-resize do textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            }, 100);
        }

        // Inicializar chatbot
        async function inicializarChatbot() {
            try {
                console.log('üîÑ Inicializando chatbot...');
                
                const response = await fetch(`${API_BASE}/api/chatbot/inicializar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_pedido: orderData?.numeroPedido || orderData?.id
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    sessaoInicializada = true;
                    console.log('‚úÖ Chatbot inicializado:', data.produto);
                    return true;
                } else {
                    throw new Error(data.message || 'Erro ao inicializar chatbot');
                }

            } catch (error) {
                console.error('‚ùå Erro ao inicializar chatbot:', error);
                return false;
            }
        }

        // Fun√ß√£o para mostrar indicador de digita√ß√£o
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = `
                <div class="typing-indicator">
                    <span>RatixPay est√° digitando</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.innerHTML += typingIndicator;
            scrollToBottom();
        }
        
        // Fun√ß√£o para remover indicador de digita√ß√£o
        function hideTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = chatMessages.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Fun√ß√£o para remover mensagens com spinner
        function removeSpinnerMessages() {
            const chatMessages = document.getElementById('chatMessages');
            const spinnerMessages = chatMessages.querySelectorAll('.message:has(.fa-spinner)');
            spinnerMessages.forEach(message => message.remove());
            
            // Fallback: remover por classe
            const messagesWithSpinner = chatMessages.querySelectorAll('.message');
            messagesWithSpinner.forEach(message => {
                if (message.querySelector('.fa-spinner')) {
                    message.remove();
                }
            });
        }
        
        // Fun√ß√£o para scroll autom√°tico
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
        
        // Fun√ß√£o para scroll autom√°tico suave
        function smoothScrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // Adicionar scroll autom√°tico no hover
        function setupAutoScroll() {
            const chatMessages = document.getElementById('chatMessages');
            
            // Scroll autom√°tico quando o mouse entra na √°rea do chat
            chatMessages.addEventListener('mouseenter', function() {
                smoothScrollToBottom();
            });
            
            // Scroll autom√°tico quando uma nova mensagem √© adicionada
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Verificar se foi adicionada uma nova mensagem
                        const addedNodes = Array.from(mutation.addedNodes);
                        const hasNewMessage = addedNodes.some(node => 
                            node.nodeType === 1 && node.classList && 
                            (node.classList.contains('message') || node.classList.contains('typing-indicator'))
                        );
                        
                        if (hasNewMessage) {
                            setTimeout(() => {
                                smoothScrollToBottom();
                            }, 50);
                        }
                    }
                });
            });
            
            observer.observe(chatMessages, {
                childList: true,
                subtree: true
            });
        }

        // Enviar mensagem
        async function enviarMensagem() {
            const chatInput = document.getElementById('chatInput');
            const mensagem = chatInput.value.trim();
            
            if (!mensagem) return;

            const chatMessages = document.getElementById('chatMessages');
            const chatOptions = document.getElementById('chatOptions');
            
            // Adicionar mensagem do usu√°rio
            const userMessage = `
                <div class="message user">
                    <div class="message-header">Voc√™</div>
                    <div class="message-content">${mensagem}</div>
                </div>
            `;
            
            chatMessages.innerHTML += userMessage;
            
            // Salvar mensagem do usu√°rio na conversa
            adicionarMensagemConversa('usuario', mensagem);
            
            // Limpar input
            chatInput.value = '';
            scrollToBottom();
            
            // Mostrar indicador de digita√ß√£o
            showTypingIndicator();
            
            // Ocultar input temporariamente
            chatOptions.style.display = 'none';

            try {
                if (modoReclamacao) {
                    // Processar reclama√ß√£o
                    await processarReclamacao(mensagem);
                } else {
                    // Processar conversa normal
                    await processarConversa(mensagem);
                }

            } catch (error) {
                console.error('‚ùå Erro ao processar mensagem:', error);
                
                // Remover indicador de digita√ß√£o
                chatMessages.innerHTML = chatMessages.innerHTML.replace(typingMessage, '');
                
                const errorMessage = `
                    <div class="message support">
                        <div class="message-header">RatixPay</div>
                        <div class="message-content">
                            <div style="margin-bottom: 8px;">
                                <strong>Erro de conex√£o</strong>
                            </div>
                            <div>
                                N√£o conseguimos conectar ao servidor. Verifique sua internet e tente novamente.
                            </div>
                        </div>
                    </div>
                `;
                
                chatMessages.innerHTML += errorMessage;
                scrollToBottom();
            } finally {
                // Mostrar input novamente
                chatOptions.style.display = 'block';
            }
        }

        // Processar reclama√ß√£o
        async function processarReclamacao(mensagem) {
            try {
                console.log('üîÑ Processando reclama√ß√£o:', mensagem);
                
                const chatMessages = document.getElementById('chatMessages');
                
                // Enviar reclama√ß√£o para o backend
                const response = await fetch(`${API_BASE}/api/support-request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clienteNome: orderData?.cliente?.nome || 'Cliente',
                        numeroPedido: orderData?.numeroPedido || 'N/A',
                        problema: selectedSupportOption || 'Reclama√ß√£o via chatbot',
                        descricao: mensagem,
                        dataHora: new Date().toISOString(),
                        produtoNome: orderData?.produto?.nome || 'Produto',
                        produtoValor: orderData?.produto?.valor || '0.00',
                        clienteEmail: orderData?.cliente?.email || '',
                        clienteTelefone: orderData?.cliente?.telefone || ''
                    })
                });

                const data = await response.json();
                
                // Remover indicador de digita√ß√£o e mensagens com spinner
                hideTypingIndicator();
                removeSpinnerMessages();
                
                if (data.success) {
                    const successMessage = `
                        <div class="message support">
                            <div class="message-header">RatixPay</div>
                            <div class="message-content">
                                <div style="margin-bottom: 8px;">
                                    <strong>Obrigado pela sua reclama√ß√£o!</strong>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    Nossa equipe foi notificada e entrar√° em contato em breve para resolver o problema.
                                </div>
                                <div>
                                    <strong>üìã Detalhes registrados:</strong><br>
                                    ‚Ä¢ Pedido: #${orderData?.numeroPedido || 'N/A'}<br>
                                    ‚Ä¢ Problema: Reclama√ß√£o via chatbot<br>
                                    ‚Ä¢ Descri√ß√£o: ${mensagem}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    chatMessages.innerHTML += successMessage;
                } else {
                    const errorMessage = `
                        <div class="message support">
                            <div style="margin-bottom: 8px;">
                                <strong>Erro ao enviar reclama√ß√£o</strong>
                            </div>
                            <div>
                                Desculpe, houve um problema ao enviar sua reclama√ß√£o. Tente novamente ou entre em contato diretamente conosco.
                            </div>
                        </div>
                    `;
                    
                    chatMessages.innerHTML += errorMessage;
                }

            } catch (error) {
                console.error('‚ùå Erro ao processar reclama√ß√£o:', error);
                throw error;
            }
        }

        // Processar conversa normal
        async function processarConversa(mensagem) {
            try {
                console.log('üîÑ Processando conversa:', mensagem);
                
                const chatMessages = document.getElementById('chatMessages');
                
                const response = await fetch(`${API_BASE}/api/chatbot/mensagem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_pedido: orderData?.numeroPedido || orderData?.id,
                        mensagem: mensagem
                    })
                });

                const data = await response.json();
                
                // Remover indicador de digita√ß√£o e mensagens com spinner
                hideTypingIndicator();
                removeSpinnerMessages();
                
                if (data.success) {
                    // Adicionar resposta do bot
                    const botMessage = `
                        <div class="message support">
                            <div class="message-header">RatixPay</div>
                            <div class="message-content">
                                ${data.resposta}
                            </div>
                        </div>
                    `;
                    
                    chatMessages.innerHTML += botMessage;
                    
                    // Salvar resposta do chatbot na conversa
                    adicionarMensagemConversa('chatbot', data.resposta);
                } else {
                    const errorMessage = `
                        <div class="message support">
                            <div style="margin-bottom: 8px;">
                                <strong>Erro no assistente</strong>
                            </div>
                            <div>
                                Desculpe, ocorreu um erro. Tente novamente.
                            </div>
                        </div>
                    `;
                    
                    chatMessages.innerHTML += errorMessage;
                }

            } catch (error) {
                console.error('‚ùå Erro ao processar conversa:', error);
                throw error;
            }
        }
        
        // Show support options
        function showSupportOptions() {
            const chatMessages = document.getElementById('chatMessages');
            const chatOptions = document.getElementById('chatOptions');
            
            // Add user message
            const userMessage = `
                <div class="message user">
                    Quero reportar um problema
                </div>
            `;
            
            chatMessages.innerHTML += userMessage;
            
            // Show support options
            const supportOptions = `
                <div class="support-options">
                    <button class="support-option" onclick="selectSupportOption('link_quebrado')">
                        üîó Link do produto quebrado
                    </button>
                    <button class="support-option" onclick="selectSupportOption('produto_errado')">
                        üì¶ Produto n√£o corresponde √† descri√ß√£o
                    </button>
                    <button class="support-option" onclick="selectSupportOption('fraude')">
                        üö® Fraude
                    </button>
                    <button class="support-option" onclick="selectSupportOption('reembolso')">
                        üí∞ Reembolso
                    </button>
                    <button class="support-option" onclick="selectSupportOption('outro')">
                        ‚ùì Outro problema
                    </button>
                    <button class="support-option" onclick="selectSupportOption('mais_info')">
                        ‚ûï Mais informa√ß√µes
                    </button>
                </div>
                
                <div class="support-details" id="supportDetails" style="display: none;">
                    <textarea id="supportDescription" class="form-control" 
                              placeholder="Descreva detalhadamente o seu problema..." 
                              rows="4"></textarea>
                    <button class="btn-send-support" onclick="sendSupportRequest()">
                        <i class="fas fa-paper-plane me-2"></i>Enviar Reclama√ß√£o
                    </button>
                </div>
            `;
            
            chatOptions.innerHTML = supportOptions;
            scrollToBottom();
        }
        
        // Select support option
        function selectSupportOption(option) {
            selectedSupportOption = option;
            
            const chatMessages = document.getElementById('chatMessages');
            const chatOptions = document.getElementById('chatOptions');
            const optionText = event.target.textContent.trim();
            
            // Add user message to chat
            const userMessage = `
                <div class="message user">
                    <div class="message-header">Voc√™</div>
                    <div class="message-content">${optionText}</div>
                </div>
            `;
            
            chatMessages.innerHTML += userMessage;
            
            // Mostrar input de chat com placeholder espec√≠fico
            const chatInputContainer = document.getElementById('chatInputContainer');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            
            chatInputContainer.style.display = 'flex';
            chatInput.placeholder = 'Descreva detalhadamente o seu problema...';
            chatSendBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            
            // Adicionar mensagem de instru√ß√£o
            const instructionMessage = `
                <div class="message support">
                    <div class="message-header">RatixPay</div>
                    <div class="message-content">
                        <strong>Descreva seu problema:</strong><br>
                        Por favor, explique detalhadamente o que aconteceu para que possamos ajud√°-lo da melhor forma.
                    </div>
                </div>
            `;
            chatMessages.innerHTML += instructionMessage;
            
            // Salvar mensagem do usu√°rio na conversa
            adicionarMensagemConversa('usuario', optionText);
            
            // Scroll para baixo
            scrollToBottom();
            
            // Focar no input
            setTimeout(() => {
                chatInput.focus();
            }, 100);
            
            // Add support response message
            const supportResponse = `
                <div class="message support">
                    <div style="margin-bottom: 8px;">
                        <strong>Entendi! üëç</strong>
                    </div>
                    <div style="margin-bottom: 8px;">
                        Voc√™ selecionou: <strong>"${optionText}"</strong>
                    </div>
                    <div>
                        Por favor, descreva detalhadamente o problema para que possamos ajud√°-lo da melhor forma.
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += supportResponse;
            scrollToBottom();
        }
        
        // Send support request
        async function sendSupportRequest() {
            const description = document.getElementById('supportDescription').value.trim();
            const chatMessages = document.getElementById('chatMessages');
            const chatOptions = document.getElementById('chatOptions');
            
            if (!selectedSupportOption) {
                showNotification('‚ùå Selecione um tipo de problema', 'error');
                return;
            }
            
            if (!description) {
                showNotification('‚ùå Descreva o problema', 'error');
                return;
            }
            
            // Add user message with description
            const userDescriptionMessage = `
                <div class="message user">
                    ${description}
                </div>
            `;
            
            chatMessages.innerHTML += userDescriptionMessage;
            
            // Show loading message
            const loadingMessage = `
                <div class="message support">
                    <div style="margin-bottom: 8px;">
                        <strong>‚è≥ Processando sua solicita√ß√£o...</strong>
                    </div>
                    <div>
                        Aguarde um momento enquanto registramos sua reclama√ß√£o.
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += loadingMessage;
            scrollToBottom();
            
            // Hide the form
            chatOptions.innerHTML = '';
            
            try {
                const supportData = {
                    clienteNome: orderData?.cliente?.nome || 'Cliente',
                    numeroPedido: orderData?.numeroPedido || 'N/A',
                    problema: selectedSupportOption,
                    descricao: description,
                    dataHora: new Date().toLocaleString('pt-BR'),
                    produtoNome: orderData?.produto?.nome || 'Produto',
                    produtoValor: orderData?.produto?.valor || '0.00',
                    clienteEmail: orderData?.cliente?.email || '',
                    clienteTelefone: orderData?.cliente?.telefone || ''
                };
                
                // Send to backend
                const response = await fetch(`${API_BASE}/api/support-request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(supportData)
                });
                
                const result = await response.json();
                
                // Remove loading message
                chatMessages.innerHTML = chatMessages.innerHTML.replace(loadingMessage, '');
                
                if (result.success) {
                    // Show success message in chat
                    const successMessage = `
                        <div class="message support">
                            <div style="margin-bottom: 8px;">
                                <strong>‚úÖ Muito obrigado, ${supportData.clienteNome}!</strong>
                            </div>
                            <div style="margin-bottom: 8px;">
                                Registramos sua reclama√ß√£o sobre <strong>"${getProblemText(selectedSupportOption)}"</strong>.
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>üìã Detalhes registrados:</strong><br>
                                ‚Ä¢ Pedido: #${supportData.numeroPedido}<br>
                                ‚Ä¢ Produto: ${supportData.produtoNome}<br>
                                ‚Ä¢ Problema: ${getProblemText(selectedSupportOption)}<br>
                                ‚Ä¢ Descri√ß√£o: ${description}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>üîî Entraremos em contacto em breve via:</strong><br>
                                ‚Ä¢ WhatsApp: ${supportData.clienteTelefone}<br>
                                ‚Ä¢ E-mail: ${supportData.clienteEmail}
                            </div>
                            <div>
                                <strong>Obrigado pela sua paci√™ncia! üôè</strong>
                            </div>
                        </div>
                    `;
                    
                    chatMessages.innerHTML += successMessage;
                    scrollToBottom();
                    
                    // Show close button after a delay
                    setTimeout(() => {
                        const closeButton = `
                            <div class="text-center mt-3">
                                <button class="btn-send-support" onclick="toggleSupportChat()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                                    <i class="fas fa-times me-2"></i>Fechar conversa
                                </button>
                            </div>
                        `;
                        chatMessages.innerHTML += closeButton;
                        scrollToBottom();
                    }, 3000);
                    
                    showNotification('‚úÖ Reclama√ß√£o enviada com sucesso!', 'success');
                } else {
                    // Show error message
                    const errorMessage = `
                        <div class="message support">
                            <div style="margin-bottom: 8px;">
                                <strong>‚ùå Ops! Algo deu errado</strong>
                            </div>
                            <div>
                                N√£o conseguimos registrar sua reclama√ß√£o no momento. Tente novamente ou entre em contacto diretamente.
                            </div>
                        </div>
                    `;
                    
                    chatMessages.innerHTML += errorMessage;
                    scrollToBottom();
                    
                    showNotification(`‚ùå Erro ao enviar reclama√ß√£o: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar reclama√ß√£o:', error);
                
                // Remove loading message
                chatMessages.innerHTML = chatMessages.innerHTML.replace(loadingMessage, '');
                
                // Show error message
                const errorMessage = `
                    <div class="message support">
                        <div class="message-header">RatixPay</div>
                        <div class="message-content">
                        <div style="margin-bottom: 8px;">
                            <strong>‚ùå Erro de conex√£o</strong>
                        </div>
                        <div>
                            N√£o conseguimos conectar ao servidor. Verifique sua internet e tente novamente.
                            </div>
                        </div>
                    </div>
                `;
                
                chatMessages.innerHTML += errorMessage;
                scrollToBottom();
                
                showNotification('‚ùå Erro ao enviar reclama√ß√£o. Tente novamente.', 'error');
            }
        }
        
        // Get problem text
        function getProblemText(option) {
            const problems = {
                'link_quebrado': 'Link do produto quebrado',
                'produto_errado': 'Produto n√£o corresponde √† descri√ß√£o',
                'fraude': 'Fraude',
                'reembolso': 'Reembolso',
                'outro': 'Outro problema',
                'mais_info': 'Mais informa√ß√µes'
            };
            return problems[option] || option;
        }
        
        // Gerar link seguro do comprovativo
        function gerarLinkSeguro(numeroPedido, productId, clientName, amount) {
            const baseUrl = window.location.origin;
            // Usar idpedido se dispon√≠vel, sen√£o pedido
            const pedidoParam = idPedido ? `idpedido=${idPedido}` : `pedido=${numeroPedido}`;
            let url = `${baseUrl}/payment-success.html?${pedidoParam}&productId=${productId || ''}&clientName=${encodeURIComponent(clientName || '')}&amount=${amount || ''}`;
            
            // Sempre incluir par√¢metros UTM do localStorage se dispon√≠veis
            try {
                const savedUtmParams = localStorage.getItem('utm_tracking_params');
                if (savedUtmParams) {
                    const utmParams = JSON.parse(savedUtmParams);
                    const utmQueryParams = [];
                    
                    // Adicionar cada par√¢metro UTM se n√£o for null
                    if (utmParams.utm_source) utmQueryParams.push(`utm_source=${encodeURIComponent(utmParams.utm_source)}`);
                    if (utmParams.utm_medium) utmQueryParams.push(`utm_medium=${encodeURIComponent(utmParams.utm_medium)}`);
                    if (utmParams.utm_campaign) utmQueryParams.push(`utm_campaign=${encodeURIComponent(utmParams.utm_campaign)}`);
                    if (utmParams.utm_content) utmQueryParams.push(`utm_content=${encodeURIComponent(utmParams.utm_content)}`);
                    if (utmParams.utm_term) utmQueryParams.push(`utm_term=${encodeURIComponent(utmParams.utm_term)}`);
                    if (utmParams.src) utmQueryParams.push(`src=${encodeURIComponent(utmParams.src)}`);
                    if (utmParams.sck) utmQueryParams.push(`sck=${encodeURIComponent(utmParams.sck)}`);
                    
                    if (utmQueryParams.length > 0) {
                        url += '&' + utmQueryParams.join('&');
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao incluir par√¢metros UTM no link do comprovativo:', error);
            }
            
            return url;
        }
        
        // Copy receipt link to clipboard
        async function copyReceiptLink() {
            const receiptLink = gerarLinkSeguro(pedidoNumero, productId, clientName, amount);
            const copyBtn = document.querySelector('.btn-copy');
            
            try {
                await navigator.clipboard.writeText(receiptLink);
                
                // Visual feedback
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = '<i class="fas fa-check me-2"></i>Link Copiado!';
                
                showNotification('‚úÖ Link do comprovativo copiado para a √°rea de transfer√™ncia!', 'success');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = '<i class="fas fa-link me-2"></i>Copiar Link';
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro ao copiar link:', error);
                
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = receiptLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showNotification('‚úÖ Link do comprovativo copiado!', 'success');
                
                // Reset button
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = '<i class="fas fa-link me-2"></i>Copiar Link';
                }, 2000);
            }
        }
        
        // Share receipt
        async function shareReceipt() {
            const shareBtn = document.querySelector('.btn-share');
            
            if (!orderData) {
                showNotification('‚ùå Dados do comprovativo n√£o dispon√≠veis', 'error');
                return;
            }
            
            // Fun√ß√£o para formatar transaction_id do PayMoz como TXP_{8 √∫ltimos n√∫meros}
            const formatarTransactionIdPayMoz = (transactionId) => {
                if (!transactionId || transactionId === 'N/A') return transactionId;
                const txStr = String(transactionId);
                
                // Extrair apenas n√∫meros da transaction_id
                const numeros = txStr.replace(/\D/g, '');
                
                // Pegar os √∫ltimos 8 n√∫meros
                const ultimos8Numeros = numeros.length > 8 ? numeros.slice(-8) : numeros;
                
                // Se n√£o houver n√∫meros suficientes, usar o que tiver (preencher com zeros √† esquerda se necess√°rio)
                const numerosFormatados = ultimos8Numeros.padStart(Math.min(8, numeros.length), '0');
                
                // Adicionar prefixo TXP_
                return `TXP_${numerosFormatados}`;
            };
            
            const receiptData = {
                title: 'Comprovativo de Pagamento - RatixPay',
                text: `Comprovativo de pagamento aprovado!\n\n` +
                      `ID da Transa√ß√£o: ${formatarTransactionIdPayMoz(orderData.numeroPedido || 'N/A')}\n` +
                      `Produto: ${orderData.produto?.nome || 'Produto'}\n` +
                      `Valor: MZN ${orderData.produto?.valor || orderData.valor || '0,00'}\n` +
                      `Cliente: ${orderData.cliente?.nome || 'Cliente'}\n` +
                      `Data: ${document.getElementById('transactionDate').textContent}\n\n` +
                      `Obrigado por escolher RatixPay! üöÄ`,
                url: window.location.href
            };
            
            try {
                // Visual feedback
                shareBtn.classList.add('shared');
                shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Compartilhando...';
                
                if (navigator.share && navigator.canShare && navigator.canShare(receiptData)) {
                    // Use native share API if available
                    await navigator.share(receiptData);
                    showNotification('‚úÖ Comprovativo compartilhado com sucesso!', 'success');
                } else {
                    // Fallback: copy to clipboard
                    await navigator.clipboard.writeText(receiptData.text);
                    showNotification('‚úÖ Comprovativo copiado para compartilhar!', 'success');
                }
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    shareBtn.classList.remove('shared');
                    shareBtn.innerHTML = '<i class="fas fa-share-alt me-2"></i>Compartilhar';
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro ao compartilhar:', error);
                
                // Fallback: copy to clipboard
                try {
                    await navigator.clipboard.writeText(receiptData.text);
                    showNotification('‚úÖ Comprovativo copiado para compartilhar!', 'success');
                } catch (clipboardError) {
                    showNotification('‚ùå Erro ao compartilhar comprovativo', 'error');
                }
                
                // Reset button
                setTimeout(() => {
                    shareBtn.classList.remove('shared');
                    shareBtn.innerHTML = '<i class="fas fa-share-alt me-2"></i>Compartilhar';
                }, 2000);
            }
        }
        

        
        // Fun√ß√£o removida - envio autom√°tico implementado
        async function sendContentWhatsApp() {
            if (!orderData) {
                showNotification('‚ùå Dados do pedido n√£o dispon√≠veis', 'error');
                return;
            }
            
            // Get selected radio button
            const selectedOption = document.querySelector('input[name="whatsappOption"]:checked');
            let phoneNumber = orderData.cliente?.telefone || '';
            
            if (selectedOption && selectedOption.value === 'custom') {
                const customNumber = document.getElementById('customWhatsAppNumber').value.trim();
                if (!customNumber) {
                    showNotification('‚ùå Digite um n√∫mero de WhatsApp v√°lido', 'error');
                    return;
                }
                phoneNumber = customNumber;
            }
            
            if (!phoneNumber) {
                showNotification('‚ùå N√∫mero de WhatsApp n√£o encontrado', 'error');
                return;
            }
            
            const btn = document.getElementById('whatsappBtn');
            const originalText = btn.innerHTML;
            
            try {
                // Disable button and show loading
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
                
                const response = await fetch(`${API_BASE}/api/send-content-whatsapp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numeroPedido: orderData.numeroPedido,
                        clienteNome: orderData.cliente?.nome || 'Cliente',
                        clienteTelefone: phoneNumber,
                        produtoNome: orderData.produto?.nome || 'Produto',
                        linkConteudo: orderData.produto?.linkConteudo || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Conte√∫do enviado para WhatsApp com sucesso!');
                } else {
                    showNotification(`‚ùå Erro ao enviar WhatsApp: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar WhatsApp:', error);
                showNotification('‚ùå Erro ao enviar WhatsApp. Tente novamente.', 'error');
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Fun√ß√£o removida - envio autom√°tico implementado
        async function sendContentEmail() {
            if (!orderData) {
                showNotification('‚ùå Dados do pedido n√£o dispon√≠veis', 'error');
                return;
            }
            
            const btn = document.getElementById('emailBtn');
            const originalText = btn.innerHTML;
            
            try {
                // Disable button and show loading
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
                
                const response = await fetch(`${API_BASE}/api/send-content-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numeroPedido: orderData.numeroPedido,
                        clienteNome: orderData.cliente?.nome || 'Cliente',
                        clienteEmail: orderData.cliente?.email || '',
                        produtoNome: orderData.produto?.nome || 'Produto',
                        linkConteudo: orderData.produto?.linkConteudo || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Conte√∫do enviado para e-mail com sucesso!');
                } else {
                    showNotification(`‚ùå Erro ao enviar e-mail: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar e-mail:', error);
                showNotification('‚ùå Erro ao enviar e-mail. Tente novamente.', 'error');
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina de sucesso carregada');
            loadTransactionData();
            
            // Carregar conversa salva se existir
            carregarConversaDoNavegador();
            
            // Configurar scroll autom√°tico
            setupAutoScroll();
            // Remover mensagens com spinner
            removeSpinnerMessages();
            
            // Remover spinners periodicamente
            setInterval(removeSpinnerMessages, 1000);
        });
    </script>
    
    
    <!-- UTMify rastreamento removido - agora √© feito automaticamente pelo backend quando a venda √© aprovada -->
    
    
    <!-- Remover notifica√ß√£o de atualiza√ß√£o se aparecer -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Observar mudan√ßas no DOM para detectar notifica√ß√£o de atualiza√ß√£o
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        const updateNotification = document.getElementById('update-notification');
                        if (updateNotification) {
                            updateNotification.remove();
                            console.log('üóëÔ∏è Notifica√ß√£o de atualiza√ß√£o removida');
                        }
                    }
                });
            });
            
            // Observar mudan√ßas no body
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Verificar se j√° existe a notifica√ß√£o
            setTimeout(function() {
                const updateNotification = document.getElementById('update-notification');
                if (updateNotification) {
                    updateNotification.remove();
                    console.log('üóëÔ∏è Notifica√ß√£o de atualiza√ß√£o removida (verifica√ß√£o inicial)');
                }
            }, 1000);
        });
    </script>
</body>
</html>