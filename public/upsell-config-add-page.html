<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RatixPay - Criar P√°gina Upsell</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    
    <!-- Sistema de Autentica√ß√£o Global -->
    <script src="/js/server-check.js"></script>
    <script src="/js/global-auth.js"></script>
    
    <style>
        :root {
            --primary-color: #f64c00;
            --secondary-color: #E67E22;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --dark-bg: #1e293b;
            --light-bg: #f8f9fa;
            --border-color: #e9ecef;
            --upsell-purple: #667eea;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .upsell-page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .upsell-header {
            margin-bottom: 30px;
        }

        .upsell-header h1 {
            font-size: 2rem;
            color: var(--dark-bg);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .upsell-header h1 i {
            color: var(--upsell-purple);
        }

        .upsell-header p {
            font-size: 1rem;
            color: #64748b;
            margin: 0;
        }

        .form-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .form-section h2 {
            font-size: 1.5rem;
            color: var(--dark-bg);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--dark-bg);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group label .required {
            color: var(--danger-color);
            margin-left: 4px;
        }

        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
            background-color: #ffffff !important;
            color: #1e293b !important;
            -webkit-text-fill-color: #1e293b !important;
            opacity: 1 !important;
        }

        .form-group input[type="text"]::placeholder,
        .form-group input[type="url"]::placeholder,
        .form-group textarea::placeholder {
            color: #94a3b8 !important;
            -webkit-text-fill-color: #94a3b8 !important;
            opacity: 1 !important;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="url"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--upsell-purple);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: #ffffff !important;
            color: #1e293b !important;
            -webkit-text-fill-color: #1e293b !important;
        }

        /* Fix para inputs com autofill do navegador */
        .form-group input:-webkit-autofill,
        .form-group input:-webkit-autofill:hover,
        .form-group input:-webkit-autofill:focus,
        .form-group input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px white inset !important;
            -webkit-text-fill-color: #1e293b !important;
            background-color: #ffffff !important;
            color: #1e293b !important;
        }

        /* Container de produtos com scroll horizontal */
        .produtos-scroll-container {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            gap: 15px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 0 20px 0;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--upsell-purple) transparent;
            align-items: stretch;
            width: 100%;
        }

        .produtos-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .produtos-scroll-container::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }

        .produtos-scroll-container::-webkit-scrollbar-thumb {
            background: var(--upsell-purple);
            border-radius: 4px;
        }

        .produtos-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Estilos para cards de produtos */
        .produto-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            flex: 0 0 220px !important;
            width: 220px !important;
            min-width: 220px !important;
            max-width: 220px !important;
            display: block;
            box-sizing: border-box;
        }

        .produto-card:hover {
            border-color: var(--upsell-purple);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .produto-card.selected {
            border-color: var(--upsell-purple);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .produto-card.selected::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 30px 30px 0;
            border-color: transparent var(--upsell-purple) transparent transparent;
        }

        .produto-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 2px;
            right: 2px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            z-index: 1;
        }

        .produto-card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #f0f0f0;
        }

        .produto-card-nome {
            font-weight: 600;
            color: var(--dark-bg);
            margin-bottom: 8px;
            font-size: 0.95rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.8em;
        }

        .produto-card-preco {
            color: var(--success-color);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .produto-card-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            min-width: 100%;
        }

        .produto-card-empty i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Indicadores de scroll */
        .scroll-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .scroll-indicator:hover {
            background: var(--upsell-purple);
            color: white;
            border-color: var(--upsell-purple);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .scroll-indicator.left {
            left: -20px;
        }

        .scroll-indicator.right {
            right: -20px;
        }

        /* Responsividade mobile */
        @media (max-width: 768px) {
            .produto-card {
                width: 180px;
                min-width: 180px;
                max-width: 180px;
            }

            .produto-card-image {
                height: 120px;
            }

            .scroll-indicator {
                display: none !important;
            }

            .produtos-scroll-container {
                padding: 10px 0 15px 0;
            }

            #produtos-container-wrapper {
                margin: 0 -20px;
                padding: 0 20px;
            }
        }

        @media (max-width: 480px) {
            .produto-card {
                width: 160px;
                min-width: 160px;
                max-width: 160px;
                padding: 12px;
            }

            .produto-card-image {
                height: 100px;
            }

            .produto-card-nome {
                font-size: 0.85rem;
            }

            .produto-card-preco {
                font-size: 1rem;
            }
        }

        .form-group .help-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 6px;
        }

        /* Preview Section - Template Simples */
        .preview-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .preview-section h2 {
            font-size: 1.5rem;
            color: var(--dark-bg);
            margin-bottom: 25px;
        }

        .preview-container {
            background: #f5f7fa;
            padding: 40px;
            border-radius: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .preview-content {
            background: #ffffff;
            width: 95%;
            max-width: 570px;
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .preview-content h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #333;
        }

        .preview-content h3 {
            font-size: 18px;
            font-weight: 400;
            color: #555;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #4a90e2;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #4a90e2;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-area:hover {
            background: #f0f7ff;
            border-color: #3578c6;
        }

        .upload-area.has-video {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-area i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .upload-area .upload-text {
            font-size: 1rem;
            font-weight: 600;
        }

        .upload-area .upload-hint {
            font-size: 0.85rem;
            margin-top: 5px;
            opacity: 0.8;
        }

        video {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        video.show {
            display: block;
        }

        .btn-preview {
            display: block;
            width: 100%;
            background: #4a90e2;
            color: white;
            padding: 14px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 18px;
            margin-top: 10px;
            transition: 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-preview:hover {
            background: #3578c6;
        }

        .btn-preview:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 150px;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--upsell-purple) 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--light-bg);
            color: var(--dark-bg);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .toast.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        /* Estilos para Order Bumps - MELHORADOS */
        .order-bump-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 22px;
            display: flex;
            align-items: flex-start;
            gap: 18px;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .order-bump-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--upsell-purple) 0%, #764ba2 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .order-bump-item:hover {
            border-color: var(--upsell-purple);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        .order-bump-item:hover::before {
            transform: scaleX(1);
        }
        
        .order-bump-image {
            width: 100px;
            height: 100px;
            min-width: 100px;
            border-radius: 12px;
            object-fit: cover;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .order-bump-item:hover .order-bump-image {
            transform: scale(1.05);
            border-color: var(--upsell-purple);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .order-bump-info {
            flex: 1;
            min-width: 0;
        }
        
        .order-bump-title {
            font-weight: 700;
            color: var(--dark-bg);
            margin-bottom: 8px;
            font-size: 1.1rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .order-bump-description {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 10px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .order-bump-price {
            color: var(--success-color);
            font-weight: 800;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-bump-price::before {
            content: 'üí∞';
            font-size: 1.1rem;
        }
        
        .order-bump-remove {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.2);
            white-space: nowrap;
        }
        
        .order-bump-remove:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .order-bump-remove:active {
            transform: translateY(0);
        }
        
        .order-bump-max-msg {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border: 2px solid #ffc107;
            color: #856404;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
            animation: slideInDown 0.3s ease;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .order-bump-max-msg i {
            font-size: 1.2rem;
            color: #ffc107;
        }
        
        .order-bumps-empty {
            text-align: center;
            padding: 50px 20px;
            color: #64748b;
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            transition: all 0.3s ease;
        }
        
        .order-bumps-empty:hover {
            border-color: var(--upsell-purple);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .order-bumps-empty i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.4;
            background: linear-gradient(135deg, var(--upsell-purple) 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .order-bumps-empty div:first-of-type {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark-bg);
            margin-bottom: 8px;
        }
        
        .order-bumps-empty div:last-of-type {
            font-size: 0.95rem;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .preview-container {
                padding: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
            
            .order-bump-item {
                flex-direction: column;
                text-align: center;
            }
            
            .order-bump-image {
                width: 100%;
                height: 200px;
            }
        }

        /* Estilos para Editor Inline - MELHORADOS */
        .edit-mode-active [data-editable] {
            outline: 3px dashed #22c55e !important;
            outline-offset: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Label flutuante para elementos edit√°veis */
        .edit-mode-active [data-editable]::after {
            content: attr(data-edit-label);
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }

        .edit-mode-active [data-editable]:hover::after {
            opacity: 1;
        }

        .edit-mode-active [data-editable="text"]:hover,
        .edit-mode-active [data-editable="button-text"]:hover {
            background: rgba(34, 197, 94, 0.15) !important;
            outline-color: #16a34a !important;
        }

        .edit-mode-active [data-editable="media"] {
            outline-color: #f97316 !important;
        }

        .edit-mode-active [data-editable="media"]:hover {
            outline-color: #ea580c !important;
            background: rgba(249, 115, 22, 0.1) !important;
        }

        .edit-mode-active [data-editable="media"]::after {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.4) !important;
        }

        .edit-mode-active [data-editable][contenteditable="true"] {
            outline: 3px solid #3b82f6 !important;
            outline-offset: 2px;
            background: rgba(59, 130, 246, 0.1) !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .edit-mode-active [data-editable][contenteditable="true"]::after {
            content: '‚úèÔ∏è EDITANDO...';
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            opacity: 1 !important;
            animation: pulse-edit 1s infinite;
        }

        @keyframes pulse-edit {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        /* Indicador de elemento editado com sucesso */
        .edit-mode-active [data-user-edited="true"]::before {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #22c55e;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.5);
        }

        .template-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.02);
            pointer-events: none;
            z-index: 1;
        }

        #template-content {
            position: relative;
            z-index: 2;
        }

        /* Barra de instru√ß√µes de edi√ß√£o */
        .edit-instructions-bar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
        }

        .edit-instructions-bar.active {
            display: flex;
        }

        .edit-instructions-bar .instruction {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-instructions-bar .instruction i {
            font-size: 1.1rem;
        }

        .edit-instructions-bar .instruction.text i { color: #22c55e; }
        .edit-instructions-bar .instruction.media i { color: #f97316; }
        .edit-instructions-bar .instruction.editing i { color: #3b82f6; }

        /* Contador de edi√ß√µes */
        .edit-counter {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-left: auto;
        }

        .edit-counter strong {
            color: #22c55e;
        }

        .media-upload-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            z-index: 20;
            display: none;
        }

        .edit-mode-active [data-editable="media"] .media-upload-indicator {
            display: block;
        }

        /* Modal de Upload de M√≠dia */
        .media-modal-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 999999 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .media-modal-overlay.active {
            opacity: 1 !important;
            visibility: visible !important;
            display: flex !important;
        }
        
        /* Garantir que o modal de order bumps seja sempre vis√≠vel quando ativo */
        #order-bump-modal.active,
        #order-bump-modal[style*="display: flex"],
        #order-bump-modal[style*="display:flex"] {
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 999999 !important;
            display: flex !important;
            position: fixed !important;
        }

        .media-modal {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .media-modal-overlay.active .media-modal {
            transform: scale(1) translateY(0);
        }

        .media-modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .media-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .media-modal-header h3 i {
            color: #f97316;
        }

        .media-modal-close {
            background: #f1f5f9;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .media-modal-close:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .media-modal-body {
            padding: 24px;
        }

        .media-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: #f1f5f9;
            padding: 6px;
            border-radius: 12px;
        }

        .media-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: #64748b;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .media-tab:hover {
            color: #1e293b;
        }

        .media-tab.active {
            background: white;
            color: #f97316;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .media-tab-content {
            display: none;
        }

        .media-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Upload Area */
        .upload-drop-area {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-drop-area:hover,
        .upload-drop-area.dragover {
            border-color: #f97316;
            background: #fff7ed;
        }

        .upload-drop-area i {
            font-size: 3rem;
            color: #f97316;
            margin-bottom: 16px;
        }

        .upload-drop-area h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .upload-drop-area p {
            color: #64748b;
            font-size: 0.9rem;
            margin: 0;
        }

        .upload-drop-area .upload-hint {
            margin-top: 12px;
            padding: 8px 16px;
            background: #e2e8f0;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #475569;
            display: inline-block;
        }

        /* Embed Area */
        .embed-input-group {
            margin-bottom: 20px;
        }

        .embed-input-group label {
            display: block;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .embed-input-group {
            position: relative;
            z-index: 1;
        }
        
        .embed-input-group textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            resize: vertical;
            transition: all 0.2s ease;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
            background: white;
        }

        .embed-input-group textarea:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .embed-input-group .help-text {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 8px;
        }

        .embed-platforms {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .embed-platform {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #475569;
        }

        .embed-platform i {
            font-size: 1rem;
        }

        .embed-platform.youtube i { color: #FF0000; }
        .embed-platform.vimeo i { color: #1AB7EA; }
        .embed-platform.cloudinary i { color: #3448C5; }
        .embed-platform.html i { color: #E34F26; }

        /* URL Input */
        .url-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .url-input-wrapper input {
            width: 100%;
            padding: 16px 16px 16px 50px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .url-input-wrapper input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .url-input-wrapper i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1.1rem;
        }

        /* Preview Area */
        .media-preview {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            background: #0f172a;
            aspect-ratio: 16/9;
            display: none;
            position: relative;
            z-index: 100;
            isolation: isolate;
        }

        .media-preview.has-content {
            display: block;
            z-index: 100;
            position: relative;
        }

        .media-preview video,
        .media-preview iframe {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: relative;
            z-index: 10;
        }
        
        .media-preview #media-preview-content {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
        }

        .media-preview-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }

        .media-preview-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .media-preview-btn:hover {
            background: rgba(249, 115, 22, 0.9);
        }

        /* Upload Progress */
        .upload-progress {
            margin-top: 20px;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .upload-progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f97316, #ea580c);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .upload-progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #64748b;
        }

        /* Modal Footer */
        .media-modal-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .media-modal-footer .btn {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Menu Lateral -->
        <div class="sidebar">
            <!-- Ser√° preenchido pelo SidebarComponent -->
        </div>

        <!-- Conte√∫do Principal -->
        <div class="main-content">
            <div class="upsell-page-container">
                <!-- Header -->
                <div class="upsell-header">
                    <h1>
                        <i class="fas fa-arrow-up"></i>
                        <span id="page-title">Criar P√°gina Upsell</span>
                    </h1>
                    <p>Crie uma p√°gina simples e moderna para oferecer produtos complementares aos seus clientes</p>
                </div>

                <!-- Formul√°rio -->
                <form id="upsell-form" class="form-section">
                    <h2>
                        <i class="fas fa-edit"></i>
                        Configura√ß√µes da P√°gina
                    </h2>

                    <!-- ID de Refer√™ncia da P√°gina -->
                    <div class="form-group">
                        <label for="page-slug">
                            ID de Refer√™ncia (Slug) <span class="required">*</span>
                        </label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1; position: relative;">
                                <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; font-size: 0.9rem; z-index: 1; pointer-events: none; background: white; padding-right: 4px;">/upsell/</span>
                                <input 
                                    type="text" 
                                    id="page-slug" 
                                    name="slug"
                                    placeholder="minha-oferta-especial"
                                    required
                                    pattern="^[a-z0-9]+(?:-[a-z0-9]+)*$"
                                    title="Use apenas letras min√∫sculas, n√∫meros e h√≠fens"
                                    style="width: 100%; padding: 14px 16px 14px 75px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; box-sizing: border-box; background: white; color: #1e293b;"
                                    oninput="formatarSlug(this)"
                                />
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="gerarSlugAleatorio()" style="white-space: nowrap;">
                                <i class="fas fa-random"></i>
                                Gerar
                            </button>
                        </div>
                        <div class="help-text">
                            <i class="fas fa-link"></i> URL final: <strong id="url-preview">https://seusite.com/upsell/<span id="slug-preview">...</span></strong>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="page-name">
                            Nome da P√°gina <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="page-name" 
                            name="nome"
                            placeholder="Ex: Oferta Especial Black Friday"
                            required
                            style="width: 100%; padding: 14px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; box-sizing: border-box; background: white; color: #1e293b;"
                        />
                        <div class="help-text">
                            Nome interno para identificar esta p√°gina no painel.
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="template-select">
                            Template da P√°gina <span class="required">*</span>
                        </label>
                        <select 
                            id="template-select" 
                            name="template_id"
                            required
                            style="width: 100%; padding: 14px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; box-sizing: border-box; background: white;"
                            onchange="carregarTemplateParaEdicao(this.value)"
                        >
                            <option value="">Carregando templates...</option>
                        </select>
                        <div class="help-text">
                            Escolha o template visual que ser√° usado para exibir a p√°gina de upsell. Ap√≥s selecionar, voc√™ poder√° editar diretamente o template.
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="produtos_upsell">
                            Produtos para Oferta Upsell <span class="required">*</span>
                        </label>
                        
                        <!-- Campo de busca -->
                        <div style="margin-bottom: 15px; position: relative;">
                        <input 
                            type="text" 
                                id="produto-search" 
                                placeholder="Buscar produto por nome..."
                                style="width: 100%; padding: 12px 16px 12px 45px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; transition: all 0.3s ease; box-sizing: border-box;"
                                oninput="filtrarProdutos(this.value)"
                            />
                            <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; pointer-events: none;"></i>
                        </div>
                        
                        <!-- Container de produtos com scroll horizontal -->
                        <div id="produtos-container-wrapper" style="position: relative;">
                            <div id="produtos-container" class="produtos-scroll-container" style="display: flex; flex-direction: row; flex-wrap: nowrap;">
                                <div style="text-align: center; padding: 20px; color: #64748b; flex: 0 0 200px; min-width: 200px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <div>Carregando produtos...</div>
                                </div>
                            </div>

                            <!-- Indicadores de scroll -->
                            <div class="scroll-indicator left" id="scroll-left" style="display: none;" onclick="scrollProdutos('left')">
                                <i class="fas fa-chevron-left"></i>
                            </div>
                            <div class="scroll-indicator right" id="scroll-right" style="display: none;" onclick="scrollProdutos('right')">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <div class="help-text" style="margin-top: 15px;">
                            Selecione um ou mais produtos que ser√£o oferecidos nesta p√°gina de upsell. O nome ser√° carregado automaticamente da estrutura do produto. Use a busca para encontrar produtos rapidamente.
                        </div>
                    </div>

                </form>

                <!-- Se√ß√£o de Order Bumps (Produtos Complementares) -->
                <div class="form-section" id="order-bumps-section">
                    <h2>
                        <i class="fas fa-gift"></i>
                        Produtos Order Bumps
                    </h2>
                    <p style="color: #64748b; margin-bottom: 20px;">
                        Adicione at√© 3 produtos complementares que aparecer√£o na p√°gina de upsell como "Leva mais uma oferta extra". Estes produtos ser√£o oferecidos junto com o produto principal.
                    </p>
                    
                    <!-- Lista de Order Bumps Adicionados -->
                    <div id="order-bumps-list" style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <!-- Order bumps ser√£o inseridos aqui -->
                    </div>
                    
                    <!-- Bot√£o para adicionar Order Bump -->
                    <button type="button" class="btn btn-secondary" id="add-order-bump-btn">
                        <i class="fas fa-plus"></i>
                        Adicionar Order Bump
                    </button>
                    <div class="help-text" style="margin-top: 15px;">
                        <i class="fas fa-info-circle"></i>
                        Order Bumps aparecem como produtos extras que o cliente pode adicionar ao pedido. M√°ximo de 3 produtos.
                    </div>
                </div>

                <!-- Editor de Template -->
                <div id="template-editor-section" class="form-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>
                            <i class="fas fa-edit"></i>
                            Preview do Template
                        </h2>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="toggleEditMode()" id="toggle-edit-btn">
                                <i class="fas fa-pencil-alt"></i>
                                Modo Edi√ß√£o
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="previewFullscreen()">
                                <i class="fas fa-expand"></i>
                                Tela Cheia
                            </button>
                        </div>
                    </div>
                    <!-- Barra de instru√ß√µes de edi√ß√£o -->
                    <div class="edit-instructions-bar" id="edit-instructions">
                        <div class="instruction text">
                            <i class="fas fa-font"></i>
                            <span><strong>Verde:</strong> Clique para editar texto</span>
                        </div>
                        <div class="instruction media">
                            <i class="fas fa-video"></i>
                            <span><strong>Laranja:</strong> Clique para adicionar v√≠deo</span>
                        </div>
                        <div class="instruction editing">
                            <i class="fas fa-edit"></i>
                            <span><strong>Azul:</strong> Elemento sendo editado</span>
                        </div>
                        <div class="edit-counter">
                            <i class="fas fa-check-circle"></i>
                            <span><strong id="edit-count">0</strong> altera√ß√µes</span>
                        </div>
                    </div>
                    
                    <div class="help-text" style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                        <strong><i class="fas fa-info-circle"></i> Como editar:</strong><br>
                        ‚Ä¢ Ative o "Modo Edi√ß√£o" para poder clicar e editar os textos diretamente<br>
                        ‚Ä¢ Clique em √°reas de v√≠deo/imagem para fazer upload de m√≠dia<br>
                        ‚Ä¢ As altera√ß√µes s√£o salvas automaticamente ao desativar o modo edi√ß√£o
                    </div>
                    
                    <!-- Preview com Iframe para mostrar template com estilos completos -->
                    <div id="template-preview-wrapper" style="position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); background: #09090b;">
                        <!-- Barra de navega√ß√£o simulada -->
                        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 12px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></div>
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: #eab308;"></div>
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></div>
                        </div>
                            <div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 6px; padding: 8px 16px; color: #94a3b8; font-size: 13px; font-family: monospace;">
                                <i class="fas fa-lock" style="margin-right: 8px; color: #22c55e;"></i>
                                https://seusite.com/upsell/<span id="preview-slug" style="color: #f97316;">oferta-especial</span>
                    </div>
                            <div style="display: flex; gap: 8px; color: #64748b;">
                                <i class="fas fa-desktop" style="cursor: pointer;" onclick="setPreviewSize('desktop')" title="Desktop"></i>
                                <i class="fas fa-tablet-alt" style="cursor: pointer;" onclick="setPreviewSize('tablet')" title="Tablet"></i>
                                <i class="fas fa-mobile-alt" style="cursor: pointer;" onclick="setPreviewSize('mobile')" title="Mobile"></i>
                            </div>
                        </div>
                        
                        <!-- Container do iframe com responsividade -->
                        <div id="iframe-container" style="transition: all 0.3s ease; margin: 0 auto; background: #09090b;">
                            <iframe 
                                id="template-iframe" 
                                style="width: 100%; height: 800px; border: none; display: block;"
                            ></iframe>
                        </div>
                    </div>
                    
                    <!-- Container escondido para manipula√ß√£o do HTML -->
                    <div id="template-content" style="display: none;"></div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" id="save-btn" onclick="salvarPagina()">
                        <i class="fas fa-save"></i>
                        Salvar P√°gina
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='upsell-config.html'">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Upload de M√≠dia -->
    <div class="media-modal-overlay" id="media-modal">
        <div class="media-modal">
            <div class="media-modal-header">
                <h3><i class="fas fa-video"></i> Adicionar V√≠deo</h3>
                <button class="media-modal-close" onclick="fecharModalMidia()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="media-modal-body">
                <!-- Tabs -->
                <div class="media-tabs">
                    <button class="media-tab active" onclick="trocarTabMidia('upload')" data-tab="upload">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Upload
                    </button>
                    <button class="media-tab" onclick="trocarTabMidia('embed')" data-tab="embed">
                        <i class="fas fa-code"></i>
                        Incorporar
                    </button>
                    <button class="media-tab" onclick="trocarTabMidia('url')" data-tab="url">
                        <i class="fas fa-link"></i>
                        URL
                    </button>
                </div>
                
                <!-- Tab: Upload -->
                <div class="media-tab-content active" id="tab-upload">
                    <div class="upload-drop-area" id="upload-drop-area" onclick="document.getElementById('video-file-input').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4 id="upload-title">Arraste o v√≠deo aqui ou clique para selecionar</h4>
                        <p id="upload-description">Suporta MP4, WebM, MOV, AVI at√© 500MB</p>
                        <span class="upload-hint" id="upload-hint">
                            <i class="fas fa-info-circle"></i>
                            <span id="upload-hint-text">Recomendado: 1080p, formato 16:9</span>
                        </span>
                    </div>
                    <input type="file" id="video-file-input" accept="video/*,image/*" style="display: none;" onchange="handleVideoFileSelect(this.files[0])">
                    
                    <div class="upload-progress" id="upload-progress">
                        <div class="upload-progress-bar">
                            <div class="upload-progress-fill" id="upload-progress-fill"></div>
                        </div>
                        <div class="upload-progress-text">
                            <span id="upload-status">Enviando...</span>
                            <span id="upload-percent">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Embed -->
                <div class="media-tab-content" id="tab-embed">
                    <div class="embed-input-group">
                        <label for="embed-code">C√≥digo de incorpora√ß√£o (iframe/embed)</label>
                        <textarea 
                            id="embed-code" 
                            placeholder='<iframe src="https://www.youtube.com/embed/VIDEO_ID" ...></iframe>

ou

<video src="https://seu-video.mp4" controls></video>'
                            oninput="previewEmbed()"
                        ></textarea>
                        <p class="help-text">
                            Cole o c√≥digo iframe do YouTube, Vimeo, ou qualquer c√≥digo HTML de v√≠deo.
                        </p>
                    </div>
                    
                    <div class="embed-platforms">
                        <div class="embed-platform youtube">
                            <i class="fab fa-youtube"></i>
                            YouTube
                        </div>
                        <div class="embed-platform vimeo">
                            <i class="fab fa-vimeo-v"></i>
                            Vimeo
                        </div>
                        <div class="embed-platform cloudinary">
                            <i class="fas fa-cloud"></i>
                            Cloudinary
                        </div>
                        <div class="embed-platform html">
                            <i class="fas fa-code"></i>
                            HTML Puro
                        </div>
                    </div>
                </div>
                
                <!-- Tab: URL -->
                <div class="media-tab-content" id="tab-url">
                    <div class="embed-input-group">
                        <label for="video-url" id="url-label">URL do V√≠deo</label>
                        <div class="url-input-wrapper">
                            <i class="fas fa-link"></i>
                            <input 
                                type="url" 
                                id="video-url" 
                                placeholder="https://exemplo.com/video.mp4"
                                oninput="previewVideoUrl()"
                            >
                        </div>
                        <p class="help-text" id="url-help-text">
                            Cole a URL direta do v√≠deo (MP4, WebM) ou link do YouTube/Vimeo.
                        </p>
                    </div>
                    
                    <div class="embed-input-group" id="youtube-section" style="margin-top: 16px;">
                        <label>Ou cole um link do YouTube/Vimeo</label>
                        <div class="url-input-wrapper">
                            <i class="fab fa-youtube" style="color: #FF0000;"></i>
                            <input 
                                type="url" 
                                id="youtube-url" 
                                placeholder="https://www.youtube.com/watch?v=VIDEO_ID"
                                oninput="convertYoutubeUrl()"
                            >
                        </div>
                    </div>
                    
                    <div class="embed-input-group" id="vturb-section" style="margin-top: 16px;">
                        <label><i class="fas fa-video" style="color: #667eea; margin-right: 8px;"></i> Link da VTurb</label>
                        <div class="url-input-wrapper">
                            <i class="fas fa-video" style="color: #667eea;"></i>
                            <input 
                                type="url" 
                                id="vturb-url" 
                                placeholder="https://vturb.com/video/VIDEO_ID ou https://player.vturb.com/VIDEO_ID"
                                oninput="convertVturbUrl()"
                            >
                        </div>
                        <p class="help-text" style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">
                            <i class="fas fa-info-circle"></i> Cole o link do v√≠deo da VTurb. O sistema ir√° gerar automaticamente o c√≥digo de incorpora√ß√£o.
                        </p>
                    </div>
                </div>
                
                <!-- Preview -->
                <div class="media-preview" id="media-preview">
                    <div id="media-preview-content"></div>
                    <div class="media-preview-overlay">
                        <button class="media-preview-btn" onclick="limparPreview()" title="Limpar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="media-modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalMidia()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-primary" id="btn-aplicar-midia" onclick="aplicarMidia()" disabled>
                    <i class="fas fa-check"></i>
                    <span id="btn-aplicar-texto">Aplicar M√≠dia</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Order Bumps -->
    <div class="media-modal-overlay" id="order-bump-modal">
        <div class="media-modal" style="max-width: 1000px;">
            <div class="media-modal-header" style="background: linear-gradient(135deg, var(--upsell-purple) 0%, #764ba2 100%); color: white; border-radius: 20px 20px 0 0; padding: 24px;">
                <h3 style="color: white; margin: 0;">
                    <i class="fas fa-gift" style="margin-right: 10px;"></i> 
                    Selecionar Produto Order Bump
                </h3>
                <button class="media-modal-close" onclick="fecharModalOrderBumps()" style="color: white; background: rgba(255,255,255,0.2);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="media-modal-body" style="padding: 24px;">
                <div style="margin-bottom: 24px; position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #64748b; z-index: 1; pointer-events: none;"></i>
                    <input 
                        type="text" 
                        id="order-bump-search"
                        placeholder="Buscar por nome, ID ou descri√ß√£o..."
                        style="width: 100%; padding: 14px 18px 14px 48px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 0.95rem; transition: all 0.3s ease;"
                        oninput="filtrarOrderBumps(this.value)"
                        onfocus="this.style.borderColor='var(--upsell-purple)'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';"
                        onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';"
                    />
                    <div id="order-bump-search-count" style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #64748b; font-size: 0.85rem; pointer-events: none;">
                        <span id="order-bump-count-text">0 produtos</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; padding: 12px 16px; background: #f8f9fa; border-radius: 10px; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #64748b;">
                    <i class="fas fa-info-circle" style="color: var(--upsell-purple);"></i>
                    <span>Selecione um produto para adicionar como order bump. M√°ximo de <strong>3 produtos</strong> por p√°gina de upsell.</span>
                </div>
                
                <div id="order-bump-products-list" class="produtos-scroll-container" style="max-height: 550px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 18px; padding: 10px 0;">
                    <!-- Produtos ser√£o inseridos aqui -->
                </div>
            </div>
            
            <div class="media-modal-footer" style="padding: 20px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #64748b; font-size: 0.9rem;">
                    <i class="fas fa-check-circle" style="color: var(--success-color); margin-right: 6px;"></i>
                    <span id="order-bump-selected-count">${orderBumpsSelecionados.length}/3 selecionados</span>
                </div>
                <button class="btn btn-secondary" onclick="fecharModalOrderBumps()" style="min-width: 120px;">
                    <i class="fas fa-times"></i>
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/server-check.js"></script>
    <script src="js/config.js"></script>
    <script src="js/sidebar-component.js"></script>
    
    <script>
        let videoUrl = null;
        let videoPublicId = null;
        let videoEmbed = null;
        let videoType = 'upload'; // 'upload' ou 'embed'
        let pageId = null;
        let isEditing = false;
        let produtosDisponiveis = [];
        let produtosSelecionados = []; // Array de IDs dos produtos selecionados
        let produtosFiltrados = []; // Produtos filtrados pela busca
        let templatesDisponiveis = []; // Templates dispon√≠veis
        let orderBumpsSelecionados = []; // Array de objetos de produtos order bumps (m√°ximo 3)

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = new SidebarComponent();
            sidebar.init('integracoes');
            
            // Verificar se est√° editando
            const urlParams = new URLSearchParams(window.location.search);
            pageId = urlParams.get('id');
            const produtoId = urlParams.get('produtoId');
            const produtoNome = urlParams.get('produtoNome');
            
            // Auto-gerar slug ao digitar nome (apenas se slug estiver vazio)
            const pageNameInput = document.getElementById('page-name');
            const pageSlugInput = document.getElementById('page-slug');
            
            pageNameInput.addEventListener('input', function() {
                // S√≥ gerar automaticamente se o slug ainda estiver vazio
                if (!pageSlugInput.value.trim()) {
                    gerarSlugDoNome();
                }
            });
            
            // Gerar slug inicial aleat√≥rio se for nova p√°gina
            if (!pageId) {
                gerarSlugAleatorio();
            }
            
            // Carregar templates primeiro
            carregarTemplates().then(() => {
                // Carregar produtos do vendedor
                carregarProdutosVendedor();
                
                if (pageId) {
                    isEditing = true;
                    document.getElementById('page-title').textContent = 'Editar P√°gina Upsell';
                    carregarPagina(pageId);
                } else if (produtoId) {
                    // Armazenar produto_id para pr√©-selecionar quando produtos carregarem
                    window.produtoIdFromUrl = produtoId;
                }
            });

            // Event listeners removidos - elementos n√£o existem mais (editados diretamente no template)
            
            // Adicionar event listener ao bot√£o de order bumps
            const addOrderBumpBtn = document.getElementById('add-order-bump-btn');
            if (addOrderBumpBtn) {
                addOrderBumpBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîò Bot√£o de order bump clicado');
                    
                    // Tentar chamar a fun√ß√£o diretamente
                    try {
                        if (typeof abrirModalOrderBumps === 'function') {
                            abrirModalOrderBumps();
                        } else if (typeof window.abrirModalOrderBumps === 'function') {
                            window.abrirModalOrderBumps();
                        } else {
                            // Se a fun√ß√£o ainda n√£o foi definida, aguardar um pouco
                            console.warn('‚ö†Ô∏è Fun√ß√£o ainda n√£o definida, aguardando...');
                            let tentativas = 0;
                            const checkInterval = setInterval(() => {
                                tentativas++;
                                if (typeof abrirModalOrderBumps === 'function' || typeof window.abrirModalOrderBumps === 'function') {
                                    clearInterval(checkInterval);
                                    const fn = abrirModalOrderBumps || window.abrirModalOrderBumps;
                                    fn();
                                } else if (tentativas >= 10) {
                                    clearInterval(checkInterval);
                                    console.error('‚ùå Fun√ß√£o abrirModalOrderBumps n√£o encontrada ap√≥s 1 segundo!');
                                    alert('Erro: Fun√ß√£o n√£o encontrada. Recarregue a p√°gina.');
                                }
                            }, 100);
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao chamar abrirModalOrderBumps:', error);
                        alert('Erro ao abrir modal: ' + error.message);
                    }
                });
                console.log('‚úÖ Event listener adicionado ao bot√£o de order bumps');
            } else {
                console.warn('‚ö†Ô∏è Bot√£o de order bumps n√£o encontrado no DOM');
            }
        });

        // Fun√ß√£o para carregar templates dispon√≠veis
        async function carregarTemplates() {
            try {
                const response = await fetch('/templates/upsell/templates.json');
                if (!response.ok) {
                    throw new Error('Erro ao carregar templates');
                }
                
                const data = await response.json();
                templatesDisponiveis = data.templates || [];
                
                const select = document.getElementById('template-select');
                select.innerHTML = '<option value="">Selecione um template...</option>';
                
                templatesDisponiveis.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = `${template.nome} - ${template.descricao}`;
                    select.appendChild(option);
                });
                
                // Se n√£o estiver editando, selecionar o primeiro template por padr√£o
                if (!isEditing && templatesDisponiveis.length > 0) {
                    select.value = templatesDisponiveis[0].id;
                    carregarTemplateParaEdicao(templatesDisponiveis[0].id);
                }
            } catch (error) {
                console.error('Erro ao carregar templates:', error);
                mostrarToast('Erro ao carregar templates: ' + error.message, 'error');
            }
        }

        let editModeActive = false;
        let templateHtmlOriginal = null;
        let currentTemplateId = null;
        let editCount = 0;
        let savedAttributes = {}; // Armazenar todos os atributos editados
        
        // ===============================================
        // FUN√á√ïES DE SLUG E ID DE REFER√äNCIA
        // ===============================================
        
        // Formatar slug (apenas letras min√∫sculas, n√∫meros e h√≠fens)
        function formatarSlug(input) {
            let value = input.value.toLowerCase();
            value = value.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // Remove acentos
            value = value.replace(/[^a-z0-9-]/g, '-'); // Substitui caracteres inv√°lidos por h√≠fen
            value = value.replace(/-+/g, '-'); // Remove h√≠fens duplicados
            value = value.replace(/^-|-$/g, ''); // Remove h√≠fens no in√≠cio e fim
            input.value = value;
            
            // Atualizar preview da URL
            document.getElementById('slug-preview').textContent = value || '...';
            document.getElementById('preview-slug').textContent = value || 'oferta-especial';
        }
        
        // Gerar slug aleat√≥rio
        function gerarSlugAleatorio() {
            const adjectives = ['super', 'mega', 'ultra', 'hiper', 'premium', 'exclusivo', 'especial', 'unico'];
            const nouns = ['oferta', 'promocao', 'desconto', 'bonus', 'upgrade', 'pack', 'combo', 'deal'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const num = Math.floor(Math.random() * 999) + 1;
            
            const slug = `${adj}-${noun}-${num}`;
            document.getElementById('page-slug').value = slug;
            formatarSlug(document.getElementById('page-slug'));
        }
        
        // Gerar slug a partir do nome da p√°gina
        function gerarSlugDoNome() {
            const nome = document.getElementById('page-name').value;
            if (nome) {
                let slug = nome.toLowerCase();
                slug = slug.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                slug = slug.replace(/[^a-z0-9]+/g, '-');
                slug = slug.replace(/^-|-$/g, '');
                document.getElementById('page-slug').value = slug;
                formatarSlug(document.getElementById('page-slug'));
            }
        }
        
        // Sanitizar template HTML para edi√ß√£o (remove scripts que causam conflitos)
        function sanitizarTemplateParaEdicao(html) {
            // Criar um parser de DOM tempor√°rio
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Remover scripts que podem causar conflitos no iframe
            const scripts = doc.querySelectorAll('script');
            scripts.forEach(script => {
                const content = script.textContent || '';
                // Remover scripts que declaram vari√°veis globais ou fun√ß√µes de intera√ß√£o
                if (content.includes('const API_BASE') || 
                    content.includes('let API_BASE') ||
                    content.includes('var API_BASE') ||
                    content.includes('triggerPurchase') ||
                    content.includes('handleRefusal') ||
                    content.includes('processOneClickUpsell')) {
                    script.remove();
                }
            });
            
            // Remover atributos onclick dos bot√µes (ser√£o tratados pelo editor)
            doc.querySelectorAll('[onclick]').forEach(el => {
                // Salvar o onclick original como data attribute para restaurar depois
                el.setAttribute('data-original-onclick', el.getAttribute('onclick'));
                el.removeAttribute('onclick');
            });
            
            // Remover estilos de edi√ß√£o anteriores se existirem
            const editStyles = doc.getElementById('edit-mode-styles');
            if (editStyles) editStyles.remove();
            
            const dynamicStyles = doc.getElementById('dynamic-edit-styles');
            if (dynamicStyles) dynamicStyles.remove();
            
            // Remover atributos de edi√ß√£o tempor√°rios
            doc.querySelectorAll('[data-edit-label]').forEach(el => {
                el.removeAttribute('data-edit-label');
            });
            
            doc.querySelectorAll('[contenteditable]').forEach(el => {
                el.removeAttribute('contenteditable');
            });
            
            // Reconstruir o HTML
            return '<!DOCTYPE html>' + doc.documentElement.outerHTML;
        }

        // Fun√ß√£o para carregar template para edi√ß√£o
        async function carregarTemplateParaEdicao(templateId) {
            if (!templateId) {
                document.getElementById('template-editor-section').style.display = 'none';
                return;
            }

            currentTemplateId = templateId;
            const template = templatesDisponiveis.find(t => t.id === templateId);
            
            if (!template) {
                mostrarToast('Template n√£o encontrado', 'error');
                return;
            }

            try {
                // Carregar template HTML
                const response = await fetch(`/templates/upsell/${templateId}.html`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar template');
                }
                
                templateHtmlOriginal = await response.text();
                
                // Preparar template com valores padr√£o
                const produtos = produtosDisponiveis.filter(p => produtosSelecionados.includes(p.id));
                const primeiroProduto = produtos.length > 0 ? produtos[0] : null;
                
                // Substituir vari√°veis com valores padr√£o
                let templateHtml = templateHtmlOriginal;
                const variaveis = {
                    '{{TITULO_PAGINA}}': 'Oferta Exclusiva - One Time Offer',
                    '{{TEXTO_ALERTA}}': 'Aten√ß√£o: Esta p√°gina expira assim que a fechar',
                    '{{BADGE_TEXTO}}': 'Oferta de Passo √önico',
                    '{{TITULO_PRINCIPAL}}': 'ESPERE! O seu pedido ainda n√£o est√° completo.',
                    '{{SUBTITULO}}': primeiroProduto ? `Veja como duplicar os seus resultados por apenas alguns centavos extra.` : 'Veja como duplicar os seus resultados por apenas alguns centavos extra.',
                    '{{VIDEO_CONTENT}}': '<div class="absolute inset-0" style="background-image: url(https://images.unsplash.com/photo-1557804506-669a67965ba0?q=80&w=2574&auto=format&fit=crop); background-size: cover; background-position: center; opacity: 0.4;"></div><div class="absolute inset-0 flex items-center justify-center"><div class="relative"><div class="absolute inset-0 rounded-full animate-pulse" style="background: #f97316; filter: blur(20px); opacity: 0.4;"></div><div class="rounded-full flex items-center justify-center shadow-2xl z-10 transform transition-transform duration-300" style="width: 80px; height: 80px; background: linear-gradient(135deg, #f97316, #ea580c); border: 4px solid rgba(24,24,27,0.5);"><i class="fas fa-play text-white text-3xl" style="margin-left: 4px;"></i></div></div></div>',
                    '{{PRECO_ORIGINAL}}': primeiroProduto ? (parseFloat(primeiroProduto.preco) * 1.5).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'}) : 'MZN 297,00',
                    '{{PRECO_OFERTA}}': primeiroProduto ? parseFloat(primeiroProduto.preco).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'}) : 'MZN 47,90',
                    '{{TEXTO_OFERTA_UNICA}}': 'OFERTA √öNICA',
                    '{{TEXTO_PERGUNTA_PRODUTO}}': primeiroProduto ? `Adicionar "${primeiroProduto.nome}" ao pedido?` : 'Adicionar produto ao pedido?',
                    '{{TEXTO_BOTAO_ACEITAR}}': 'Sim, Adicionar ao Meu Pedido',
                    '{{TEXTO_SUBTITULO_BOTAO}}': 'N√£o √© necess√°rio inserir dados novamente',
                    '{{TEXTO_BOTAO_RECUSAR}}': 'N√£o, obrigado. Eu n√£o quero acelerar meus resultados.',
                    '{{TEXTO_RECUSAR_SUBTITULO}}': 'Compreendo que perderei este desconto de 80% para sempre.',
                    '{{TEXTO_CONFIRMACAO_RECUSAR}}': 'Tem a certeza? Esta oferta nunca mais aparecer√°.'
                };
                
                Object.keys(variaveis).forEach(variavel => {
                    templateHtml = templateHtml.replace(new RegExp(variavel.replace(/[{}]/g, '\\$&'), 'g'), variaveis[variavel]);
                });
                
                // Adicionar estilos de edi√ß√£o ao template para o iframe
                const estilosEdicao = `
                <style id="edit-mode-styles">
                    .edit-mode-active [data-editable] {
                        outline: 2px dashed #667eea !important;
                        outline-offset: 2px;
                        position: relative;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .edit-mode-active [data-editable="text"]:hover,
                    .edit-mode-active [data-editable="button-text"]:hover {
                        background: rgba(102, 126, 234, 0.2) !important;
                        outline-color: #f97316 !important;
                    }
                    .edit-mode-active [data-editable="media"]:hover {
                        outline-color: #22c55e !important;
                    }
                    .edit-mode-active [data-editable][contenteditable="true"] {
                        outline: 3px solid #22c55e !important;
                        background: rgba(34, 197, 94, 0.1) !important;
                    }
                    .edit-mode-active [data-editable="media"]::after {
                        content: 'üìπ Clique para adicionar v√≠deo';
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.9);
                        color: #f97316;
                        padding: 15px 25px;
                        border-radius: 12px;
                        font-size: 14px;
                        font-weight: 700;
                        z-index: 100;
                        pointer-events: none;
                        opacity: 0;
                        transition: opacity 0.3s;
                        border: 2px solid #f97316;
                    }
                    .edit-mode-active [data-editable="media"]:hover::after {
                        opacity: 1;
                    }
                    /* Indicador de elemento edit√°vel */
                    .edit-mode-active [data-editable]::before {
                        content: '‚úèÔ∏è';
                        position: absolute;
                        top: -10px;
                        right: -10px;
                        background: #667eea;
                        color: white;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        z-index: 50;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .edit-mode-active [data-editable]:hover::before {
                        opacity: 1;
                    }
                </style>
                `;
                
                // Injetar estilos de edi√ß√£o no template
                templateHtml = templateHtml.replace('</head>', estilosEdicao + '</head>');
                
                // Sanitizar template para evitar conflitos de scripts
                templateHtml = sanitizarTemplateParaEdicao(templateHtml);
                
                // Salvar HTML no container oculto para refer√™ncia
                const container = document.getElementById('template-content');
                container.innerHTML = templateHtml;
                
                // Carregar template no iframe com todos os estilos
                const iframe = document.getElementById('template-iframe');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                iframeDoc.open();
                iframeDoc.write(templateHtml);
                iframeDoc.close();
                
                // Mostrar se√ß√£o de editor
                document.getElementById('template-editor-section').style.display = 'block';
                
                // Inicializar modo de edi√ß√£o no iframe
                setTimeout(() => {
                    inicializarEditorIframe();
                }, 500);
                
                mostrarToast('Template carregado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao carregar template:', error);
                mostrarToast('Erro ao carregar template: ' + error.message, 'error');
            }
        }

        // Fun√ß√£o para definir tamanho do preview
        function setPreviewSize(size) {
            const container = document.getElementById('iframe-container');
            const iframe = document.getElementById('template-iframe');
            
            switch(size) {
                case 'mobile':
                    container.style.maxWidth = '375px';
                    iframe.style.height = '700px';
                    break;
                case 'tablet':
                    container.style.maxWidth = '768px';
                    iframe.style.height = '900px';
                    break;
                default: // desktop
                    container.style.maxWidth = '100%';
                    iframe.style.height = '800px';
            }
        }
        
        // Fun√ß√£o para preview em tela cheia
        function previewFullscreen() {
            const iframe = document.getElementById('template-iframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const html = '<!DOCTYPE html>' + iframeDoc.documentElement.outerHTML;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(html);
            newWindow.document.close();
        }
        
        // Inicializar editor dentro do iframe
        function inicializarEditorIframe() {
            const iframe = document.getElementById('template-iframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            if (!iframeDoc) return;
            
            // Adicionar estilos de edi√ß√£o ao iframe
            injetarEstilosEdicao(iframeDoc);
            
            // Adicionar event listeners para elementos edit√°veis
            const editables = iframeDoc.querySelectorAll('[data-editable]');
            
            editables.forEach(element => {
                const editType = element.getAttribute('data-editable');
                
                if (editType === 'text' || editType === 'button-text') {
                    element.addEventListener('click', function(e) {
                        if (editModeActive) {
                            e.preventDefault();
                            e.stopPropagation();
                            iniciarEdicaoTextoIframe(this);
                        }
                    });
                    
                    // Salvar altera√ß√µes quando perder foco
                    element.addEventListener('blur', function() {
                        if (this.getAttribute('contenteditable') === 'true') {
                            this.setAttribute('data-user-edited', 'true');
                            atualizarTemplateContent();
                            atualizarContadorEdicoes();
                        }
                    });
                    
                    // Detectar tecla Enter para finalizar edi√ß√£o
                    element.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.blur();
                        }
                    });
                } else if (editType === 'media') {
                    element.addEventListener('click', function(e) {
                        if (editModeActive) {
                            e.preventDefault();
                            e.stopPropagation();
                            iniciarUploadMidiaIframe(this);
                        }
                    });
                }
            });
            
            // Desabilitar links e bot√µes no modo preview
            const links = iframeDoc.querySelectorAll('a, button');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (!editModeActive || !this.hasAttribute('data-editable')) {
                        e.preventDefault();
                    }
                });
            });
        }
        
        // Injetar estilos de edi√ß√£o no iframe
        function injetarEstilosEdicao(doc) {
            // Verificar se j√° existe
            if (doc.getElementById('dynamic-edit-styles')) return;
            
            const style = doc.createElement('style');
            style.id = 'dynamic-edit-styles';
            style.textContent = `
                .edit-mode-active [data-editable] {
                    outline: 3px dashed #22c55e !important;
                    outline-offset: 4px;
                    position: relative !important;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                .edit-mode-active [data-editable]::after {
                    content: attr(data-edit-label);
                    position: absolute;
                    top: -28px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                    color: white;
                    padding: 4px 12px;
                    border-radius: 6px;
                    font-size: 11px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    white-space: nowrap;
                    z-index: 1000;
                    opacity: 0;
                    pointer-events: none;
                    transition: opacity 0.2s ease;
                    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
                    font-family: Arial, sans-serif;
                }
                
                .edit-mode-active [data-editable]:hover::after {
                    opacity: 1;
                }
                
                .edit-mode-active [data-editable="text"]:hover,
                .edit-mode-active [data-editable="button-text"]:hover {
                    background: rgba(34, 197, 94, 0.15) !important;
                    outline-color: #16a34a !important;
                }
                
                .edit-mode-active [data-editable="media"] {
                    outline-color: #f97316 !important;
                }
                
                .edit-mode-active [data-editable="media"]:hover {
                    outline-color: #ea580c !important;
                }
                
                .edit-mode-active [data-editable="media"]::after {
                    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important;
                    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.4) !important;
                }
                
                .edit-mode-active [data-editable][contenteditable="true"] {
                    outline: 3px solid #3b82f6 !important;
                    outline-offset: 2px;
                    background: rgba(59, 130, 246, 0.1) !important;
                    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
                }
                
                .edit-mode-active [data-editable][contenteditable="true"]::after {
                    content: '‚úèÔ∏è EDITANDO...';
                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
                    opacity: 1 !important;
                    animation: pulse-edit 1s infinite;
                }
                
                @keyframes pulse-edit {
                    0%, 100% { transform: translateX(-50%) scale(1); }
                    50% { transform: translateX(-50%) scale(1.05); }
                }
                
                .edit-mode-active [data-user-edited="true"]::before {
                    content: '‚úì';
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: #22c55e;
                    color: white;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    z-index: 1001;
                    box-shadow: 0 2px 6px rgba(34, 197, 94, 0.5);
                }
            `;
            doc.head.appendChild(style);
        }
        
        // Fun√ß√£o para iniciar edi√ß√£o de texto no iframe
        function iniciarEdicaoTextoIframe(element) {
            element.setAttribute('contenteditable', 'true');
            element.focus();
            
            // Selecionar todo o texto
                const range = document.createRange();
                range.selectNodeContents(element);
            const selection = element.ownerDocument.defaultView.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            
            // Salvar conte√∫do original
            if (!element.hasAttribute('data-original-content')) {
                element.setAttribute('data-original-content', element.textContent);
            }
        }

        // ===============================================
        // SISTEMA DE UPLOAD DE M√çDIA AVAN√áADO
        // ===============================================
        
        let currentMediaElement = null;
        let currentMediaContent = null;
        let currentMediaType = 'upload'; // 'upload', 'embed', 'url'
        
        // Fun√ß√£o para abrir modal de m√≠dia (substituindo a fun√ß√£o antiga)
        function iniciarUploadMidiaIframe(element) {
            currentMediaElement = element;
            abrirModalMidia();
        }
        
        // Abrir modal de m√≠dia
        function abrirModalMidia() {
            const modal = document.getElementById('media-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Limpar estado anterior
            limparPreview();
            document.getElementById('embed-code').value = '';
            document.getElementById('video-url').value = '';
            document.getElementById('youtube-url').value = '';
            document.getElementById('vturb-url').value = '';
            
            // Detectar tipo de m√≠dia do elemento atual
            const mediaType = currentMediaElement?.getAttribute('data-media-type') || 'video';
            const isImage = mediaType === 'image';
            
            // Atualizar input de arquivo e textos do modal
            const fileInput = document.getElementById('video-file-input');
            const uploadTitle = document.getElementById('upload-title');
            const uploadDescription = document.getElementById('upload-description');
            const uploadHintText = document.getElementById('upload-hint-text');
            const btnAplicarTexto = document.getElementById('btn-aplicar-texto');
            const urlLabel = document.getElementById('url-label');
            const urlHelpText = document.getElementById('url-help-text');
            const urlInput = document.getElementById('video-url');
            const youtubeSection = document.getElementById('youtube-section');
            
            if (isImage) {
                fileInput.setAttribute('accept', 'image/jpeg,image/jpg,image/png,image/webp,image/gif');
                
                // Atualizar textos do modal para imagem
                if (uploadTitle) uploadTitle.textContent = 'Arraste a imagem aqui ou clique para selecionar';
                if (uploadDescription) uploadDescription.textContent = 'Suporta JPG, PNG, WebP, GIF at√© 10MB';
                if (uploadHintText) uploadHintText.textContent = 'Recomendado: 1080x1080px ou 16:9';
                if (btnAplicarTexto) btnAplicarTexto.textContent = 'Aplicar Imagem';
                if (urlLabel) urlLabel.textContent = 'URL da Imagem';
                if (urlInput) urlInput.placeholder = 'https://exemplo.com/imagem.jpg';
                if (urlHelpText) urlHelpText.textContent = 'Cole a URL direta da imagem (JPG, PNG, WebP, GIF).';
                if (youtubeSection) youtubeSection.style.display = 'none'; // Ocultar se√ß√£o YouTube para imagens
            } else {
                fileInput.setAttribute('accept', 'video/*');
                
                // Restaurar textos originais para v√≠deo
                if (uploadTitle) uploadTitle.textContent = 'Arraste o v√≠deo aqui ou clique para selecionar';
                if (uploadDescription) uploadDescription.textContent = 'Suporta MP4, WebM, MOV, AVI at√© 500MB';
                if (uploadHintText) uploadHintText.textContent = 'Recomendado: 1080p, formato 16:9';
                if (btnAplicarTexto) btnAplicarTexto.textContent = 'Aplicar V√≠deo';
                if (urlLabel) urlLabel.textContent = 'URL do V√≠deo';
                if (urlInput) urlInput.placeholder = 'https://exemplo.com/video.mp4';
                if (urlHelpText) urlHelpText.textContent = 'Cole a URL direta do v√≠deo (MP4, WebM) ou link do YouTube/Vimeo.';
                if (youtubeSection) youtubeSection.style.display = 'block'; // Mostrar se√ß√£o YouTube para v√≠deos
            }
            
            // Resetar para tab de upload
            trocarTabMidia('upload');
        }
        
        // Fechar modal de m√≠dia
        function fecharModalMidia() {
            const modal = document.getElementById('media-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            currentMediaElement = null;
        }
        
        // Trocar tabs
        function trocarTabMidia(tabName) {
            // Atualizar tabs
            document.querySelectorAll('.media-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Atualizar conte√∫do
            document.querySelectorAll('.media-tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
            
            currentMediaType = tabName;
        }
        
        // Configurar drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.getElementById('upload-drop-area');
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
                });
                
                dropArea.addEventListener('drop', handleDrop, false);
            }
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleVideoFileSelect(files[0]);
            }
        }
        
        // Handler de sele√ß√£o de arquivo de v√≠deo
        async function handleVideoFileSelect(file) {
                if (!file) return;
                
            // Detectar tipo de m√≠dia do elemento atual
            const mediaType = currentMediaElement?.getAttribute('data-media-type') || 'video';
            const isImage = mediaType === 'image';
            
            // Validar tipo
            if (isImage) {
                if (!file.type.startsWith('image/')) {
                    mostrarToast('Por favor, selecione um arquivo de imagem v√°lido (JPG, PNG, WebP, GIF).', 'error');
                    return;
                }
                // Validar tamanho para imagens (10MB max)
                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    mostrarToast('A imagem √© muito grande. M√°ximo permitido: 10MB', 'error');
                    return;
                }
            } else {
                if (!file.type.startsWith('video/')) {
                    mostrarToast('Por favor, selecione um arquivo de v√≠deo v√°lido.', 'error');
                    return;
                }
                // Validar tamanho para v√≠deos (500MB max)
                const maxSize = 500 * 1024 * 1024;
                if (file.size > maxSize) {
                    mostrarToast('O arquivo √© muito grande. M√°ximo permitido: 500MB', 'error');
                    return;
                }
            }
            
            const progressDiv = document.getElementById('upload-progress');
            const progressFill = document.getElementById('upload-progress-fill');
            const uploadStatus = document.getElementById('upload-status');
            const uploadPercent = document.getElementById('upload-percent');
            const btnAplicar = document.getElementById('btn-aplicar-midia');
            
            try {
                progressDiv.classList.add('active');
                uploadStatus.textContent = 'Preparando upload...';
                progressFill.style.width = '0%';
                uploadPercent.textContent = '0%';
                    
                    const form = new FormData();
                    form.append('contentFile', file);
                // Usar pasta apropriada baseada no tipo
                form.append('folder', isImage ? 'upsell-images' : 'upsell-videos');
                    
                    const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('adminToken');
                
                // Criar XMLHttpRequest para progresso
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressFill.style.width = percent + '%';
                        uploadPercent.textContent = percent + '%';
                        
                        if (percent < 100) {
                            uploadStatus.textContent = isImage ? 'Enviando imagem...' : 'Enviando v√≠deo...';
                        } else {
                            uploadStatus.textContent = 'Processando...';
                        }
                    }
                });
                
                const response = await new Promise((resolve, reject) => {
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve(JSON.parse(xhr.responseText));
                        } else {
                            reject(new Error('Erro no upload'));
                        }
                    };
                    xhr.onerror = () => reject(new Error('Erro de rede'));
                    
                    xhr.open('POST', '/api/upload/enhanced-content/single');
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    xhr.send(form);
                });
                
                if (!response.success) {
                    throw new Error(response.message || 'Falha no upload');
                }
                
                const result = response.data || {};
                    const mediaUrl = result.original?.url || result.url || result.secure_url || result.path || result.original?.path || '';
                    
                    if (!mediaUrl) {
                    throw new Error(`URL da ${isImage ? 'imagem' : 'v√≠deo'} n√£o retornada`);
                }
                
                // Criar HTML baseado no tipo
                if (isImage) {
                    currentMediaContent = `<img src="${mediaUrl}" alt="Produto" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">`;
                    // Mostrar preview de imagem
                    mostrarPreviewImagem(mediaUrl);
                } else {
                    currentMediaContent = `
                        <video autoplay playsinline controls style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                            <source src="${mediaUrl}" type="${file.type || 'video/mp4'}">
                            Seu navegador n√£o suporta v√≠deos HTML5.
                            </video>
                        `;
                    // Mostrar preview de v√≠deo
                    mostrarPreviewVideo(mediaUrl);
                }
                
                uploadStatus.textContent = 'Upload conclu√≠do!';
                progressFill.style.background = 'linear-gradient(90deg, #22c55e, #16a34a)';
                btnAplicar.disabled = false;
                
                mostrarToast(`${isImage ? 'Imagem' : 'V√≠deo'} enviado com sucesso!`, 'success');
                
                } catch (error) {
                    console.error('Erro ao fazer upload:', error);
                uploadStatus.textContent = 'Erro no upload';
                progressFill.style.background = '#ef4444';
                mostrarToast(`Erro ao enviar ${isImage ? 'imagem' : 'v√≠deo'}: ` + error.message, 'error');
            }
        }
        
        // Fun√ß√£o para mostrar preview de imagem
        function mostrarPreviewImagem(url) {
            const previewDiv = document.getElementById('media-preview');
            const previewContent = document.getElementById('media-preview-content');
            
            previewContent.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 400px; border-radius: 12px; object-fit: contain;">`;
            previewDiv.classList.add('has-content');
        }
        
        // Preview de c√≥digo embed
        function previewEmbed() {
            const embedCode = document.getElementById('embed-code').value.trim();
            const previewDiv = document.getElementById('media-preview');
            const previewContent = document.getElementById('media-preview-content');
            const btnAplicar = document.getElementById('btn-aplicar-midia');
            
            if (!embedCode) {
                previewDiv.classList.remove('has-content');
                btnAplicar.disabled = true;
                currentMediaContent = null;
                return;
            }
            
            // Sanitizar e validar o c√≥digo embed
            const sanitizedCode = sanitizeEmbedCode(embedCode);
            
            if (sanitizedCode) {
                currentMediaContent = sanitizedCode;
                previewContent.innerHTML = sanitizedCode;
                previewDiv.classList.add('has-content');
                btnAplicar.disabled = false;
            } else {
                mostrarToast('C√≥digo embed inv√°lido. Use iframe ou video tags.', 'error');
            }
        }
        
        // Sanitizar c√≥digo embed
        function sanitizeEmbedCode(code) {
            // Criar um elemento tempor√°rio para parsear o HTML
            const temp = document.createElement('div');
            temp.innerHTML = code;
            
            // Detectar tipo de m√≠dia do elemento atual
            const mediaType = currentMediaElement?.getAttribute('data-media-type') || 'video';
            const isImage = mediaType === 'image';
            
            // Verificar se cont√©m elementos permitidos
            const allowedTags = isImage 
                ? ['img', 'iframe', 'video', 'source', 'embed', 'object']
                : ['iframe', 'video', 'source', 'embed', 'object'];
            
            const elements = temp.querySelectorAll('*');
            
            let hasValidElement = false;
            elements.forEach(el => {
                if (allowedTags.includes(el.tagName.toLowerCase())) {
                    hasValidElement = true;
                    
                    // Adicionar estilos para preencher o container
                    el.style.width = '100%';
                    el.style.height = '100%';
                    el.style.objectFit = 'cover';
                    el.style.borderRadius = isImage ? '12px' : '16px';
                    
                    // Para imagens, garantir atributos
                    if (el.tagName.toLowerCase() === 'img') {
                        if (!el.getAttribute('alt')) {
                            el.setAttribute('alt', 'Produto');
                        }
                    }
                    
                    // Para iframes, garantir que permita fullscreen
                    if (el.tagName.toLowerCase() === 'iframe') {
                        el.setAttribute('allowfullscreen', 'true');
                        el.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                    }
                }
            });
            
            return hasValidElement ? temp.innerHTML : null;
        }
        
        // Preview de URL de v√≠deo ou imagem
        function previewVideoUrl() {
            const url = document.getElementById('video-url').value.trim();
            const btnAplicar = document.getElementById('btn-aplicar-midia');
            
            if (!url) {
                document.getElementById('media-preview').classList.remove('has-content');
                btnAplicar.disabled = true;
                currentMediaContent = null;
                return;
            }
            
            // Verificar se √© URL v√°lida
            try {
                new URL(url);
            } catch {
                return;
            }
            
            // Detectar tipo de m√≠dia do elemento atual
            const mediaType = currentMediaElement?.getAttribute('data-media-type') || 'video';
            const isImage = mediaType === 'image';
            
            // Detectar tamb√©m pela extens√£o da URL
            const urlLower = url.toLowerCase();
            const isImageUrl = urlLower.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i);
            const isVideoUrl = urlLower.match(/\.(mp4|webm|mov|avi|mkv|flv)(\?|$)/i);
            
            // Se for elemento de imagem ou URL de imagem, tratar como imagem
            if (isImage || isImageUrl) {
                currentMediaContent = `<img src="${url}" alt="Produto" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">`;
                mostrarPreviewImagem(url);
            } else if (isVideoUrl || !isImage) {
                // Criar HTML do v√≠deo
                currentMediaContent = `
                    <video autoplay playsinline controls style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                        <source src="${url}" type="video/mp4">
                        Seu navegador n√£o suporta v√≠deos HTML5.
                    </video>
                `;
                mostrarPreviewVideo(url);
            } else {
                mostrarToast('URL inv√°lida. Use uma URL de imagem ou v√≠deo.', 'error');
                return;
            }
            
            btnAplicar.disabled = false;
        }
        
        // Converter URL do YouTube para embed
        function convertYoutubeUrl() {
            const url = document.getElementById('youtube-url').value.trim();
            const btnAplicar = document.getElementById('btn-aplicar-midia');
            
            if (!url) {
                document.getElementById('media-preview').classList.remove('has-content');
                btnAplicar.disabled = true;
                currentMediaContent = null;
                return;
            }
            
            let videoId = null;
            
            // Extrair ID do YouTube
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            
            if (youtubeMatch) {
                videoId = youtubeMatch[1];
                currentMediaContent = `
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                        style="width: 100%; height: 100%; border-radius: 16px;"
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                `;
                
                mostrarPreviewYoutube(videoId);
                btnAplicar.disabled = false;
                return;
            }
            
            // Extrair ID do Vimeo
            const vimeoRegex = /(?:vimeo\.com\/)(\d+)/;
            const vimeoMatch = url.match(vimeoRegex);
            
            if (vimeoMatch) {
                videoId = vimeoMatch[1];
                currentMediaContent = `
                    <iframe 
                        src="https://player.vimeo.com/video/${videoId}?autoplay=1" 
                        style="width: 100%; height: 100%; border-radius: 16px;"
                        frameborder="0" 
                        allow="autoplay; fullscreen; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                `;
                
                mostrarPreviewVimeo(videoId);
                btnAplicar.disabled = false;
                return;
            }
            
            mostrarToast('URL n√£o reconhecida. Use YouTube ou Vimeo.', 'error');
        }
        
        // Converter link da VTurb para embed
        function convertVturbUrl() {
            const url = document.getElementById('vturb-url').value.trim();
            const btnAplicar = document.getElementById('btn-aplicar-midia');
            
            if (!url) {
                document.getElementById('media-preview').classList.remove('has-content');
                btnAplicar.disabled = true;
                currentMediaContent = null;
                return;
            }
            
            let videoId = null;
            let embedUrl = null;
            
            // Extrair ID da VTurb - diferentes formatos de URL
            // Formato 1: https://vturb.com/video/VIDEO_ID
            const vturbVideoRegex = /vturb\.com\/video\/([a-zA-Z0-9_-]+)/;
            const vturbVideoMatch = url.match(vturbVideoRegex);
            
            if (vturbVideoMatch) {
                videoId = vturbVideoMatch[1];
                embedUrl = `https://player.vturb.com/${videoId}`;
            } else {
                // Formato 2: https://player.vturb.com/VIDEO_ID
                const vturbPlayerRegex = /player\.vturb\.com\/([a-zA-Z0-9_-]+)/;
                const vturbPlayerMatch = url.match(vturbPlayerRegex);
                
                if (vturbPlayerMatch) {
                    videoId = vturbPlayerMatch[1];
                    embedUrl = `https://player.vturb.com/${videoId}`;
                } else {
                    // Formato 3: https://vturb.com/embed/VIDEO_ID
                    const vturbEmbedRegex = /vturb\.com\/embed\/([a-zA-Z0-9_-]+)/;
                    const vturbEmbedMatch = url.match(vturbEmbedRegex);
                    
                    if (vturbEmbedMatch) {
                        videoId = vturbEmbedMatch[1];
                        embedUrl = `https://player.vturb.com/${videoId}`;
                    }
                }
            }
            
            if (videoId && embedUrl) {
                currentMediaContent = `
                    <iframe 
                        src="${embedUrl}" 
                        style="width: 100%; height: 100%; border-radius: 16px;"
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                `;
                
                mostrarPreviewVturb(embedUrl);
                btnAplicar.disabled = false;
                videoType = 'embed';
                videoEmbed = currentMediaContent;
                videoUrl = embedUrl;
                return;
            }
            
            mostrarToast('URL da VTurb n√£o reconhecida. Use: https://vturb.com/video/VIDEO_ID ou https://player.vturb.com/VIDEO_ID', 'error');
        }
        
        // Mostrar preview da VTurb
        function mostrarPreviewVturb(embedUrl) {
            const previewDiv = document.getElementById('media-preview');
            const previewContent = document.getElementById('media-preview-content');
            
            previewContent.innerHTML = `
                <iframe 
                    src="${embedUrl}" 
                    style="width: 100%; height: 100%;"
                    frameborder="0" 
                    allowfullscreen>
                </iframe>
            `;
            previewDiv.classList.add('has-content');
        }
        
        // Mostrar preview de v√≠deo
        function mostrarPreviewVideo(url) {
            const previewDiv = document.getElementById('media-preview');
            const previewContent = document.getElementById('media-preview-content');
            
            previewContent.innerHTML = `
                <video controls style="width: 100%; height: 100%; object-fit: contain;">
                    <source src="${url}" type="video/mp4">
                </video>
            `;
            previewDiv.classList.add('has-content');
        }
        
        // Mostrar preview do YouTube
        function mostrarPreviewYoutube(videoId) {
            const previewDiv = document.getElementById('media-preview');
            const previewContent = document.getElementById('media-preview-content');
            
            previewContent.innerHTML = `
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}" 
                    style="width: 100%; height: 100%;"
                    frameborder="0" 
                    allowfullscreen>
                </iframe>
            `;
            previewDiv.classList.add('has-content');
        }
        
        // Mostrar preview do Vimeo
        function mostrarPreviewVimeo(videoId) {
            const previewDiv = document.getElementById('media-preview');
            const previewContent = document.getElementById('media-preview-content');
            
            previewContent.innerHTML = `
                <iframe 
                    src="https://player.vimeo.com/video/${videoId}" 
                    style="width: 100%; height: 100%;"
                    frameborder="0" 
                    allowfullscreen>
                </iframe>
            `;
            previewDiv.classList.add('has-content');
        }
        
        // Limpar preview
        function limparPreview() {
            const previewDiv = document.getElementById('media-preview');
            const previewContent = document.getElementById('media-preview-content');
            const progressDiv = document.getElementById('upload-progress');
            const btnAplicar = document.getElementById('btn-aplicar-midia');
            const progressFill = document.getElementById('upload-progress-fill');
            
            previewDiv.classList.remove('has-content');
            previewContent.innerHTML = '';
            progressDiv.classList.remove('active');
            progressFill.style.background = 'linear-gradient(90deg, #f97316, #ea580c)';
            progressFill.style.width = '0%';
            btnAplicar.disabled = true;
            currentMediaContent = null;
            
            // Limpar input de arquivo
            document.getElementById('video-file-input').value = '';
        }
        
        // Aplicar m√≠dia ao template
        function aplicarMidia() {
            if (!currentMediaContent || !currentMediaElement) {
                mostrarToast('Nenhum conte√∫do para aplicar.', 'error');
                return;
            }
            
            // Detectar tipo de m√≠dia
            const mediaType = currentMediaElement?.getAttribute('data-media-type') || 'video';
            const isImage = mediaType === 'image';
            const isVideo = mediaType === 'video' || currentMediaContent.includes('iframe') || 
                          currentMediaContent.includes('youtube.com') || currentMediaContent.includes('vimeo.com');
            
            // Verificar se √© um card de ebook (tem classe ebook-card ou cont√©m .ebook-cover)
            const isEbookCard = currentMediaElement.classList.contains('ebook-card') || 
                               currentMediaElement.querySelector('.ebook-cover');
            
            // Verificar se √© um card de resultado (tem classe result-card ou cont√©m .result-image)
            const isResultCard = currentMediaElement.classList.contains('result-card') || 
                               currentMediaElement.querySelector('.result-image');
            
            // Verificar se √© um avatar de depoimento social (tem classe social-testimonial-avatar)
            const isSocialAvatar = currentMediaElement.classList.contains('social-testimonial-avatar') ||
                                 (currentMediaElement.tagName === 'IMG' && currentMediaElement.classList.contains('social-testimonial-avatar'));
            
            // Verificar se √© um card de benef√≠cio (tem classe benefit-card ou cont√©m .benefit-image)
            const isBenefitCard = currentMediaElement.classList.contains('benefit-card') || 
                                 currentMediaElement.querySelector('.benefit-image');
            
            // Verificar se √© um item da galeria (tem classe gallery-item ou cont√©m .gallery-image)
            const isGalleryItem = currentMediaElement.classList.contains('gallery-item') || 
                                currentMediaElement.querySelector('.gallery-image');
            
            // Verificar se √© uma imagem da se√ß√£o Inside (cont√©m .inside-image)
            const isInsideImage = currentMediaElement.querySelector('.inside-image');
            
            // Verificar se √© o background do hero (tem classe hero-section)
            const isHeroBackground = currentMediaElement.classList.contains('hero-section');
            
            // Verificar se √© o v√≠deo do hero (tem classe hero-video-container ou cont√©m .hero-video-box ou .hero-video-image)
            const isHeroVideo = currentMediaElement.classList.contains('hero-video-container') || 
                              currentMediaElement.querySelector('.hero-video-box') ||
                              currentMediaElement.querySelector('.hero-video-image');
            
            // Verificar se √© uma imagem da se√ß√£o How it Works (cont√©m .how-it-works-image)
            const isHowItWorksImage = currentMediaElement.querySelector('.how-it-works-image');
            
            // Verificar se √© uma imagem de garantia (tem data-field="garantia_imagem")
            const isGuaranteeImage = currentMediaElement.getAttribute('data-field') === 'garantia_imagem' && 
                                    currentMediaElement.tagName === 'IMG';
            
            if (isImage && isEbookCard) {
                // Para cards de ebook, aplicar a imagem no background-image do .ebook-cover
                const ebookCover = currentMediaElement.querySelector('.ebook-cover');
                if (ebookCover) {
                    // Extrair URL da imagem do currentMediaContent
                    const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                    if (imgMatch && imgMatch[1]) {
                        const imageUrl = imgMatch[1];
                        ebookCover.style.backgroundImage = `url('${imageUrl}')`;
                        
                        // Salvar URL no atributo data-field para persist√™ncia
                        const field = currentMediaElement.getAttribute('data-field');
                        if (field) {
                            // Atualizar atributos salvos
                            salvarAtributoMedia(field, imageUrl);
                        }
                    }
                }
            } else if (isImage && isResultCard) {
                // Para cards de resultado, aplicar a imagem no elemento .result-image
                const resultImage = currentMediaElement.querySelector('.result-image');
                if (resultImage) {
                    // Extrair URL da imagem do currentMediaContent
                    const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                    if (imgMatch && imgMatch[1]) {
                        const imageUrl = imgMatch[1];
                        resultImage.src = imageUrl;
                        resultImage.alt = resultImage.alt || 'Resultado de Emagrecimento';
                        
                        // Salvar URL no atributo data-field para persist√™ncia
                        const field = currentMediaElement.getAttribute('data-field');
                        if (field) {
                            // Atualizar atributos salvos
                            salvarAtributoMedia(field, imageUrl);
                        }
                    }
                }
            } else if (isImage && isSocialAvatar) {
                // Para avatares de depoimentos sociais, aplicar a imagem diretamente
                const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                if (imgMatch && imgMatch[1]) {
                    const imageUrl = imgMatch[1];
                    // Se o elemento atual √© a imagem, aplicar diretamente
                    if (currentMediaElement.tagName === 'IMG') {
                        currentMediaElement.src = imageUrl;
                        currentMediaElement.alt = currentMediaElement.alt || 'Avatar Cliente';
                    } else {
                        // Se √© o container, encontrar a imagem dentro
                        const avatarImg = currentMediaElement.querySelector('.social-testimonial-avatar');
                        if (avatarImg) {
                            avatarImg.src = imageUrl;
                            avatarImg.alt = avatarImg.alt || 'Avatar Cliente';
                        }
                    }
                    
                    // Salvar URL no atributo data-field para persist√™ncia
                    const field = currentMediaElement.getAttribute('data-field');
                    if (field) {
                        salvarAtributoMedia(field, imageUrl);
                    }
                }
            } else if (isImage && isBenefitCard) {
                // Para cards de benef√≠cio, aplicar a imagem no elemento .benefit-image
                const benefitImage = currentMediaElement.querySelector('.benefit-image');
                if (benefitImage) {
                    const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                    if (imgMatch && imgMatch[1]) {
                        const imageUrl = imgMatch[1];
                        benefitImage.src = imageUrl;
                        benefitImage.alt = benefitImage.alt || 'Benef√≠cio';
                        
                        const field = currentMediaElement.getAttribute('data-field');
                        if (field) {
                            salvarAtributoMedia(field, imageUrl);
                        }
                    }
                }
            } else if (isImage && isGalleryItem) {
                // Para itens da galeria, aplicar a imagem no elemento .gallery-image
                const galleryImage = currentMediaElement.querySelector('.gallery-image');
                if (galleryImage) {
                    const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                    if (imgMatch && imgMatch[1]) {
                        const imageUrl = imgMatch[1];
                        galleryImage.src = imageUrl;
                        galleryImage.alt = galleryImage.alt || 'Receita';
                        
                        const field = currentMediaElement.getAttribute('data-field');
                        if (field) {
                            salvarAtributoMedia(field, imageUrl);
                        }
                    }
                }
            } else if (isImage && isInsideImage) {
                // Para imagens da se√ß√£o Inside, aplicar no elemento .inside-image
                const insideImage = currentMediaElement.querySelector('.inside-image');
                if (insideImage) {
                    const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                    if (imgMatch && imgMatch[1]) {
                        const imageUrl = imgMatch[1];
                        insideImage.src = imageUrl;
                        insideImage.alt = insideImage.alt || 'Processo';
                        
                        const field = currentMediaElement.getAttribute('data-field');
                        if (field) {
                            salvarAtributoMedia(field, imageUrl);
                        }
                    }
                }
            } else if (isImage && isHeroBackground) {
                // Para background do hero, aplicar como background-image
                const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                if (imgMatch && imgMatch[1]) {
                    const imageUrl = imgMatch[1];
                    currentMediaElement.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('${imageUrl}')`;
                    
                    const field = currentMediaElement.getAttribute('data-field');
                    if (field) {
                        salvarAtributoMedia(field, imageUrl);
                    }
                }
            } else if (isVideo && isHeroVideo) {
                // Para v√≠deo do hero, aplicar como iframe ou imagem
                const videoBox = currentMediaElement.querySelector('.hero-video-box');
                const videoContainer = currentMediaElement.classList.contains('hero-video-container') ? currentMediaElement : null;
                const targetElement = videoBox || videoContainer;
                
                if (targetElement) {
                    // Verificar se √© uma URL de v√≠deo ou imagem
                    if (currentMediaContent.includes('iframe') || currentMediaContent.includes('youtube.com') || currentMediaContent.includes('vimeo.com')) {
                        // √â um v√≠deo embed
                        if (videoBox) {
                            videoBox.innerHTML = currentMediaContent;
                        } else if (videoContainer) {
                            // Se n√£o tem video-box, criar iframe diretamente no container
                            const existingOverlay = videoContainer.querySelector('.hero-video-overlay');
                            if (existingOverlay) {
                                existingOverlay.style.display = 'none';
                            }
                            const iframeMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                            if (iframeMatch && iframeMatch[1]) {
                                videoContainer.innerHTML = `<iframe src="${iframeMatch[1]}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="width: 100%; height: 100%; position: absolute; inset: 0;"></iframe>`;
                            } else {
                                videoContainer.innerHTML = currentMediaContent;
                            }
                        }
                        
                        const field = currentMediaElement.getAttribute('data-field');
                        if (field) {
                            // Extrair URL do iframe
                            const iframeMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                            if (iframeMatch && iframeMatch[1]) {
                                salvarAtributoMedia(field, iframeMatch[1]);
                            } else {
                                salvarAtributoMedia(field, currentMediaContent);
                            }
                        }
                    } else {
                        // √â uma imagem
                        const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                        if (imgMatch && imgMatch[1]) {
                            const imageUrl = imgMatch[1];
                            const img = targetElement.querySelector('.hero-video-image');
                            if (img) {
                                img.src = imageUrl;
                            } else if (videoContainer) {
                                // Se n√£o tem img, criar uma nova
                                const existingImg = videoContainer.querySelector('img');
                                if (existingImg) {
                                    existingImg.src = imageUrl;
                                } else {
                                    videoContainer.innerHTML = `<img src="${imageUrl}" class="hero-video-image" alt="V√≠deo" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3;">`;
                                }
                            }
                            
                            const field = currentMediaElement.getAttribute('data-field');
                            if (field) {
                                salvarAtributoMedia(field, imageUrl);
                            }
                        }
                    }
                }
            } else if (isImage && isHowItWorksImage) {
                // Para imagem da se√ß√£o How it Works, aplicar no elemento .how-it-works-image
                const howItWorksImage = currentMediaElement.querySelector('.how-it-works-image');
                if (howItWorksImage) {
                    const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                    if (imgMatch && imgMatch[1]) {
                        const imageUrl = imgMatch[1];
                        howItWorksImage.src = imageUrl;
                        howItWorksImage.alt = howItWorksImage.alt || 'Como Funciona';
                        
                        const field = currentMediaElement.getAttribute('data-field');
                        if (field) {
                            salvarAtributoMedia(field, imageUrl);
                        }
                    }
                }
            } else if (isImage && isGuaranteeImage) {
                // Para imagem de garantia, aplicar diretamente
                const imgMatch = currentMediaContent.match(/src=["']([^"']+)["']/);
                if (imgMatch && imgMatch[1]) {
                    const imageUrl = imgMatch[1];
                    currentMediaElement.src = imageUrl;
                    currentMediaElement.alt = currentMediaElement.alt || 'Garantia';
                    
                    const field = currentMediaElement.getAttribute('data-field');
                    if (field) {
                        salvarAtributoMedia(field, imageUrl);
                    }
                }
            } else {
                // Aplicar conte√∫do ao elemento no iframe (comportamento padr√£o)
                currentMediaElement.innerHTML = currentMediaContent;
            }
            
            // Atualizar template content
            atualizarTemplateContent();
            
            // Fechar modal
            fecharModalMidia();
            
            mostrarToast(`${isImage ? 'Imagem' : 'V√≠deo'} aplicado com sucesso!`, 'success');
        }
        
        // Fun√ß√£o auxiliar para salvar atributo de m√≠dia
        function salvarAtributoMedia(field, url) {
            // Atualizar savedAttributes diretamente
            if (!savedAttributes) {
                savedAttributes = {};
            }
            
            savedAttributes[field] = {
                type: 'media',
                value: url, // Salvar apenas a URL para cards de ebook
                edited: true
            };
            
            console.log(`üìù Atributo de m√≠dia salvo: ${field} = ${url}`);
        }
        
        // ===============================================
        // FIM DO SISTEMA DE UPLOAD DE M√çDIA
        // ===============================================
        
        // Fun√ß√£o para atualizar o template content oculto
        function atualizarTemplateContent() {
            const iframe = document.getElementById('template-iframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            if (iframeDoc && iframeDoc.body) {
                const container = document.getElementById('template-content');
                container.innerHTML = iframeDoc.documentElement.outerHTML;
            }
        }

        // Fun√ß√£o para inicializar editor (redireciona para a vers√£o iframe)
        function inicializarEditor() {
            inicializarEditorIframe();
        }

        // Fun√ß√£o para ativar/desativar modo de edi√ß√£o
        function toggleEditMode() {
            editModeActive = !editModeActive;
            const btn = document.getElementById('toggle-edit-btn');
            const iframe = document.getElementById('template-iframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const instructionsBar = document.getElementById('edit-instructions');
            
            if (editModeActive) {
                btn.innerHTML = '<i class="fas fa-check"></i> Finalizar Edi√ß√£o';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                
                // Mostrar barra de instru√ß√µes
                instructionsBar.classList.add('active');
                
                // Adicionar classe de modo edi√ß√£o no body do iframe
                if (iframeDoc && iframeDoc.body) {
                    iframeDoc.body.classList.add('edit-mode-active');
                    
                    // Adicionar labels aos elementos edit√°veis
                    adicionarLabelsEditaveis(iframeDoc);
                }
                
                mostrarToast('Modo edi√ß√£o ativado! Clique nos elementos para editar.', 'success');
            } else {
                btn.innerHTML = '<i class="fas fa-pencil-alt"></i> Modo Edi√ß√£o';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                btn.style.background = '';
                
                // Esconder barra de instru√ß√µes
                instructionsBar.classList.remove('active');
                
                // Remover classe de modo edi√ß√£o e desabilitar contenteditable
                if (iframeDoc && iframeDoc.body) {
                    iframeDoc.body.classList.remove('edit-mode-active');
                    
                    // Salvar todos os atributos editados
                    salvarAtributosEditados(iframeDoc);
                    
                    // Desabilitar edi√ß√£o em todos os elementos
                    iframeDoc.querySelectorAll('[data-editable]').forEach(el => {
                        el.setAttribute('contenteditable', 'false');
                    });
                }
                
                // Atualizar template content
                atualizarTemplateContent();
                
                if (editCount > 0) {
                    mostrarToast(`${editCount} altera√ß√µes salvas com sucesso!`, 'success');
                } else {
                    mostrarToast('Nenhuma altera√ß√£o feita.', 'success');
                }
            }
        }
        
        // Adicionar labels descritivos aos elementos edit√°veis
        function adicionarLabelsEditaveis(doc) {
            const labels = {
                'texto_alerta': '‚ö†Ô∏è ALERTA',
                'badge_texto': 'üè∑Ô∏è BADGE',
                'titulo_principal': 'üìù T√çTULO',
                'subtitulo': 'üìù SUBT√çTULO',
                'video': 'üé¨ V√çDEO',
                'preco_original': 'üí∞ PRE√áO ORIGINAL',
                'preco_oferta': 'üí∞ PRE√áO OFERTA',
                'texto_oferta_unica': 'üè∑Ô∏è TAG OFERTA',
                'texto_pergunta_produto': '‚ùì PERGUNTA',
                'texto_botao_aceitar': '‚úÖ BOT√ÉO ACEITAR',
                'texto_botao_recusar': '‚ùå BOT√ÉO RECUSAR',
                'texto_recusar_subtitulo': 'üìù SUBT√çTULO RECUSAR'
            };
            
            doc.querySelectorAll('[data-field]').forEach(el => {
                const field = el.getAttribute('data-field');
                if (labels[field]) {
                    el.setAttribute('data-edit-label', labels[field]);
                }
            });
        }
        
        // Salvar todos os atributos editados
        function salvarAtributosEditados(doc) {
            savedAttributes = {};
            
            doc.querySelectorAll('[data-field]').forEach(el => {
                const field = el.getAttribute('data-field');
                const editType = el.getAttribute('data-editable');
                
                if (editType === 'text' || editType === 'button-text') {
                    savedAttributes[field] = {
                        type: 'text',
                        value: el.textContent.trim(),
                        edited: el.hasAttribute('data-user-edited')
                    };
                } else if (editType === 'media') {
                    // Verificar se √© um card de ebook (tem .ebook-cover)
                    const ebookCover = el.querySelector('.ebook-cover');
                    if (ebookCover && ebookCover.style.backgroundImage) {
                        // Extrair URL do background-image
                        const bgImage = ebookCover.style.backgroundImage;
                        const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
                        if (urlMatch && urlMatch[1]) {
                            savedAttributes[field] = {
                                type: 'media',
                                value: urlMatch[1], // Salvar apenas a URL
                                edited: true
                            };
                        } else {
                            savedAttributes[field] = {
                                type: 'media',
                                value: el.innerHTML,
                                edited: el.innerHTML !== ''
                            };
                        }
                    } else {
                        // Verificar se √© um card de resultado (tem .result-image)
                        const resultImage = el.querySelector('.result-image');
                        if (resultImage && resultImage.src) {
                            // Salvar URL da imagem
                            savedAttributes[field] = {
                                type: 'media',
                                value: resultImage.src, // Salvar apenas a URL
                                edited: true
                            };
                        } else {
                            // Verificar se √© um avatar de depoimento social (tem .social-testimonial-avatar)
                            const socialAvatar = el.querySelector('.social-testimonial-avatar') || 
                                              (el.classList.contains('social-testimonial-avatar') ? el : null);
                            if (socialAvatar && socialAvatar.src) {
                                savedAttributes[field] = {
                                    type: 'media',
                                    value: socialAvatar.src, // Salvar apenas a URL
                                    edited: true
                                };
                            } else {
                                // Verificar se √© um card de benef√≠cio (tem .benefit-image)
                                const benefitImage = el.querySelector('.benefit-image');
                                if (benefitImage && benefitImage.src) {
                                    savedAttributes[field] = {
                                        type: 'media',
                                        value: benefitImage.src,
                                        edited: true
                                    };
                                } else {
                                    // Verificar se √© um item da galeria (tem .gallery-image)
                                    const galleryImage = el.querySelector('.gallery-image');
                                    if (galleryImage && galleryImage.src) {
                                        savedAttributes[field] = {
                                            type: 'media',
                                            value: galleryImage.src,
                                            edited: true
                                        };
                                    } else {
                                        // Verificar se √© uma imagem da se√ß√£o Inside (tem .inside-image)
                                        const insideImage = el.querySelector('.inside-image');
                                        if (insideImage && insideImage.src) {
                                            savedAttributes[field] = {
                                                type: 'media',
                                                value: insideImage.src,
                                                edited: true
                                            };
                                        } else {
                                            // Verificar se √© o background do hero (tem classe hero-section)
                                            if (el.classList.contains('hero-section') && el.style.backgroundImage) {
                                                const bgImage = el.style.backgroundImage;
                                                const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
                                                if (urlMatch && urlMatch[1]) {
                                                    savedAttributes[field] = {
                                                        type: 'media',
                                                        value: urlMatch[1],
                                                        edited: true
                                                    };
                                                } else {
                                                    savedAttributes[field] = {
                                                        type: 'media',
                                                        value: el.innerHTML,
                                                        edited: el.innerHTML !== ''
                                                    };
                                                }
                                            } else {
                                                // Verificar se √© o v√≠deo do hero (tem .hero-video-box ou √© .hero-video-container)
                                                const heroVideoBox = el.querySelector('.hero-video-box');
                                                const isHeroVideoContainer = el.classList.contains('hero-video-container');
                                                
                                                if (heroVideoBox) {
                                                    const iframe = heroVideoBox.querySelector('iframe');
                                                    if (iframe && iframe.src) {
                                                        savedAttributes[field] = {
                                                            type: 'media',
                                                            value: iframe.src,
                                                            edited: true
                                                        };
                                                    } else {
                                                        const img = heroVideoBox.querySelector('.hero-video-image');
                                                        if (img && img.src) {
                                                            savedAttributes[field] = {
                                                                type: 'media',
                                                                value: img.src,
                                                                edited: true
                                                            };
                                                        } else {
                                                            savedAttributes[field] = {
                                                                type: 'media',
                                                                value: el.innerHTML,
                                                                edited: el.innerHTML !== ''
                                                            };
                                                        }
                                                    }
                                                } else if (isHeroVideoContainer) {
                                                    // Se √© o container diretamente, procurar iframe ou imagem dentro
                                                    const iframe = el.querySelector('iframe');
                                                    if (iframe && iframe.src) {
                                                        savedAttributes[field] = {
                                                            type: 'media',
                                                            value: iframe.src,
                                                            edited: true
                                                        };
                                                    } else {
                                                        const img = el.querySelector('.hero-video-image');
                                                        if (img && img.src) {
                                                            savedAttributes[field] = {
                                                                type: 'media',
                                                                value: img.src,
                                                                edited: true
                                                            };
                                                        } else {
                                                            savedAttributes[field] = {
                                                                type: 'media',
                                                                value: el.innerHTML,
                                                                edited: el.innerHTML !== ''
                                                            };
                                                        }
                                                    }
                                                } else {
                                                    // Verificar se √© uma imagem da se√ß√£o How it Works
                                                    const howItWorksImage = el.querySelector('.how-it-works-image');
                                                    if (howItWorksImage && howItWorksImage.src) {
                                                        savedAttributes[field] = {
                                                            type: 'media',
                                                            value: howItWorksImage.src,
                                                            edited: true
                                                        };
                                                    } else {
                                                        // Verificar se √© uma imagem de garantia
                                                        if (el.tagName === 'IMG' && el.getAttribute('data-field') === 'garantia_imagem' && el.src) {
                                                            savedAttributes[field] = {
                                                                type: 'media',
                                                                value: el.src,
                                                                edited: true
                                                            };
                                                        } else {
                                                            savedAttributes[field] = {
                                                                type: 'media',
                                                                value: el.innerHTML,
                                                                edited: el.innerHTML !== ''
                                                            };
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('üìù Atributos salvos:', savedAttributes);
        }
        
        // Atualizar contador de edi√ß√µes
        function atualizarContadorEdicoes() {
            const iframe = document.getElementById('template-iframe');
            const iframeDoc = iframe?.contentDocument || iframe?.contentWindow?.document;
            
            if (iframeDoc) {
                editCount = iframeDoc.querySelectorAll('[data-user-edited="true"]').length;
                document.getElementById('edit-count').textContent = editCount;
            }
        }

        // Fun√ß√£o para iniciar edi√ß√£o de texto (legacy - mantida para compatibilidade)
        function iniciarEdicaoTexto(element) {
            element.focus();
            element.setAttribute('data-user-edited', 'true');
            
            if (element.textContent.trim() === '' || element.textContent.includes('{{')) {
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            if (!element.hasAttribute('data-original-content')) {
                element.setAttribute('data-original-content', element.textContent);
            }
        }

        // Fun√ß√£o para iniciar upload de m√≠dia (legacy - mantida para compatibilidade)
        async function iniciarUploadMidia(element) {
            await iniciarUploadMidiaIframe(element);
        }

        // Fun√ß√£o para preview do template (legacy - redireciona para fullscreen)
        function previewTemplate() {
            previewFullscreen();
        }

        // Fun√ß√£o para carregar produtos do vendedor
        async function carregarProdutosVendedor() {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('adminToken');
                const response = await fetch(`${window.API_BASE || '/api'}/upsell/produtos`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar produtos');
                }

                const data = await response.json();
                
                if (data.success && data.produtos) {
                    produtosDisponiveis = data.produtos;
                    produtosFiltrados = []; // Inicializar filtrados vazio para mostrar todos
                    renderizarProdutos();
                    
                    // Se houver produto pr√©-selecionado da URL, selecionar automaticamente
                    if (window.produtoIdFromUrl) {
                        setTimeout(() => {
                            selecionarProduto(window.produtoIdFromUrl);
                            scrollParaProduto(window.produtoIdFromUrl);
                        }, 500);
                    }
                } else {
                    mostrarErroProdutos('Nenhum produto encontrado');
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                mostrarErroProdutos('Erro ao carregar produtos: ' + error.message);
            }
        }

        // Fun√ß√£o para filtrar produtos
        function filtrarProdutos(termoBusca) {
            const termo = termoBusca.toLowerCase().trim();
            
            if (!termo) {
                produtosFiltrados = produtosDisponiveis;
            } else {
                produtosFiltrados = produtosDisponiveis.filter(produto => 
                    produto.nome.toLowerCase().includes(termo) ||
                    (produto.custom_id && produto.custom_id.toLowerCase().includes(termo))
                );
            }
            
            renderizarProdutos();
            
            // Se houver apenas um resultado, selecionar automaticamente
            if (produtosFiltrados.length === 1 && termo) {
                const produtoUnico = produtosFiltrados[0];
                if (!produtosSelecionados.includes(produtoUnico.id)) {
                    selecionarProduto(produtoUnico.id);
                    // Scroll para o produto selecionado
                    setTimeout(() => {
                        scrollParaProduto(produtoUnico.id);
                    }, 100);
                }
            }
        }

        // Fun√ß√£o para scroll at√© um produto espec√≠fico
        function scrollParaProduto(produtoId) {
            const container = document.getElementById('produtos-container');
            const produtoCard = container.querySelector(`[data-produto-id="${produtoId}"]`);
            
            if (produtoCard) {
                produtoCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        // Fun√ß√£o para renderizar produtos
        function renderizarProdutos() {
            const container = document.getElementById('produtos-container');
            
            // Usar produtos filtrados se houver busca, sen√£o usar todos
            const produtosParaRenderizar = produtosFiltrados.length > 0 || document.getElementById('produto-search')?.value.trim() 
                ? produtosFiltrados 
                : produtosDisponiveis;
            
            if (produtosParaRenderizar.length === 0) {
                container.innerHTML = `
                    <div class="produto-card-empty">
                        <i class="fas fa-search"></i>
                        <div style="font-weight: 600; margin-bottom: 5px;">Nenhum produto encontrado</div>
                        <div style="font-size: 0.9rem;">Tente buscar com outro termo</div>
                    </div>
                `;
                atualizarIndicadoresScroll();
                return;
            }

            if (produtosDisponiveis.length === 0) {
                container.innerHTML = `
                    <div class="produto-card-empty">
                        <i class="fas fa-box-open"></i>
                        <div style="font-weight: 600; margin-bottom: 5px;">Nenhum produto dispon√≠vel</div>
                        <div style="font-size: 0.9rem;">Crie produtos primeiro para poder oferec√™-los no upsell</div>
                    </div>
                `;
                atualizarIndicadoresScroll();
                return;
            }

            container.innerHTML = produtosParaRenderizar.map(produto => {
                const isSelected = produtosSelecionados.includes(produto.id);
                const precoFormatado = produto.preco 
                    ? parseFloat(produto.preco).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'})
                    : 'Pre√ßo n√£o definido';
                
                return `
                    <div class="produto-card ${isSelected ? 'selected' : ''}" 
                         onclick="toggleProduto('${produto.id}')"
                         data-produto-id="${produto.id}">
                        ${produto.imagem_url 
                            ? `<img src="${produto.imagem_url}" alt="${produto.nome}" class="produto-card-image" onerror="this.style.display='none'">`
                            : `<div class="produto-card-image" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 2rem;"><i class="fas fa-image"></i></div>`
                        }
                        <div class="produto-card-nome">${produto.nome}</div>
                        <div class="produto-card-preco">${precoFormatado}</div>
                    </div>
                `;
            }).join('');
            
            atualizarIndicadoresScroll();
        }

        // Fun√ß√£o para atualizar indicadores de scroll
        function atualizarIndicadoresScroll() {
            const container = document.getElementById('produtos-container');
            const scrollLeft = document.getElementById('scroll-left');
            const scrollRight = document.getElementById('scroll-right');
            
            // Verificar se h√° scroll dispon√≠vel
            const hasScroll = container.scrollWidth > container.clientWidth;
            
            if (hasScroll) {
                // Verificar posi√ß√£o inicial
                atualizarVisibilidadeIndicadores();
                
                // Adicionar listeners de scroll
                container.addEventListener('scroll', atualizarVisibilidadeIndicadores);
            } else {
                scrollLeft.style.display = 'none';
                scrollRight.style.display = 'none';
            }
        }

        // Fun√ß√£o para atualizar visibilidade dos indicadores
        function atualizarVisibilidadeIndicadores() {
            const container = document.getElementById('produtos-container');
            const scrollLeft = document.getElementById('scroll-left');
            const scrollRight = document.getElementById('scroll-right');
            
            const isAtStart = container.scrollLeft <= 10;
            const isAtEnd = container.scrollLeft >= container.scrollWidth - container.clientWidth - 10;
            
            scrollLeft.style.display = isAtStart ? 'none' : 'flex';
            scrollRight.style.display = isAtEnd ? 'none' : 'flex';
        }

        // Fun√ß√£o para scroll program√°tico
        function scrollProdutos(direction) {
            const container = document.getElementById('produtos-container');
            const scrollAmount = 300;
            const scrollTo = direction === 'left' 
                ? container.scrollLeft - scrollAmount
                : container.scrollLeft + scrollAmount;
            
            container.scrollTo({
                left: scrollTo,
                behavior: 'smooth'
            });
        }

        // Fun√ß√£o para selecionar/deselecionar produto
        function toggleProduto(produtoId) {
            const index = produtosSelecionados.indexOf(produtoId);
            
            if (index > -1) {
                // Deselecionar
                produtosSelecionados.splice(index, 1);
            } else {
                // Selecionar
                produtosSelecionados.push(produtoId);
            }
            
            renderizarProdutos();
            atualizarTemplateComProdutos();
        }

        // Fun√ß√£o para atualizar template com produtos selecionados
        function atualizarTemplateComProdutos() {
            if (!currentTemplateId) {
                return;
            }
            
            const iframe = document.getElementById('template-iframe');
            const iframeDoc = iframe?.contentDocument || iframe?.contentWindow?.document;
            
            if (!iframeDoc) return;
            
            const produtos = produtosDisponiveis.filter(p => produtosSelecionados.includes(p.id));
            const primeiroProduto = produtos.length > 0 ? produtos[0] : null;
            
            if (!primeiroProduto) return;
            
            // Atualizar pre√ßos no template (dentro do iframe)
            const precoProduto = parseFloat(primeiroProduto.preco) || 0;
            const precoFormatado = precoProduto.toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'});
            const precoOriginal = (precoProduto * 1.5).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'});
            
            // Atualizar elementos de pre√ßo no iframe
            const precoOfertaEl = iframeDoc.querySelector('[data-field="preco_oferta"]');
            const precoOriginalEl = iframeDoc.querySelector('[data-field="preco_original"]');
            const perguntaProdutoEl = iframeDoc.querySelector('[data-field="texto_pergunta_produto"]');
            
            if (precoOfertaEl && !precoOfertaEl.hasAttribute('data-user-edited')) {
                precoOfertaEl.textContent = precoFormatado;
            }
            if (precoOriginalEl && !precoOriginalEl.hasAttribute('data-user-edited')) {
                precoOriginalEl.textContent = precoOriginal;
            }
            if (perguntaProdutoEl && !perguntaProdutoEl.hasAttribute('data-user-edited')) {
                perguntaProdutoEl.textContent = `Adicionar "${primeiroProduto.nome}" ao pedido?`;
            }
            
            // Atualizar template content oculto
            atualizarTemplateContent();
        }
        
        // ===============================================
        // FUN√á√ïES DE ORDER BUMPS (PRODUTOS COMPLEMENTARES)
        // ===============================================
        
        // Abrir modal de order bumps
        function abrirModalOrderBumps() {
            try {
                console.log('üîç Abrindo modal de order bumps...');
                
                if (orderBumpsSelecionados.length >= 3) {
                    mostrarToast('Voc√™ pode adicionar no m√°ximo 3 produtos order bumps', 'error');
                    return;
                }
                
                const modal = document.getElementById('order-bump-modal');
                if (!modal) {
                    console.error('‚ùå Modal de order bumps n√£o encontrado!');
                    mostrarToast('Erro: Modal n√£o encontrado', 'error');
                    return;
                }
                
                // Garantir que o modal seja vis√≠vel
                // Remover qualquer estilo inline que possa estar bloqueando
                modal.removeAttribute('style');
                
                // Aplicar estilos necess√°rios para visibilidade
                modal.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    background: rgba(0, 0, 0, 0.8) !important;
                    backdrop-filter: blur(8px) !important;
                    z-index: 999999 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                `;
                
                modal.classList.add('active');
                console.log('‚úÖ Modal exibido');
                
                // Verificar se realmente est√° vis√≠vel ap√≥s um pequeno delay
                setTimeout(() => {
                    const rect = modal.getBoundingClientRect();
                    console.log('üîç Modal posi√ß√£o:', {
                        top: rect.top,
                        left: rect.left,
                        width: rect.width,
                        height: rect.height,
                        visible: rect.width > 0 && rect.height > 0
                    });
                }, 100);
                
                // For√ßar repaint
                void modal.offsetHeight;
                
                // Verificar se produtos est√£o dispon√≠veis
                if (!produtosDisponiveis || produtosDisponiveis.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum produto dispon√≠vel ainda. Aguardando...');
                    mostrarToast('Carregando produtos...', 'info');
                    // Tentar carregar produtos se ainda n√£o foram carregados
                    if (typeof carregarProdutosVendedor === 'function') {
                        carregarProdutosVendedor().then(() => {
                            renderizarProdutosOrderBumps();
                        });
                    }
                    return;
                }
                
                renderizarProdutosOrderBumps();
                atualizarContadorOrderBumps();
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal de order bumps:', error);
                mostrarToast('Erro ao abrir modal: ' + error.message, 'error');
            }
        }
        
        // Disponibilizar fun√ß√£o globalmente
        window.abrirModalOrderBumps = abrirModalOrderBumps;
        window.fecharModalOrderBumps = fecharModalOrderBumps;
        
        // Fechar modal de order bumps
        function fecharModalOrderBumps() {
            try {
                const modal = document.getElementById('order-bump-modal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('active');
                    document.body.style.overflow = ''; // Restaurar scroll do body
                }
            } catch (error) {
                console.error('‚ùå Erro ao fechar modal:', error);
            }
        }
        
        // Renderizar produtos dispon√≠veis para order bumps
        function renderizarProdutosOrderBumps() {
            try {
                const container = document.getElementById('order-bump-products-list');
                if (!container) {
                    console.error('‚ùå Container de produtos order bumps n√£o encontrado!');
                    return;
                }
                
                if (!produtosDisponiveis || produtosDisponiveis.length === 0) {
                    container.innerHTML = `
                        <div class="produto-card-empty" style="grid-column: 1 / -1;">
                            <i class="fas fa-spinner fa-spin"></i>
                            <div style="font-weight: 600; margin-bottom: 5px;">Carregando produtos...</div>
                            <div style="font-size: 0.9rem;">Aguarde enquanto carregamos os produtos dispon√≠veis</div>
                        </div>
                    `;
                    return;
                }
                
                const produtosJaAdicionados = orderBumpsSelecionados.map(ob => ob.id);
                
                // Filtrar produtos que j√° n√£o est√£o selecionados como produtos principais
                const produtosDisponiveisParaOrderBump = produtosDisponiveis.filter(p => 
                    !produtosSelecionados.includes(p.id) && 
                    !produtosJaAdicionados.includes(p.id)
                );
                
                if (produtosDisponiveisParaOrderBump.length === 0) {
                    container.innerHTML = `
                        <div class="produto-card-empty" style="grid-column: 1 / -1;">
                            <i class="fas fa-box-open"></i>
                            <div style="font-weight: 600; margin-bottom: 5px;">Nenhum produto dispon√≠vel</div>
                            <div style="font-size: 0.9rem;">Todos os produtos j√° foram selecionados</div>
                        </div>
                    `;
                    return;
                }
            
            // Atualizar contador
            const countText = document.getElementById('order-bump-count-text');
            if (countText) {
                countText.textContent = `${produtosDisponiveisParaOrderBump.length} produto${produtosDisponiveisParaOrderBump.length !== 1 ? 's' : ''}`;
            }
            
            container.innerHTML = produtosDisponiveisParaOrderBump.map(produto => {
                const precoFormatado = produto.preco 
                    ? parseFloat(produto.preco).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'})
                    : 'Pre√ßo n√£o definido';
                
                const descricao = produto.descricao 
                    ? (produto.descricao.length > 80 ? produto.descricao.substring(0, 80) + '...' : produto.descricao)
                    : 'Sem descri√ß√£o';
                
                return `
                    <div class="produto-card" onclick="adicionarOrderBump('${produto.id}')" style="cursor: pointer; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(102, 126, 234, 0.9); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; z-index: 2; opacity: 0; transition: opacity 0.3s ease;" class="produto-card-badge">
                            <i class="fas fa-plus"></i> Adicionar
                        </div>
                        ${produto.imagem_url 
                            ? `<img src="${produto.imagem_url}" alt="${produto.nome}" class="produto-card-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                            : ''
                        }
                        ${!produto.imagem_url 
                            ? `<div class="produto-card-image" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 2rem;"><i class="fas fa-image"></i></div>`
                            : ''
                        }
                        <div style="padding: 12px;">
                            <div class="produto-card-nome" title="${produto.nome}">${produto.nome}</div>
                            ${produto.descricao ? `<div style="font-size: 0.8rem; color: #64748b; margin-top: 6px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;" title="${produto.descricao}">${descricao}</div>` : ''}
                            <div class="produto-card-preco" style="margin-top: 10px;">${precoFormatado}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Adicionar hover effect para mostrar badge
            container.querySelectorAll('.produto-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const badge = this.querySelector('.produto-card-badge');
                    if (badge) badge.style.opacity = '1';
                });
                card.addEventListener('mouseleave', function() {
                    const badge = this.querySelector('.produto-card-badge');
                    if (badge) badge.style.opacity = '0';
                });
            });
            } catch (error) {
                console.error('‚ùå Erro ao renderizar produtos order bumps:', error);
                const container = document.getElementById('order-bump-products-list');
                if (container) {
                    container.innerHTML = `
                        <div class="produto-card-empty" style="grid-column: 1 / -1;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                            <div style="font-weight: 600; margin-bottom: 5px; color: var(--danger-color);">Erro ao carregar produtos</div>
                            <div style="font-size: 0.9rem;">${error.message || 'Erro desconhecido'}</div>
                        </div>
                    `;
                }
            }
        }
        
        // Filtrar produtos para order bumps
        function filtrarOrderBumps(termoBusca) {
            const termo = termoBusca.toLowerCase().trim();
            const container = document.getElementById('order-bump-products-list');
            const produtosJaAdicionados = orderBumpsSelecionados.map(ob => ob.id);
            
            let produtosFiltrados = produtosDisponiveis.filter(p => 
                !produtosSelecionados.includes(p.id) && 
                !produtosJaAdicionados.includes(p.id)
            );
            
            if (termo) {
                produtosFiltrados = produtosFiltrados.filter(produto => 
                    produto.nome.toLowerCase().includes(termo) ||
                    (produto.custom_id && produto.custom_id.toLowerCase().includes(termo)) ||
                    (produto.descricao && produto.descricao.toLowerCase().includes(termo))
                );
            }
            
            // Atualizar contador
            const countText = document.getElementById('order-bump-count-text');
            if (countText) {
                countText.textContent = `${produtosFiltrados.length} produto${produtosFiltrados.length !== 1 ? 's' : ''} encontrado${produtosFiltrados.length !== 1 ? 's' : ''}`;
            }
            
            if (produtosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="produto-card-empty" style="grid-column: 1 / -1; padding: 60px 20px;">
                        <i class="fas fa-search" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 1.1rem; color: var(--dark-bg);">Nenhum produto encontrado</div>
                        <div style="font-size: 0.95rem; color: #64748b;">Tente buscar com outro termo ou verifique se h√° produtos dispon√≠veis</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = produtosFiltrados.map(produto => {
                const precoFormatado = produto.preco 
                    ? parseFloat(produto.preco).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'})
                    : 'Pre√ßo n√£o definido';
                
                const descricao = produto.descricao 
                    ? (produto.descricao.length > 80 ? produto.descricao.substring(0, 80) + '...' : produto.descricao)
                    : 'Sem descri√ß√£o';
                
                return `
                    <div class="produto-card" onclick="adicionarOrderBump('${produto.id}')" style="cursor: pointer; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(102, 126, 234, 0.9); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; z-index: 2; opacity: 0; transition: opacity 0.3s ease;" class="produto-card-badge">
                            <i class="fas fa-plus"></i> Adicionar
                        </div>
                        ${produto.imagem_url 
                            ? `<img src="${produto.imagem_url}" alt="${produto.nome}" class="produto-card-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                            : ''
                        }
                        ${!produto.imagem_url 
                            ? `<div class="produto-card-image" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 2rem;"><i class="fas fa-image"></i></div>`
                            : ''
                        }
                        <div style="padding: 12px;">
                            <div class="produto-card-nome" title="${produto.nome}">${produto.nome}</div>
                            ${produto.descricao ? `<div style="font-size: 0.8rem; color: #64748b; margin-top: 6px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;" title="${produto.descricao}">${descricao}</div>` : ''}
                            <div class="produto-card-preco" style="margin-top: 10px;">${precoFormatado}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Adicionar hover effect para mostrar badge
            container.querySelectorAll('.produto-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const badge = this.querySelector('.produto-card-badge');
                    if (badge) badge.style.opacity = '1';
                });
                card.addEventListener('mouseleave', function() {
                    const badge = this.querySelector('.produto-card-badge');
                    if (badge) badge.style.opacity = '0';
                });
            });
        }
        
        // Adicionar produto como order bump
        function adicionarOrderBump(produtoId) {
            try {
                console.log('‚ûï Adicionando order bump:', produtoId);
                
                if (orderBumpsSelecionados.length >= 3) {
                    mostrarToast('Voc√™ pode adicionar no m√°ximo 3 produtos order bumps', 'error');
                    return;
                }
                
                if (!produtosDisponiveis || produtosDisponiveis.length === 0) {
                    mostrarToast('Produtos ainda n√£o foram carregados. Aguarde...', 'error');
                    return;
                }
                
                const produto = produtosDisponiveis.find(p => p.id === produtoId || p.id === String(produtoId));
                if (!produto) {
                    console.error('‚ùå Produto n√£o encontrado:', produtoId);
                    mostrarToast('Produto n√£o encontrado', 'error');
                    return;
                }
                
                // Verificar se j√° foi adicionado
                if (orderBumpsSelecionados.find(ob => ob.id === produtoId || ob.id === String(produtoId))) {
                    mostrarToast('Este produto j√° foi adicionado como order bump', 'error');
                    return;
                }
                
                // Adicionar √† lista
                orderBumpsSelecionados.push({
                    id: produto.id,
                    nome: produto.nome,
                    preco: produto.preco,
                    imagem_url: produto.imagem_url,
                    descricao: produto.descricao,
                    custom_id: produto.custom_id,
                    public_id: produto.public_id
                });
                
                console.log('‚úÖ Order bump adicionado:', produto.nome);
                console.log('üì¶ Total de order bumps:', orderBumpsSelecionados.length);
                
                renderizarOrderBumps();
                atualizarContadorOrderBumps();
                fecharModalOrderBumps();
                atualizarTemplateComOrderBumps();
                mostrarToast(`Order bump "${produto.nome}" adicionado com sucesso!`, 'success');
            } catch (error) {
                console.error('‚ùå Erro ao adicionar order bump:', error);
                mostrarToast('Erro ao adicionar order bump: ' + error.message, 'error');
            }
        }
        
        // Disponibilizar fun√ß√£o globalmente
        window.adicionarOrderBump = adicionarOrderBump;
        window.removerOrderBump = removerOrderBump;
        
        // Remover order bump
        function removerOrderBump(produtoId) {
            const orderBump = orderBumpsSelecionados.find(ob => ob.id === produtoId);
            orderBumpsSelecionados = orderBumpsSelecionados.filter(ob => ob.id !== produtoId);
            renderizarOrderBumps();
            atualizarContadorOrderBumps();
            atualizarTemplateComOrderBumps();
            mostrarToast(`Order bump "${orderBump?.nome || 'produto'}" removido`, 'success');
        }
        
        // Atualizar contador de order bumps selecionados
        function atualizarContadorOrderBumps() {
            const countEl = document.getElementById('order-bump-selected-count');
            if (countEl) {
                countEl.textContent = `${orderBumpsSelecionados.length}/3 selecionados`;
            }
        }
        
        // Renderizar lista de order bumps adicionados
        function renderizarOrderBumps() {
            const container = document.getElementById('order-bumps-list');
            const addBtn = document.getElementById('add-order-bump-btn');
            
            // Remover mensagem de limite m√°ximo se existir
            const maxMsg = container.previousElementSibling;
            if (maxMsg && maxMsg.classList.contains('order-bump-max-msg')) {
                maxMsg.remove();
            }
            
            if (orderBumpsSelecionados.length === 0) {
                container.innerHTML = `
                    <div class="order-bumps-empty">
                        <i class="fas fa-gift"></i>
                        <div style="font-weight: 600; margin-bottom: 5px;">Nenhum order bump adicionado</div>
                        <div style="font-size: 0.9rem;">Clique em "Adicionar Order Bump" para adicionar produtos complementares</div>
                    </div>
                `;
                addBtn.disabled = false;
                return;
            }
            
            if (orderBumpsSelecionados.length >= 3) {
                addBtn.disabled = true;
                container.insertAdjacentHTML('beforebegin', `
                    <div class="order-bump-max-msg">
                        <i class="fas fa-info-circle"></i>
                        Voc√™ atingiu o limite m√°ximo de 3 order bumps
                    </div>
                `);
            } else {
                addBtn.disabled = false;
            }
            
            container.innerHTML = orderBumpsSelecionados.map((orderBump, index) => {
                const precoFormatado = orderBump.preco 
                    ? parseFloat(orderBump.preco).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'})
                    : 'Pre√ßo n√£o definido';
                
                const descricao = orderBump.descricao 
                    ? (orderBump.descricao.length > 100 ? orderBump.descricao.substring(0, 100) + '...' : orderBump.descricao)
                    : 'Sem descri√ß√£o dispon√≠vel';
                
                return `
                    <div class="order-bump-item" style="animation: fadeInUp 0.4s ease ${index * 0.1}s both;">
                        ${orderBump.imagem_url 
                            ? `<img src="${orderBump.imagem_url}" alt="${orderBump.nome}" class="order-bump-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                            : ''
                        }
                        ${!orderBump.imagem_url 
                            ? `<div class="order-bump-image" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 2rem;"><i class="fas fa-image"></i></div>`
                            : ''
                        }
                        <div class="order-bump-info">
                            <div class="order-bump-title" title="${orderBump.nome}">${orderBump.nome}</div>
                            ${orderBump.descricao ? `<div class="order-bump-description" title="${orderBump.descricao}">${descricao}</div>` : ''}
                            <div class="order-bump-price">${precoFormatado}</div>
                        </div>
                        <button class="order-bump-remove" onclick="removerOrderBump('${orderBump.id}')" title="Remover order bump">
                            <i class="fas fa-trash"></i>
                            <span>Remover</span>
                        </button>
                    </div>
                `;
            }).join('');
            
            // Adicionar anima√ß√£o CSS se n√£o existir
            if (!document.getElementById('order-bump-animations')) {
                const style = document.createElement('style');
                style.id = 'order-bump-animations';
                style.textContent = `
                    @keyframes fadeInUp {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Atualizar template com order bumps
        function atualizarTemplateComOrderBumps() {
            if (!currentTemplateId) {
                return;
            }
            
            const iframe = document.getElementById('template-iframe');
            const iframeDoc = iframe?.contentDocument || iframe?.contentWindow?.document;
            
            if (!iframeDoc) return;
            
            // Remover order bumps anteriores se n√£o houver mais nenhum
            if (orderBumpsSelecionados.length === 0) {
                const existingContainer = iframeDoc.getElementById('order-bumps-container');
                if (existingContainer) {
                    existingContainer.remove();
                }
                return;
            }
            
            // Encontrar ou criar container de order bumps no template
            let orderBumpsContainer = iframeDoc.getElementById('order-bumps-container');
            
            if (!orderBumpsContainer) {
                // Criar container se n√£o existir - inserir antes do bot√£o de pagamento
                const ctaPrimary = iframeDoc.querySelector('.cta-primary');
                if (ctaPrimary) {
                    orderBumpsContainer = iframeDoc.createElement('div');
                    orderBumpsContainer.id = 'order-bumps-container';
                    orderBumpsContainer.className = 'order-bumps-section';
                    orderBumpsContainer.style.cssText = 'margin: 40px 0; padding: 30px; background: #f8f9fa; border-radius: 12px; border: 2px solid #e9ecef;';
                    ctaPrimary.insertAdjacentElement('beforebegin', orderBumpsContainer);
                } else {
                    return; // N√£o encontrou onde inserir
                }
            }
            
            // Renderizar order bumps no template
            orderBumpsContainer.innerHTML = `
                <h3 style="text-align: center; color: #F64C00; font-size: 1.5rem; margin-bottom: 20px; font-weight: 700;">
                    <i class="fas fa-gift"></i> Leva mais uma oferta extra
                </h3>
                <div style="display: grid; gap: 15px;">
                    ${orderBumpsSelecionados.map(orderBump => {
                        const precoFormatado = orderBump.preco 
                            ? parseFloat(orderBump.preco).toLocaleString('pt-BR', {style: 'currency', currency: 'MZN'})
                            : 'Pre√ßo n√£o definido';
                        
                        return `
                            <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 15px;">
                                ${orderBump.imagem_url 
                                    ? `<img src="${orderBump.imagem_url}" alt="${orderBump.nome}" style="width: 80px; height: 80px; min-width: 80px; border-radius: 8px; object-fit: cover; background: #f1f5f9; border: 1px solid #e2e8f0;" onerror="this.style.display='none'">`
                                    : `<div style="width: 80px; height: 80px; min-width: 80px; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;"><i class="fas fa-image"></i></div>`
                                }
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 5px; font-size: 1rem;">${orderBump.nome}</div>
                                    <div style="color: #28a745; font-weight: 700; font-size: 1.1rem;">${precoFormatado}</div>
                                </div>
                                <button style="background: #28a745; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                    Adicionar
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Fun√ß√£o para selecionar produto programaticamente
        function selecionarProduto(produtoId) {
            if (!produtosSelecionados.includes(produtoId)) {
                produtosSelecionados.push(produtoId);
                renderizarProdutos();
                atualizarTemplateComProdutos(); // Atualizar template com produtos selecionados
                // Scroll para o produto selecionado
                setTimeout(() => {
                    scrollParaProduto(produtoId);
                }, 100);
            }
        }

        // Fun√ß√£o para mostrar erro ao carregar produtos
        function mostrarErroProdutos(mensagem) {
            const container = document.getElementById('produtos-container');
            container.innerHTML = `
                <div class="produto-card-empty">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                    <div style="font-weight: 600; margin-bottom: 5px; color: var(--danger-color);">Erro ao carregar produtos</div>
                    <div style="font-size: 0.9rem;">${mensagem}</div>
                </div>
            `;
        }

        // Fun√ß√µes antigas removidas - n√£o s√£o mais necess√°rias com o editor inline

        async function carregarPagina(id) {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('adminToken');
                const response = await fetch(`${window.API_BASE || '/api'}/upsell/pages/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar p√°gina');
                }

                const data = await response.json();
                const page = data.page;
                
                // Preencher campos b√°sicos
                if (page.slug) {
                    document.getElementById('page-slug').value = page.slug;
                    formatarSlug(document.getElementById('page-slug'));
                }
                
                if (page.nome || page.titulo) {
                    document.getElementById('page-name').value = page.nome || page.titulo || '';
                }

                // Selecionar template se existir
                if (page.template_id) {
                    const templateSelect = document.getElementById('template-select');
                    templateSelect.value = page.template_id;
                    
                    // Se houver HTML salvo, carregar diretamente no iframe
                    if (page.template_html) {
                        currentTemplateId = page.template_id;
                        
                        // Sanitizar o HTML para remover scripts que podem causar conflitos
                        let templateHtml = sanitizarTemplateParaEdicao(page.template_html);
                        
                        // Carregar no iframe
                        const iframe = document.getElementById('template-iframe');
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        iframeDoc.open();
                        iframeDoc.write(templateHtml);
                        iframeDoc.close();
                        
                        // Mostrar se√ß√£o de editor
                        document.getElementById('template-editor-section').style.display = 'block';
                        
                    // Inicializar editor
                    setTimeout(() => {
                        inicializarEditorIframe();
                        // Atualizar template com order bumps se existirem
                        if (orderBumpsSelecionados.length > 0) {
                            atualizarTemplateComOrderBumps();
                        }
                    }, 500);
                    } else {
                        // Carregar template padr√£o para edi√ß√£o
                        await carregarTemplateParaEdicao(page.template_id);
                    }
                }
                
                // Carregar order bumps se existirem
                if (page.order_bumps && Array.isArray(page.order_bumps) && page.order_bumps.length > 0) {
                    orderBumpsSelecionados = page.order_bumps.map(ob => ({
                        id: ob.produto_id || ob.id,
                        nome: ob.nome,
                        preco: ob.preco,
                        imagem_url: ob.imagem_url,
                        descricao: ob.descricao,
                        custom_id: ob.custom_id,
                        public_id: ob.public_id
                    }));
                    renderizarOrderBumps();
                    // Atualizar template com order bumps ap√≥s carregar
                    setTimeout(() => {
                        atualizarTemplateComOrderBumps();
                    }, 1000);
                }
                
                // Aguardar produtos carregarem antes de selecionar
                if (produtosDisponiveis.length > 0) {
                    // Carregar produtos relacionados se existirem
                    if (page.produtos_relacionados && page.produtos_relacionados.length > 0) {
                        produtosSelecionados = page.produtos_relacionados.map(p => p.produto_id || p.id);
                        renderizarProdutos();
                    }
                } else {
                    // Se produtos ainda n√£o carregaram, aguardar
                    const checkInterval = setInterval(() => {
                        if (produtosDisponiveis.length > 0) {
                            clearInterval(checkInterval);
                            if (page.produtos_relacionados && page.produtos_relacionados.length > 0) {
                                produtosSelecionados = page.produtos_relacionados.map(p => p.produto_id || p.id);
                                renderizarProdutos();
                            }
                        }
                    }, 500);
                    
                    // Timeout ap√≥s 10 segundos
                    setTimeout(() => clearInterval(checkInterval), 10000);
                }

                // V√≠deo/m√≠dia agora √© editado diretamente no template, n√£o precisa carregar aqui
            } catch (error) {
                console.error('Erro ao carregar p√°gina:', error);
                mostrarToast('Erro ao carregar p√°gina: ' + error.message, 'error');
            }
        }

        async function salvarPagina() {
            // Valida√ß√µes
            const slug = document.getElementById('page-slug').value.trim();
            const nomePagina = document.getElementById('page-name').value.trim();
            const templateId = document.getElementById('template-select').value;
            
            if (!slug) {
                mostrarToast('Preencha o ID de refer√™ncia (slug) da p√°gina', 'error');
                document.getElementById('page-slug').focus();
                return;
            }
            
            if (!nomePagina) {
                mostrarToast('Preencha o nome da p√°gina', 'error');
                document.getElementById('page-name').focus();
                return;
            }
            
            if (!templateId) {
                mostrarToast('Selecione um template para a p√°gina', 'error');
                return;
            }

            if (produtosSelecionados.length === 0) {
                mostrarToast('Selecione pelo menos um produto para oferecer no upsell', 'error');
                return;
            }

            const saveBtn = document.getElementById('save-btn');
            const originalContent = saveBtn.innerHTML;

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="loading-spinner"></span> Salvando...';

                const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('adminToken');
                
                // Obter HTML completo do template modificado do iframe
                const iframe = document.getElementById('template-iframe');
                const iframeDoc = iframe?.contentDocument || iframe?.contentWindow?.document;
                let templateHtml = null;
                
                if (iframeDoc && iframeDoc.documentElement) {
                    // Remover estilos de edi√ß√£o antes de salvar
                    const editStyles = iframeDoc.getElementById('edit-mode-styles');
                    if (editStyles) editStyles.remove();
                    
                    const dynamicStyles = iframeDoc.getElementById('dynamic-edit-styles');
                    if (dynamicStyles) dynamicStyles.remove();
                    
                    // Remover classe de modo edi√ß√£o
                    iframeDoc.body?.classList.remove('edit-mode-active');
                    
                    // Desabilitar contenteditable em todos elementos
                    iframeDoc.querySelectorAll('[contenteditable]').forEach(el => {
                        el.removeAttribute('contenteditable');
                    });
                    
                    // Remover atributos tempor√°rios de edi√ß√£o
                    iframeDoc.querySelectorAll('[data-edit-label]').forEach(el => {
                        el.removeAttribute('data-edit-label');
                    });
                    
                    // Salvar atributos editados
                    salvarAtributosEditados(iframeDoc);
                    
                    templateHtml = '<!DOCTYPE html>' + iframeDoc.documentElement.outerHTML;
                }
                
                // Extrair t√≠tulo do template (primeiro h1 ou t√≠tulo principal)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = templateHtml || '';
                const tituloElement = tempDiv.querySelector('[data-field="titulo_principal"]') || tempDiv.querySelector('h1');
                const titulo = tituloElement ? tituloElement.textContent.trim() : nomePagina;
                
                const payload = {
                    titulo: titulo || nomePagina || 'Oferta Especial',
                    nome: nomePagina,
                    slug: slug,
                    nome_produto: produtosDisponiveis.find(p => p.id === produtosSelecionados[0])?.nome || '',
                    template_id: templateId,
                    order_bumps: orderBumpsSelecionados.map(ob => ({
                        produto_id: ob.id,
                        nome: ob.nome,
                        preco: ob.preco,
                        imagem_url: ob.imagem_url,
                        descricao: ob.descricao
                    })),
                    template_html: templateHtml, // HTML completo do template modificado
                    atributos: savedAttributes // Todos os atributos editados
                };
                
                console.log('üì§ Salvando p√°gina com payload:', {
                    slug: payload.slug,
                    nome: payload.nome,
                    template_id: payload.template_id,
                    atributos: Object.keys(payload.atributos || {}),
                    produtos: produtosSelecionados.length
                });

                // Primeiro, criar/atualizar a p√°gina
                let savedPageId = pageId;

                const url = isEditing 
                    ? `${window.API_BASE || '/api'}/upsell/pages/${pageId}`
                    : `${window.API_BASE || '/api'}/upsell/pages`;
                
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                    throw new Error(errorData.error || 'Erro ao salvar p√°gina');
                }

                const data = await response.json();

                if (data.success) {
                    savedPageId = data.page?.id || pageId;
                    
                    if (!savedPageId) {
                        throw new Error('ID da p√°gina n√£o retornado');
                    }
                    
                    // Relacionar produtos √† p√°gina (CR√çTICO - deve ser salvo no banco)
                    if (produtosSelecionados.length > 0) {
                        try {
                            console.log('üîó Salvando produtos no banco de dados:', {
                                pageId: savedPageId,
                                produtos: produtosSelecionados,
                                quantidade: produtosSelecionados.length
                            });
                            
                            const relacionarResponse = await fetch(`${window.API_BASE || '/api'}/upsell/pages/${savedPageId}/produtos`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    produto_ids: produtosSelecionados
                                })
                            });

                            const relacionarData = await relacionarResponse.json();
                            
                            if (!relacionarResponse.ok || !relacionarData.success) {
                                console.error('‚ùå Erro ao salvar produtos no banco:', relacionarData);
                                throw new Error(relacionarData.message || 'Erro ao salvar produtos no banco de dados');
                            } else {
                                console.log('‚úÖ Produtos salvos no banco de dados com sucesso:', relacionarData);
                                console.log(`‚úÖ Total de ${relacionarData.total_salvos || produtosSelecionados.length} produto(s) relacionado(s) e salvos`);
                            }
                        } catch (relError) {
                            console.error('‚ùå Erro ao salvar produtos no banco:', relError);
                            throw new Error('Erro ao salvar produtos: ' + relError.message);
                        }
                    }

                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
                    saveBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    
                    setTimeout(() => {
                        window.location.href = 'upsell-config.html';
                    }, 1500);

                    mostrarToast('P√°gina salva com sucesso!', 'success');
                } else {
                    throw new Error(data.message || 'Erro ao salvar p√°gina');
                }
            } catch (error) {
                console.error('Erro ao salvar p√°gina:', error);
                mostrarToast('Erro ao salvar: ' + error.message, 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
            }
        }

        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check' : 'exclamation'}-circle"></i>
                <span>${mensagem}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>


